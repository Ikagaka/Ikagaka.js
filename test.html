<script src="./node_modules/es6-shim/es6-shim.min.js"></script>
<script src="./node_modules/encoding-japanese/encoding.min.js"></script>
<script src="./node_modules/ikagaka.nar.js/vender/WMDescript.js"></script>
<script src="./node_modules/ikagaka.nar.js/vender/jszip.min.js"></script>
<script src="./node_modules/ikagaka.nar.js/vender/XHRProxy.min.js"></script>
<script src="./node_modules/surfaces_txt2yaml/lib/surfaces_txt2yaml.js"></script>
<script src="./node_modules/underscore/underscore-min.js"></script>
<script src="./node_modules/jquery/dist/jquery.min.js"></script>
<script src="./node_modules/shiorijk/lib/shiorijk.js"></script>
<script src="./dist/ikagaka.js"></script>
<p>
  nar: <input type="file" id="nar" />
</p>
<script>
$(function(){
  $("#nar").change(function(ev){
    var nar = new Ikagaka.Nar();
    nar.loadFromBlob(ev.target.files[0], loadHandler.bind(this, nar));
  });
  var nar = new Ikagaka.Nar();
  nar.loadFromURL("./node_modules/ikagaka.nar.js/vender/mobilemaster.nar", loadHandler.bind(this, nar));
});

function loadHandler(nar, err){
  if(!!err) return console.error(err.stack);
  Promise.all([
    new Promise(function(resolve, reject){
      var shell = new Ikagaka.Shell(nar.getDirectory(/shell\/master\//));
      shell.load(function(err){
        if(!!err) reject(err); else resolve(shell);
      });
    }),
    new Promise(function(resolve, reject){
      var ghost = new Ikagaka.Ghost(nar.getDirectory(/ghost\/master\//));
      ghost.path = "./node_modules/ikagaka.ghost.js/"
      ghost.load(function(err){
        if(!!err) reject(err); else resolve(ghost);
      });
    }),
    new Promise(function(resolve, reject){
      var nar = new Ikagaka.Nar();
      nar.loadFromURL("./node_modules/ikagaka.balloon.js/vender/origin.nar", function(err){
        if(!!err) return reject(err);
        var balloon = new Ikagaka.Balloon(nar.directory);
        balloon.load(function(err){
          if(!!err) reject(err); else resolve(balloon);
        });
      });
    })
  ]).then(function(tmp){
    var shell = tmp[0];
    var ghost = tmp[1];
    var balloon = tmp[2];
    var named = new Ikagaka.Named(shell, balloon);
    var ssp = new Ikagaka.SakuraScriptPlayer(named);

    ghost.logging = true

    $(named.element)
      .on("IkagakaSurfaceEvent", function(ev){ requestSender(ev.detail); })
      .appendTo("body");

    requestSender({
      ID: "OnBoot",
      Reference0: "0"
    });

    setInterval(function(){
      requestSender({
        ID: "OnSecondChange",
        Reference0: "0",
        Reference1: "0",
        Reference2: "0",
        Reference3: "1"
      });
    }, 1000);

    setInterval(function(){
      requestSender({
        ID: "OnMinuteChange",
        Reference0: "0",
        Reference1: "0",
        Reference2: "0",
        Reference3: "1"
      });
    }, 1000);

    function requestSender(ev){
      var request = new ShioriJK.Message.Request();
      request.request_line.method = "GET";
      request.request_line.protocol = "SHIORI";
      request.request_line.version = "3.0";
      request.headers.header["Sender"] = "ikagaka";
      request.headers.header["Charset"] = "Shift_JIS";
      Object.keys(ev).forEach(function(key){
        request.headers.header[key] = ""+ev[key];
      });

      ghost.request(""+request, responseHandler);
    }
    function responseHandler(err, response){
      if(!!err) return console.error(err.stack);

      var parser = new ShioriJK.Shiori.Response.Parser();
      parsed = parser.parse(response);
      if(parsed.status_line.arguments.code === 200 &&
         typeof parsed.headers.header.Value === "string"){
        var sakurascript = parsed.headers.header.Value;
        ssp.play(sakurascript);
      }
    }

  }).catch(function(err){ console.error(err, err.stack); });
}
</script>
