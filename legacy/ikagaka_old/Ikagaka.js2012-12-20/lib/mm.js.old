/*!mm={version:"",license:"MIT",author:"uupaa.js@gmail.com",date:"2012-10-08T14:20:21",tool:"google",target:"",cutoff:"assert/debug/spec/interface/ie/gecko/opera"}*/
//{@es
(function(global) { // @arg Global: window or global

function _polyfill() {
    if (!Object.keys) {
         Object.keys = Object_keys;     // Object.keys(obj:Mix):Array
    }

//{@ie8
    if (!Object.defineProperties) {
         Object.defineProperty =
                Object_defineProperty;  // Object.defineProperty
    }
//}@ie8

    // --- Override ---
    // [IE8] "2012-09-16T21:53:39Z" -> "2012-09-16T21:53:39.000Z" (supply Milliseconds)
    // [IE8][force overwrite]
//{@ie8
    if (Date.prototype.toJSON && (new Date).toJSON().length < 24) {
        Date.prototype.toJSON = Date_toJSON;
    }
//}@ie8

    // --- ES5, ES6 Methods ---
    wiz(Date, {
        now:        Date_now            // Date.now():Integer
    });
    wiz(Date.prototype, {
        toJSON:     Date_toJSON         // Date#toJSON():JSONObject
    });
    wiz(Array, {
        of:         Array_of,           // Array.of(...:Mix):Array
        from:       Array_from,         // Array.from(list:FakeArray):Array
        isArray:    Array_isArray       // Array.isArray(mix:Mix):Boolean
    });
    wiz(Array.prototype, {
        some:       Array_some,         // [].some(fn:Function, that:this):Boolean
        every:      Array_every,        // [].every(fn:Function, that:this):Boolean
        indexOf:    Array_indexOf,      // [].indexOf(mix:Mix, index:Integer = 0):Integer
        lastIndexOf:Array_lastIndexOf,  // [].lastIndexOf(mix:Mix, index:Integer = 0):Integer
        filter:     Array_filter,       // [].filter(fn:Function, that:this):Array
        map:        Array_map,          // [].map(fn:Function, that:this):Array
        forEach:    Array_forEach,      // [].forEach(fn:Function, that:this)
        reduce:     Array_reduce,       // [].reduce(fn:Function, init:Mix):Mix
        reduceRight:Array_reduceRight   // [].reduceRight(fn:Function, init:Mix):Mix
    });
    wiz(String.prototype, {
        trim:       String_trim,        // " trim both sp ".trim():String
        repeat:     String_repeat,      // "".repeat(count:Integer):String
        reverse:    String_reverse      // "".reverse():String
    });
    wiz(Number, {
        isNaN:      function(mix) { return typeof mix === "number" && global.isNaN(mix); },
        isFinite:   function(mix) { return typeof mix === "number" && global.isFinite(mix); },
        isInteger:  Number_isInteger,   // Number.isInteger(mix:Mix):Boolean
        toInteger:  Number_toInteger    // Number.toInteger(mix:Mix):Integer
    });
    wiz(Function.prototype, {
        bind:       Function_bind       // Function#bind():Function
    });
//{@JSON
    global.JSON || (global.JSON = {
        parse:          JSON_parse,         // JSON.parse(str:String)
        stringify:      JSON_stringify      // JSON.stringify():Object
    });
//}@JSON
//{@URI
    if (!global.encodeURIComponent) {
         global.encodeURIComponent = global_encodeURIComponent;
    }
    if (!global.decodeURIComponent) {
         global.decodeURIComponent = global_decodeURIComponent;
    }
//}@URI
}

// --- library scope vars ----------------------------------
var _INTEGER_TO_HEXSTRING_MAP;

// --- implement -------------------------------------------
function Object_keys(obj) { // @arg Object/Function/Array:
                            // @ret KeyStringArray: [key, ... ]
                            // @help: Object.keys
    var rv = [], key, i = 0;

//{@ie
    if (!obj.hasOwnProperty) {
        // [IE6][IE7][IE8] host-objects has not hasOwnProperty
        for (key in obj) {
            rv[i++] = key;
        }
    } else
//}@ie
    {
        for (key in obj) {
            obj.hasOwnProperty(key) && (rv[i++] = key);
        }
    }
    return rv;
}

//{@ie8
function Object_defineProperty(obj,          // @arg Object:
                               prop,         // @arg String: property name
                               descriptor) { // @arg Hash: { value, writable, get, set, configurable, enumerable }
                                             // @help: Object.defineProperty
// default property
//  Object.defineProperty(,, { configurable: false, enumerable: false, writable: false });

    var type = 0;

    "value" in descriptor && (type |= 0x1); // data descriptor
    "get"   in descriptor && (type |= 0x2); // accessor descriptor
    "set"   in descriptor && (type |= 0x4); // accessor descriptor

    if (type & 0x1 && type & 0x6) {
        throw new TypeError("BAD_ARG");
    }
    type & 0x1 && (obj[prop] = descriptor.value);
    type & 0x2 && obj.__defineGetter__(prop, descriptor.get); // [IE8]
    type & 0x4 && obj.__defineSetter__(prop, descriptor.set); // [IE8]
}
//}@ie8

// --- ES5, ES6 --------------------------------------------
function Date_now() { // @ret Integer: milli seconds
                      // @desc: get current time
                      // @help: Date.now
    return +new Date();
}

function Array_isArray(mix) { // @arg Mix:
                              // @ret Boolean:
                              // @help: Array.isArray
    return Object.prototype.toString.call(mix) === "[object Array]";
}

function Array_map(fn,     // @arg Function:
                   that) { // @arg this(= undefined): fn this
                           // @ret Array: [element, ... ]
                           // @help: Array#map
    var i = 0, iz = this.length, rv = Array(iz);

    for (; i < iz; ++i) {
        if (i in this) {
            rv[i] = fn.call(that, this[i], i, this);
        }
    }
    return rv;
}

function Array_some(fn,     // @arg Function:
                    that) { // @arg this(= undefined): fn this
                            // @ret Boolean:
                            // @help: Array#some
    var i = 0, iz = this.length;

    for (; i < iz; ++i) {
        if (i in this && fn.call(that, this[i], i, this)) {
            return true;
        }
    }
    return false;
}

function Array_every(fn,     // @arg Function:
                     that) { // @arg this(= undefined): fn this
                             // @ret Boolean:
                             // @help: Array#every
    var i = 0, iz = this.length;

    for (; i < iz; ++i) {
        if (i in this && !fn.call(that, this[i], i, this)) {
            return false;
        }
    }
    return true;
}

function Array_filter(fn,     // @arg Function:
                      that) { // @arg this(= undefined): fn this
                              // @ret Array: [element, ... ]
                              // @help: Array#filter
    var rv = [], value, i = 0, iz = this.length;

    for (; i < iz; ++i) {
        if (i in this) {
            value = this[i];
            if (fn.call(that, value, i, this)) {
                rv.push(value);
            }
        }
    }
    return rv;
}

function Array_reduce(fn,         // @arg Function:
                      init,       // @arg Mix(= undefined): initial value
                      __back__) { // @hidden Boolean(= false): true is reduce right
                                  // @ret Mix:
                                  // @throw: Error("BAD_ARG")
                                  // @help: Array#reduce
    var rv,
        ate  = 0,          // ate init
        back = !!__back__, // back track
        i    = back ? --iz : 0,
        iz   = this.length;

    if (init !== void 0) {
        rv = init;
        ++ate;
    }

    for (; back ? i >= 0 : i < iz; back ? --i : ++i) {
        if (i in this) {
            if (ate) {
                rv = fn(rv, this[i], i, this);
            } else {
                rv = this[i];
                ++ate;
            }
        }
    }
    if (!ate) {
        throw new Error("BAD_ARG");
    }
    return rv;
}

function Array_reduceRight(fn,     // @arg Function:
                           init) { // @arg Mix(= undefined): initial value
                                   // @ret Mix:
                                   // @help: Array#reduceRight
    return Array_reduce.call(this, fn, init, true);
}

function Array_indexOf(mix,     // @arg Mix: search element
                       index) { // @arg Integer(= 0): from index
                                // @ret Integer: found index or -1
                                // @help: Array#indexOf
    var i = index || 0, iz = this.length;

    i = (i < 0) ? i + iz : i;
    for (; i < iz; ++i) {
        if (i in this && this[i] === mix) {
            return i;
        }
    }
    return -1;
}

function Array_lastIndexOf(mix,     // @arg Mix: search element
                           index) { // @arg Integer(= this.length): from index
                                    // @ret Integer: found index or -1
                                    // @help: Array#lastIndexOf
    var i = index, iz = this.length;

    i = (i < 0) ? i + iz + 1 : iz;
    while (--i >= 0) {
        if (i in this && this[i] === mix) {
            return i;
        }
    }
    return -1;
}

function Array_forEach(fn,     // @arg Function:
                       that) { // @arg this(= undefined): fn this
                               // @help: Array#forEach
    var i = 0, iz = this.length;

    for (; i < iz; ++i) {
        i in this && fn.call(that, this[i], i, this);
    }
}

function String_trim() { // @ret String:
                         // @desc: trim both spaces
                         // @help: String#trim
    return this.replace(/^\s+/, "").
                replace(/\s+$/, "");
}

function Array_of(ooo) { // @var_args Mix: values
                         // @ret Array:
                         // @desc: Array.of(1, 2, 3) -> [1, 2, 3]
                         // @help: Array.of
    return Array.prototype.slice.call(arguments);
}

function Array_from(fakeArray) { // @arg FakeArray: Arguments or NodeList
                                 // @ret Array/NodeArray:
                                 // @help: Array.from
    var rv = [], i = 0, iz = fakeArray.length;

    for (; i < iz; ++i) {
        rv.push(fakeArray[i]);
    }
    return rv;
}

function Date_toJSON() { // @ret String: "2000-01-01T00:00:00.000Z"
                         // @help: Date#toJSON
    var dates = { y:  this.getUTCFullYear(),         // 1970 -
                  m:  this.getUTCMonth() + 1,        //    1 - 12
                  d:  this.getUTCDate() },           //    1 - 31
        times = { h:  this.getUTCHours(),            //    0 - 23
                  m:  this.getUTCMinutes(),          //    0 - 59
                  s:  this.getUTCSeconds(),          //    0 - 59
                  ms: this.getUTCMilliseconds() };   //    0 - 999

    return dates.y + "-" + (dates.m < 10 ? "0" : "") + dates.m + "-" +
                           (dates.d < 10 ? "0" : "") + dates.d + "T" +
                           (times.h < 10 ? "0" : "") + times.h + ":" +
                           (times.m < 10 ? "0" : "") + times.m + ":" +
                           (times.s < 10 ? "0" : "") + times.s + "." +
                           ("00" + times.ms).slice(-3) + "Z";
}


function Number_isInteger(mix) { // @arg Mix:
                                 // @ret Boolean:
                                 // @desc: is integer
                                 // @help: Number.isInteger
    return typeof mix === "number" && global.isFinite(mix) &&
                  mix > -0x20000000000000 &&
                  mix <  0x20000000000000 &&
                  Math.floor(mix) === mix;
}

function Number_toInteger(mix) { // @arg Mix:
                                 // @ret Integer:
                                 // @desc: to integer
                                 // @help: Number.toInteger
    var num = +mix;

    if (num !== num) { // isNaN(num)
        return +0;
    }
    if (num === 0 || !global.isFinite(num)) {
        return num;
    }
    return (num < 0 ? -1 : 1) * Math.floor(Math.abs(num));
}

function String_repeat(count) { // @arg Integer: repeat count. if (0 < count) then 0
                                // @ret String: repeated string
                                // @desc: repeat strings
                                // @help: String#repeat
    return (this.length && count > 0) ? Array((count + 1) | 0).join(this)
                                      : "";
}

function String_reverse() { // @ret String:
                            // @desc: reverse characters
                            // @help: String#reverse
    return this.split("").reverse().join("");
}

function Function_bind(context, // @arg that: context
                       ooo) {   // @var_args Mix: arguments
                                // @ret Function:
                                // @help: Function#bind
    var rv, that = this,
        args = Array.prototype.slice.call(arguments, 1),
        fn = function() {};

    rv = function(ooo) { // @var_args Mix: bound arguments
        return that.apply(this instanceof fn ? this : context,
                    Array.prototype.concat.call(
                            args,
                            Array.prototype.slice.call(arguments)));
    };
    fn.prototype = that.prototype;
    rv.prototype = new fn();
    return rv;
}

//{@JSON
function JSON_parse(str) { // @arg String: JSON String
                           // @ret Mix:
                           // @throw: SyntaxError("Unexpected token: ...")
                           // @desc: decode from JSONString
                           // @help: JSON.parse
    var unescaped = str.trim().replace(/"(\\.|[^"\\])*"/g, "");

    if (/[^,:{}\[\]0-9\.\-+Eaeflnr-u \n\r\t]/.test(unescaped)) {
        throw new SyntaxError("Unexpected token:" + str);
    }
    return (new Function("return " + str))(); // raise error
}

function JSON_stringify(obj) { // @arg Mix:
                               // @ret JSONString:
                               // @see: http://developer.mozilla.org/En/Using_native_JSON
                               // @throw: TypeError("Converting circular structure to JSON")
                               // @help: JSON.stringify
                               // @desc: encode to JSONString
    return _recursiveJSONStringify(obj, 0);
}

function _recursiveJSONStringify(mix,    // @arg Mix: value
                                 nest) { // @arg Number: current nest level
                                         // @ret String:
                                         // @inner: json inspect
    var rv = [], ary, key, i, iz,
        type = typeof mix,
        brackets = ["{", "}"];

    if (nest >= 100) {
        throw new TypeError("Converting circular structure to JSON");
    }

    if (mix == null) {   //  null  or  undefined
        return mix + ""; // "null" or "undefined"
    }
    if (mix.toJSON) {    // Date#toJSON
        return mix.toJSON();
    }
    if (type === "boolean" || type === "number") {
        return "" + mix;
    }
    if (type === "string") {
        return '"' + _toJSONEscapedString(mix) + '"';
    }
    if (mix.nodeType || (mix.exec && mix.test)) { // Node or RegExp
        // http://twitter.com/uupaa/statuses/81336979580661760
        return "{}";
    }
    if (Array.isArray(mix)) {
        brackets = ["[", "]"];
        for (i = 0, iz = mix.length; i < iz; ++i) {
            rv.push(_recursiveJSONStringify(mix[i], nest + 1));
        }
    } else { // isHash or other type
        ary = Object.keys(mix);
        for (i = 0, iz = ary.length; i < iz; ++i) { // uupaa-looper
            key = ary[i];
            rv.push('"' + _toJSONEscapedString(key) + '":' +
                          _recursiveJSONStringify(mix[key], nest + 1));
        }
    }
    return brackets[0] + rv.join(",") + brackets[1]; // "{...}" or "[...]"
}

function _toJSONEscapedString(str) { // @arg String:
                                     // @ret String:
                                     // @inner: to JSON escaped string
    var JSON_ESCAPE = {
            '\b': '\\b',    // backspace       U+0008
            '\t': '\\t',    // tab             U+0009
            '\n': '\\n',    // line feed       U+000A
            '\f': '\\f',    // form feed       U+000C
            '\r': '\\r',    // carriage return U+000D
            '"':  '\\"',    // quotation mark  U+0022
            '\\': '\\\\'    // reverse solidus U+005C
        };

    return str.replace(/(?:[\b\t\n\f\r\"]|\\)/g, function(_) {
                return JSON_ESCAPE[_];
            }).replace(/(?:[\x00-\x1f])/g, function(_) {
                return "\\u00" +
                       ("0" + _.charCodeAt(0).toString(16)).slice(-2);
            });
}
//}@JSON

//{@URI
function global_encodeURIComponent(str) { // @arg String:
                                          // @ret String: percent encoded string
                                          // @desc: encode symbol in string.
//{@assert
    mm.allow(str, "String");
//}@assert

    var rv = [], i = 0, iz = str.length, c = 0, safe, map;

    map = _INTEGER_TO_HEXSTRING_MAP || _createMap();

    for (; i < iz; ++i) {
        c = str.charCodeAt(i);

        if (c < 0x80) { // encode ASCII(0x00 ~ 0x7f)
            safe = c === 95 ||              // _
                   (c >= 48 && c <=  57) || // 0~9
                   (c >= 65 && c <=  90) || // A~Z
                   (c >= 97 && c <= 122);   // a~z

            if (!safe) {
                safe = c === 33  || // !
                       c === 45  || // -
                       c === 46  || // .
                       c === 126 || // ~
                       (c >= 39 && c <= 42); // '()*
            }
            if (safe) {
                rv.push(str.charAt(i));
            } else {
                rv.push("%", map[c]);
            }
        } else if (c < 0x0800) { // encode UTF-8
            rv.push("%", map[((c >>>  6) & 0x1f) | 0xc0],
                    "%", map[ (c         & 0x3f) | 0x80]);
        } else if (c < 0x10000) { // encode UTF-8
            rv.push("%", map[((c >>> 12) & 0x0f) | 0xe0],
                    "%", map[((c >>>  6) & 0x3f) | 0x80],
                    "%", map[ (c         & 0x3f) | 0x80]);
        }
    }
    return rv.join("");

    function _createMap() { // { 0: "00", ... 255: "ff" }
        var i = 0x100, iz = 0x200;

        _INTEGER_TO_HEXSTRING_MAP = {};
        for (; i < iz; ++i) {
            _INTEGER_TO_HEXSTRING_MAP[i - 0x100] = i.toString(16).slice(-2);
        }
        return _INTEGER_TO_HEXSTRING_MAP;
    }
}

function global_decodeURIComponent(str) { // @arg String: percent encoded string
                                          // @ret String:
                                          // @throws: Error("BAD_ARG")
                                          // @desc: decode string. like decodeURIComponent
                                          //        `` %xx 形式の文字列をデコードします
                                          //           decodeURIComponent 互換です
//{@assert
    mm.allow(str, "String");
//}@assert

    return str.replace(/(%[\da-f][\da-f])+/g, function(match) {
        var rv = [],
            ary = match.split("%").slice(1), i = 0, iz = ary.length,
            a, b, c;

        for (; i < iz; ++i) {
            a = parseInt(ary[i], 16);

            if (a !== a) { // isNaN(a)
                throw new Error("BAD_ARG");
            }

            // decode UTF-8
            if (a < 0x80) { // ASCII(0x00 ~ 0x7f)
                rv.push(a);
            } else if (a < 0xE0) {
                b = parseInt(ary[++i], 16);
                rv.push((a & 0x1f) <<  6 | (b & 0x3f));
            } else if (a < 0xF0) {
                b = parseInt(ary[++i], 16);
                c = parseInt(ary[++i], 16);
                rv.push((a & 0x0f) << 12 | (b & 0x3f) << 6
                                         | (c & 0x3f));
            }
        }
        return String.fromCharCode.apply(null, rv);
    });
}
//}@URI

function wiz(object,   // @arg Object: base object
             extend) { // @arg Object: properties
                       // @inner:
    var key, keys = Object.keys(extend), i = 0, iz = keys.length;

    for (; i < iz; ++i) { // uupaa-looper
        key = keys[i];
        if (!(key in object)) {
            Object.defineProperty(object, key, {
                configurable: true, // false is immutable
                enumerable: false,  // false is invisible
                writable: true,     // false is read-only
                value: extend[key]
            });
        }
    }
}

// --- export ---
_polyfill();

})(this.self || global);
//}@es
var mm; // @global Function: mm is mofmof.js library namespace

mm || (function(global) { // @arg Global: window or global

// --- mofmof ----------------------------------------------
function _defineLibraryAPIs(mix) {

    // --- Typical types ------
    //  Mix - every types
    //  Hash - key / value store specialized Object
    //  Array - dense array and sparse array
    //  Class - mm("Class") instance
    //  Global - window or global
    //  Integer - alias of Number
    //  Function - executable object
    //  Primitive - undefined / null / Boolean / Number / String
    //
    mm = mix(HashFactory, {             // mm(obj:Object/Hash):Hash
        // --- Interface and Class ---
        Interface:  Interface,          // mm.Interface(name:String, spec:Object)
        Class:      ClassFactory,       // mm.Class(classNames:String, properties:Object = undefined,
                                        //                             statics:Object = undefined):Function
        Hash:       Hash,               // mm.Hash(obj:Object):Hash
        Await:      Await,              // mm.Await(fn:Function, waits:Integer, tick:Function = undefined):Await
        // --- mixin ---
        arg:        mm_arg,             // mm.arg(arg:Object/Function/undefined, defaults:Object):Object
        mix:        mm_mix,             // mm.mix(base:Object/Function, extend:Object, override:Boolean = false):Object/Function
        wiz:        mm_wiz,             // mm.wiz(...:<Object/Function, Object>)
        // --- match ---
        has:        mm_has,             // mm.has(spec:Object/Function, find:Object):Boolean
        like:       mm_like,            // mm.like(lval:Mix, rval:Mix):Boolean
        some:       mm_some,            // mm.some(data:Object/Function/Array/Hash, fn:Function):Boolean
        every:      mm_every,           // mm.every(data:Object/Function/Array/Hash, fn:Function):Boolean
        match:      mm_match,           // mm.match(data:Object/Function/Array/Hash, fn:Function):Mix
        // --- format ---
        // --- filter ---
        // --- iterate ---
        map:        mm_map,             // mm.map(data:Object/Function/Array/Hash, fn:Function):Array
        each:       mm_each,            // mm.each(data:Object/Function/Array/Hash, fn:Function)
        // --- generate ---
        uid:        mm_uid,             // mm.uid(group:String):Integer
        copy:       mm_copy,            // mm.copy(mix:Primitive/Object/Date/RegExp/Array/Hash, depth:Integer = 0):Mix
        cast:   mix(mm_cast, {          // mm.cast(mix:Mix):Mix
            attr:   mm_cast_attr,       // mm.cast.attr(mix:Attr):Object
            list:   mm_cast_list,       // mm.cast.list(mix:FakeArray, from:Integer = 0, to:Integer = length):Array/NodeArray
            style:  mm_cast_style       // mm.cast.style(mix:Style):Object
        }),
        pair:       mm_pair,            // mm.pair(key:Object/Integer/String, value:Mix):Object
        wrap:       mm_wrap,            // mm.wrap(mix:Mix):Function
        clean:      mm_clean,           // mm.clean(data:Object/Function/Array/Hash, typeofFilter:String = ""):DenseObject
        // --- calculate ---
        // --- enumerate ---
        count:      mm_count,           // mm.count(data:Object/Function/Array/Hash):Object
        pick:       mm_pick,            // mm.pick(data:Object/Function/Array/Hash, names:String/StringArray):Array
        keys:       mm_keys,            // mm.keys(data:Object/Function/Array/Hash/Style/Node/Global):Array
        values:     mm_values,          // mm.values(data:Object/Function/Array/Hash/Style/Node/Global):Array
        // --- manipulate ---
        clear:      mm_clear,           // mm.clear(obj:Object/Function/Class):Object/Function/Class
        // --- utility ---
        nop:        mm_nop,             // mm.nop()
        dump:       mm_dump,            // mm.dump(mix:Mix, spaces:Integer = 4, depth:Integer = 5):String
        codec:  mix(mm_codec, {         // mm.codec(type:Integer):Object
            INTEGER_TO_HEXSTRING:   1,  // mm.codec.INTEGER_TO_HEXSTRING     255  ->   "ff"
            HEXSTRING_TO_INTEGER:   2,  // mm.codec.HEXSTRING_TO_INTEGER     "ff" ->   255
            INTEGER_TO_BYTESTRING:  3,  // mm.codec.INTEGER_TO_BYTESTRING    255  -> "\255"
            BYTESTRING_TO_INTEGER:  4   // mm.codec.BYTESTRING_TO_INTEGER  "\255" ->   255
        }),
        strict:     mm_wrap(!this)(),   // mm.strict:Boolean
        // --- assert / debug ---
        say:        mm_say,             // mm.say(...:Mix):String
        deny:       mm_deny,            // mm.deny(mix:Mix, types:Function/Boolean/TypeNameString)
        allow:      mm_allow,           // mm.allow(mix:Mix, types:Function/Boolean/TypeNameString)
        pollution:  mm_pollution,       // mm.pollution()
        // --- type detection ---
        type:   mix(mm_type, {          // mm.type(mix:Mix):String
            alias:  mm_type_alias       // mm.type.alias(obj:Object)
        }),
        complex:    mm_complex,         // mm.complex(arg1:String/Object, arg2:String/Number):Integer
        // --- messageing ---
        Msg:        Msg,                // mm.Msg
        imsg:       {},                 // mm.imsg - Msg instance pool
        // --- log / log group ---
        log:    mix(mm_log, {           // mm.log(...:Mix)
            copy:   mm_log_copy,        // mm.log.copy():Object
            dump:   mm_log_dump,        // mm.log.dump(url:String = "")
            warn:   mm_log_warn,        // mm.log.warn(...:Mix)
            error:  mm_log_error,       // mm.log.error(...:Mix)
            clear:  mm_log_clear,       // mm.log.clear()
            limit:  0                   // mm.log.limit - Integer: stock length
        }),
        logg:   mix(mm_logg, {          // mm.logg(label:String/Function, mode:Integer = 0x0):Object
            nest:   0                   // mm.logg.nest - Number: nest level
        })
    });
    // --- environment ---
    mm.env = _detectEnv({
        lang:       "en",               // mm.env.lang  - String: language. "en", "ja", ...
        node:       global.require &&   // mm.env.node  - Boolean: is node.js
                    global.process,
        ie:         !!document.uniqueID,// mm.env.ie    - Boolean: is IE
        ie8:        false,              // mm.env.ie8   - Boolean: is IE 8
        ie9:        false,              // mm.env.ie9   - Boolean: is IE 9
        ie10:       false,              // mm.env.ie10  - Boolean: is IE 10
        ios:        false,              // mm.env.ios   - Boolean: is iOS
        ipad:       false,              // mm.env.ipad  - Boolean: is iPad
        gecko:      !!global.netscape,  // mm.env.gecko - Boolean: is Gecko
        opera:      !!global.opera,     // mm.env.opera - Boolean: is Opera
        chrome:     false,              // mm.env.chrome - Boolean: is Chrome, Chrome for Android, Chrome for iOS
        webkit:     false,              // mm.env.webkit - Boolean: is WebKit
        safari:     false,              // mm.env.safari - Boolean: is Safari, MobileSafari
        retina:     false,              // mm.env.retina - Boolean: is Retina display. devicePixelRatio >= 2.0
        secure:     false,              // mm.env.secure - Boolean: is SSL page
        android:    false               // mm.env.android - Boolean: is android
    });
}

// --- Hash ------------------------------------------------
// Class Hash
function Hash(obj) { // @arg Object:
                     // @help: Hash
    this._ = obj;
}
Hash.unpack = Hash_unpack;              // Hash.unpack(data:String, glue:String = ":", joint:String = ";"):Hash

function _defineHashPrototype(wiz) {
    wiz(Hash.prototype, {
        __CLASS__: "Hash",
        // --- mixin ---
        mix:        function(extend, override) { // @help: Hash#mix
                                      mm_mix(this._, extend.valueOf(), override);
                                      return this; },
        // --- match ---
        has:        function(find)  { return Object_has(this._, find.valueOf()); },
        like:       function(value) { return Object_like(this._, value.valueOf()); },
        some:       function(fn)    { return Object_some(this._, fn); },
        every:      function(fn)    { return Object_every(this._, fn); },
        match:      function(fn)    { return Object_match(this._, fn); },
        // --- iterate ---
        map:        function(fn)    { return Object_map(this._, fn); },
        each:       function(fn)    {        Object_each(this._, fn); },
        // --- generate ---
        copy:       function()      { return new Hash(mm_copy(this._)); },
        cast:       function()      { return this._; },
        pack:       Hash_pack,      // Hash#pack(glue:String = ":", joint:String = ";"):String
        clean:      Hash_clean,     // Hash#clean(typeofFilter:String = ""):Hash
        // --- enumerate ---
        count:      function()      { return Object_count(this._); },
        pick:       function(names) { return Object_pick(this._, names); },
        keys:       function()      { return Object.keys(this._); },
        values:     function()      { return Object_values(this._); },
        // --- manipulate ---
        clear:      function()      { this._ = {}; return this; },
        // --- utility ---
        help:       function()      { return Function_help(Hash); },
        dump:       function()      { return mm_dump.callby(null, this._, arguments); },
        toJSON:     function()      { return global.JSON.stringify.callby(null, this._, arguments); },
        valueOf:    function()      { return this._; },
        toString:   function()      { return mm_dump(this._, -1, 100); }
    }, true); // override (Object#valueOf, Object#toString)
}

// --- Boolean, Date, Array, String, Number, Function, RegExp ---
function _extendNativeObjects(mix, wiz) {

    // --- Type Detection ---
    wiz(Function.prototype, { __CLASS__: "function",typeFunction: true },
         Boolean.prototype, { __CLASS__: "boolean", typeBoolean:  true },
          String.prototype, { __CLASS__: "string",  typeString:   true },
          Number.prototype, { __CLASS__: "number",  typeNumber:   true },
          RegExp.prototype, { __CLASS__: "regexp",  typeRegExp:   true },
           Array.prototype, { __CLASS__: "array",   typeArray:    true },
            Date.prototype, { __CLASS__: "date",    typeDate:     true });

    // --- Extension ---
    wiz(Date, {
//[ES]  now:        Date_now,           // Date.now():Integer
        from:       Date_from           // Date.from(dateString:String):Date
    });
    wiz(Date.prototype, {
        diff:       Date_diff,          // Date#diff(diffDate:Date/Integer):Object { days, times, toString }
        dates:      Date_dates,         // Date#dates():Object { y, m, d }
        times:      Date_times,         // Date#times():Object { h, m, s, ms }
        format:     Date_format         // Date#format(format:String = "I"):String
//[ES]  toJSON:     Date_toJSON         // Date#toJSON():JSONObject
    });
    wiz(Array, {
//[ES]  of:         Array_of,           // Array.of(...:Mix):Array
//[ES]  from:       Array_from,         // Array.from(list:FakeArray):Array
        range:      Array_range,        // Array.range(begin:Integer, end:Integer, filterOrStep:Function/Integer = 1):Array
        toArray:    Array_toArray,      // Array.toArray(mix:Mix/Array):Array
//[ES]  isArray:    Array_isArray,      // Array.isArray(mix:Mix):Boolean
        isCodedArray:Array_isCodedArray // Array.isCodedArray(mix:Mix):Boolean
    });
    wiz(Array.prototype, {
        // --- match ---
        has:        Array_has,          // [].has(find:Mix/MixArray):Boolean
//[ES]  some:       Array_some,         // [].some(fn:Function, that:this):Boolean
//[ES]  every:      Array_every,        // [].every(fn:Function, that:this):Boolean
        chain:      Array_chain,        // [].chain(param:Mix = undefined):Mix/undefined
        match:      Array_match,        // [].match(fn:Function, that:this):Mix
//[ES]  indexOf:    Array_indexOf,      // [].indexOf(mix:Mix, index:Integer = 0):Integer
//[ES]  lastIndexOf:Array_lastIndexOf,  // [].lastIndexOf(mix:Mix, index:Integer = 0):Integer
        // --- format ---
        at:         Array_at,           // [].at(format:String):String
        // --- filter ---
        sieve:      Array_sieve,        // [].sieve():Object
        unique:     Array_unique,       // [].unique():DenseArray
        reject:     Array_reject,       // [].reject(fn:Function):DenseArray
        select:     Array_select,       // [].select(fn:Function):DenseArray
//[ES]  filter:     Array_filter,       // [].filter(fn:Function, that:this):Array
        flatten:    Array_flatten,      // [].flatten():DenseArray
        // --- iterate ---
//[ES]  map:        Array_map,          // [].map(fn:Function, that:this):Array
        each:       Array.prototype.forEach,
                                        // [].each(fn:Function, that:this) - [alias]
//[ES]  forEach:    Array_forEach,      // [].forEach(fn:Function, that:this)
//[ES]  reduce:     Array_reduce,       // [].reduce(fn:Function, init:Mix):Mix
//[ES]  reduceRight:Array_reduceRight,  // [].reduceRight(fn:Function, init:Mix):Mix
        // --- generate ---
        copy:       Array_copy,         // [].copy(deep:Boolean = false):Array
        clean:      Array_clean,        // [].clean(typeofFilter:String = ""):DenseArray
/*
        toArray:    function() { return this; },
                                        // see: NodeList.prototype.toArray
                                        //      HTMLCollection.prototype.toArray
 */
        decode:     Array_decode,       // [].decode(startIndex:Integer = 0, endIndex:Integer = undefined):String
        // --- calculate ---
        or:         Array_or,           // [].or(merge:Array):Array
        and:        Array_and,          // [].and(compare:Array):Array
        xor:        Array_xor,          // [].xor(compare:Array):Array
        sum:        Array_sum,          // [].sum():Number
        clamp:      Array_clamp,        // [].clamp(low:Number, high:Number):Array
        nsort:      Array_nsort,        // [].nsort(desc:Boolean = false):Array
        average:    Array_average,      // [].average(median:Boolean = false):Number
        // --- enumerate ---
        count:      Array_count,        // [].count():Object
        // --- manipulate ---
        fill:       Array_fill,         // [].fill(value:Primitive/Object/Array/Date, from:Integer = 0, to:Integer = length):Array
        clear:      Array_clear,        // [].clear():this
        remove:     function(find, all) { return this.replace(find, null, all); },
        shifts:     Array_shifts,       // [].shifts():DenseArray
        replace:    Array_replace,      // [].replace(find:Mix, value:Mix = null, all:Boolean = false):this
        // --- utility ---
        dump:       Array_dump,         // [].dump():String
        choice:     Array_choice,       // [].choice():Mix
        stream:     Array_stream,       // [].stream():Object
        shuffle:    Array_shuffle,      // [].shuffle():DenseArray
        // --- test ---
        test:   mix(Array_test, {       // [ test case, ... ].test(label:String = "", arg = undefined)
            tick:   null                // Array#.test.tick({ok,msg,name,pass,miss}) - Tick Callback Function
        })
    });
    wiz(String.prototype, {
        // --- match ---
        has:        String_has,         // "".has(find:String, anagram:Boolean = false):Boolean
        isURL:      String_isURL,       // "".isURL(isRelative:Boolean = false):Boolean
        // --- format ---
        at:         String_at,          // "@@".at(...:Mix):String
        up:         String_up,          // "".up(index:Integer = undedefind):String
        low:        String_low,         // "".low(index:Integer = undedefind):String
        down:       String_low,         // [alias]
//[ES]  trim:       String_trim,        // " trim both sp ".trim():String
        trims:      String_trims,       // "-trim-".trims(chr:String):String
        trimTag:    String_trimTag,     // "<tag></tag>".trimTag(chr:String, all:Boolean = false):String
        trimQuote:  String_trimQuote,   // "'quoted'".trimQuote():String
        format:     String_format,      // "%05s".format(...:Mix):String
        overflow:   String_overflow,    // "".overflow(maxLength:Integer, omit:String = "..."):String
        // --- filter ---
        unique:     String_unique,      // "abcabc".unique():String
        // --- iterate ---
        // --- generate ---
        code:       String_code,        // "".code(code:String = "byte"):CodedArray
//[ES]  repeat:     String_repeat,      // "".repeat(count:Integer):String
        unpack:     String_unpack,      // "key:value".unpack(glue:String = ":", joint:String = ";"):Hash
        numbers:    String_numbers,     // "1,2,3".numbers(joint:String = ","):NumberArray
//[ES]  reverse:    String_reverse,     // "".reverse():String
        // --- calculate ---
        // --- enumerate ---
        count:      String_count,       // "abc".count(find = ""):Integer/Object
        // --- manipulate ---
        insert:     String_insert,      // "".insert(str:String, index:Integer = 0):String
        remove:     String_remove,      // "".remove(str:String, index:Integer = 0):String
        // --- utility ---
        stream:     String_stream       // "".stream(command):Object
    });
//  mix(Number, {
//[ES]  isNaN:      function(mix) { return typeof mix === "number" && global.isNaN(mix); },
//[ES]  isFinite:   function(mix) { return typeof mix === "number" && global.isFinite(mix); },
//[ES]  isInteger:  Number_isInteger,   // Number.isInteger(mix:Mix):Boolean
//[ES]  toInteger:  Number_toInteger    // Number.toInteger(mix:Mix):Integer
//  });
    wiz(Number.prototype, {
        // --- format ---
        pad:        Number_pad,         // 0..pad(digits:Integer = 2, radix:Integer = 10):String
        // --- generate ---
        to:         Number_to,          // 0..to(end:Integer, filterOrStep:Integer = 1):Array
        // --- calculate ---
        xor:        Number_xor,         // 0..xor(value:Integer):Integer
        rand:       Number_rand,        // 100..rand():Integer/Number
        clamp:      Number_clamp,       // 0..clamp(low:Number, high:Number):Number
        toRadians:  Number_toRadians,   // 180..toRadians() === Math.PI
        toDegrees:  Number_toDegrees,   // Math.PI.toDegrees() === 180
        // --- utility ---
        chr:        Number_chr,         // 0x32.chr():String
        wait:       Number_wait,        // 0..wait(fn_that:Function/Array, ...):Integer
        times:      Number_times        // 0..times(fn_that:Function/Array, ...):ResultMixArray
    });
    wiz(Function.prototype, {
//[ES]  bind:       Function_bind,      // Function#bind():Function
        help:   mix(Function_help, {    // Function#help(that:Object = null)
            add:    Function_help_add   // Function#help.add(url:URLString, word:StringArray/RegExp)
        }),
        callby:     Function_callby,    // Function#callby(that, ...):Mix
        nickname:   Function_nickname,  // Function#nickname(defaultName:String = ""):String
        // --- await ---
        await:      Function_await      // Function#await(waits:Integer, tick:Function = undefined):Await
    });
    wiz(RegExp, {
        esc:        RegExp_esc,         // RegExp.esc(str:String):EscapedString
        FILE:       /^(file:)\/{2,3}(?:loc\w+)?([^ ?#]*)(?:(\?[^#]*))?(?:(#.*))?$/i,
                    //                 localhost /dir/f.ext ?key=value    #hash
                    //  [1]                      [2]        [3]          [4]
        URL:        /^(\w+:)\/\/((?:([\w:]+)@)?([^\/:]+)(?::(\d*))?)([^ :?#]*)(?:(\?[^#]*))?(?:(#.*))?$/,
                    //  https://    user:pass@    server   :port    /dir/f.ext   ?key=value     #hash
                    //  [1]         [3]           [4]       [5]     [6]         [7]            [8]
        PATH:       /^([^ ?#]*)(?:(\?[^#]*))?(?:(#.*))?$/
                    //  /dir/f.ext   key=value    hash
                    //  [1]          [2]          [3]
    });
    wiz(RegExp.prototype, {
        flag:       RegExp_flag         // RegExp#flag(flag:String):RegExp
    });
}

// --- Messaging -------------------------------------------
// Class Msg
function Msg() {
    this._deliverable = {}; // deliverable instance db { __CLASS_UID__: instance, ... }
    this._broadcast   = []; // broadcast address

    Object.defineProperty(this, "__CLASS__",     { value: "Msg" });
    Object.defineProperty(this, "__CLASS_UID__", { value: mm_uid("class") });
}
Msg.prototype = {
    __CLASS__:     "Msg",
    bind:           Msg_bind,           // Msg#bind(...):this
    unbind:         Msg_unbind,         // Msg#unbind(...):this
    list:           Msg_list,           // Msg#list():Object/ClassNameStringArray
    to:             Msg_to,             // Msg#to(...):WrapperedObject
    post:           Msg_post,           // Msg#post(msg:String, ...):this
    send:           Msg_send            // Msg#send(msg:String, ...):ResultArray
};

// --- Await ----------------------------------------------
function Await(fn,     // @arg Function: callback({ ok, args, state })
               waits,  // @arg Integer: wait count
               tick) { // @arg Function(= null): tick callback({ ok, args, state })
                       // @help: Await
    this._db = {
        missables: 0,   // Integer: missables
        waits: waits,   // Integer: waits
        pass:  0,       // Integer: pass() called count
        miss:  0,       // Integer: miss() called count
        state: 100,     // Integer: 100(continue) or 200(success) or 400(error)
        args:  [],      // Array: pass(arg), miss(arg) collections
        tick:  tick || null,
        fn:    fn
    };
    Object.defineProperty(this, "__CLASS__",     { value: "Await" });
    Object.defineProperty(this, "__CLASS_UID__", { value: mm_uid("class") });
}

Await.prototype = {
    missable:       Await_missable, // Await#missable(missables:Integer):this
    pass:           Await_pass,     // Await#pass(value:Mix = undefined):this
    miss:           Await_miss,     // Await#miss(value:Mix = undefined):this
    state:          Await_state     // Await#state():Integer
};

// --- library scope vars ----------------------------------
var _mm_uid_db = {},
    _mm_log_db = [],
    _mm_log_index = 0,
    _mm_codec_db = { 0: {}, 1: {}, 2: {}, 3: {}, 4: {}, init: false },
    _mm_type_alias_db = {
        "NodeList": "list",
        "Arguments": "list",
        "NamedNodeMap": "attr",
        "HTMLCollection": "list",
        "CSSStyleDeclaration": "style"
    };

// --- implement -------------------------------------------
function HashFactory(obj) { // @arg Object/Hash:
                            // @ret Hash:
                            // @help: mm.HashFactory
    return obj instanceof Hash ? new Hash(mm_copy(obj._)) // copy constructor
                               : new Hash(obj);
}

function Interface(name,   // @arg String:
                   spec) { // @arg Object: { key: typeString, ... }
                           // @help: mm.Interface
//
//  TypeScript:
//      interface Point { x: number; y: number; }
//
//  mofmof.js:
//      mm.Interface("Point", { x: "number", y: "number" });
//
    if (name in mm) {
        throw new TypeError("ALREADY_EXISTS: " + name);
    }
    mm.Interface[name] = spec;
}

function ClassFactory(classNames, // @arg String: "Class" or "Class[:Trait][:Base][:Interface]"
                      properties, // @arg Object(= undefined): prototype method and literals
                      statics) {  // @arg Object(= undefined): static method and literals
                                  // @ret Function: initializer
                                  // @help: mm.Class
//{@assert
    mm.allow(classNames, "String");
    mm.allow(properties, "Object/undefined");
    mm.allow(statics,    "Object/undefined");
//}@assert

    properties = properties || {};

    var InheritBaseClass,
        spec = _parseClassSpec(classNames); // { klass: String, traits: StringArray,
                                            //   base: String, ifs: StringArray }
    // --- validate class ---
    if (mm.Class[spec.klass]) { // already?
        return mm.Class[spec.klass];
    }
    // --- validate interface ---
//{@interface
    spec.ifs.each(function(name) {
        mm_allow(properties, name);
    });
//}@interface

    // --- class definition ---
    mm.Class[spec.klass] = spec.klass;
    mm[spec.klass] = spec.traits.has("Singleton") ? SingletonClass
                                                  : GenericClass;

    if (spec.base) {
        InheritBaseClass = function() {};
        InheritBaseClass.prototype = mm[spec.base].prototype;
        mm[spec.klass].prototype = new InheritBaseClass();

        mm_mix(mm[spec.klass].prototype, properties, true); // override mixin prototype.methods
        mm[spec.klass].prototype.constructor = mm[spec.klass];
        mm[spec.klass].prototype.__BASE__ = mm_mix({}, mm[spec.base].prototype);
    } else {
        mm_mix(mm[spec.klass].prototype, properties); // mixin prototype.methods
        mm[spec.klass].prototype.__BASE__ = null;
    }
    mm[spec.klass].prototype.callSuper = _callSuperMethod;

    statics && mm_mix(mm[spec.klass], statics);

    if (spec.traits.has("Singleton") && !spec.traits.has("SelfInit")) {
        mm["i" + spec.klass] = new mm[spec.klass];
    }
    return mm[spec.klass];

    function SingletonClass(ooo) { // @var_args Mix: constructor arguments
        if (!SingletonClass.__INSTANCE__) {
             SingletonClass.__INSTANCE__ = this; // keep self instance

            _factory(this, arguments);
        }
        return SingletonClass.__INSTANCE__;
    }

    function GenericClass(ooo) { // @var_args Mix: constructor arguments
        _factory(this, arguments);
    }

    function _factory(that, args) { // @lookup: className, properties,
        Object.defineProperty(that, "__CLASS__",     { value: spec.klass });
        Object.defineProperty(that, "__CLASS_UID__", { value: mm_uid("class") });

        var obj = that, stack = [];

        // --- constructor chain --- (Base#init -> Class#init)
        while (obj = obj.__BASE__) {
            obj.init && stack.push(obj);
        }
        while (obj = stack.pop()) {
            obj.init.apply(that, args);
        }

        // [!] call Class#init(args, ...)
        properties.init && properties.init.apply(that, args);

        that.gc = function() {
            // [!] call Class#gc
            properties.gc && properties.gc.call(that);

            // --- gc chain --- (Class#gc -> Base#gc)
            obj = that;
            while (obj = obj.__BASE__) {
                obj.gc && obj.gc.call(that);
            }

            if (spec.traits.has("Singleton")) {
                delete SingletonClass.__INSTANCE__;
                delete mm["i" + spec.klass];
            }
            mm_clear(that); // destroy them all
            that.gc = function GCSentinel() {
                mm_log("GC_BAD_CALL");
            };
        };
    }
}

function _callSuperMethod(name,  // @arg String: method name
                          ooo) { // @var_args Mix: args
                                 // @ret Mix/undefined:
                                 // @inner: this.callSuper("method", args, ...)
//{@assert
    mm.allow(name, "String");
//}@assert
    var obj = this,
        args = Array.prototype.slice.call(arguments, 1);

    while (obj = obj.__BASE__) {
        if (typeof obj[name] === "function") {
            return obj[name].apply(this, args);
        }
    }
    args.unshift(name);
    return this.trap.apply(this, args); // call trap(method, ...)
}

function _parseClassSpec(ident) { // @arg StringArray: "Class:Trait:Base"
                                  // @ret Object: { klass, traits, base, ifs }
                                  //        klass - String: "Class"
                                  //        traits - StringArray: ["Singleton", "SelfInit"]
                                  //        base - String: "BaseClass"
                                  //        ifs - StringArray: ["Interface", ...]
                                  // @throw: TypeError("CLASS_NAME_NOT_FOUND"),
                                  //         TypeError("CLASS_NAME_MULTIPLE_INHERITANCE: ..."),
                                  //         TypeError("TRAITS_OR_CLASS_NAME_NOT_FOUND: ...")
                                  // @inner: parse traits and base class string
    var TRAITS = ["Singleton", "SelfInit"],
        ary = ident.split(":"), name,
        rv = { klass: "", traits: [], base: "", ifs: [] };

    rv.klass = ary.shift(); // "Class:Base" -> "Class"
    if (!rv.klass) {
        throw new TypeError("CLASS_NAME_NOT_FOUND");
    }
    while (name = ary.shift()) {
        if (name in mm.Interface) {
            rv.ifs.push(name);
        } else if (TRAITS.has(name)) {
            rv.traits.push(name);
        } else if (mm.Class[name]) { // already Class
            if (rv.base) {
                throw new TypeError("CLASS_NAME_MULTIPLE_INHERITANCE: " + name);
            }
            rv.base = name;
        } else {
            throw new TypeError("TRAITS_OR_CLASS_NAME_NOT_FOUND: " + name);
        }
    }
    return rv;
}

// --- mixin ---
function mm_arg(arg,        // @arg Object/Function/undefined: key and argument value pairs `` 引数で渡された Object または undefined を指定します
                defaults) { // @arg Object: default argument hash.
                            //              `` arg に補完する { key: value, ... } を指定します
                            // @ret Object: arg
                            // @help: mm.arg
                            // @desc: supply default argument values `` デフォルト引数を補完します
//{@assert
    mm.allow(arg,      "Object/Function/undefined");
    mm.allow(defaults, "Object");
//}@assert

    return arg ? mm_mix(arg, defaults) : defaults;
}

function mm_mix(base,       // @arg Object/Function: base object. { key: value, ... }
                extend,     // @arg Object: key/value object. { key: value, ... }
                override) { // @arg Boolean(= false): override
                            // @ret Object/Function: base
                            // @help: mm.mix
                            // @desc: mixin values. do not look prototype chain.

    // cannot use assert functions in this function.

    override = override || false;

    var key, keys = Object.keys(extend), i = 0, iz = keys.length;

    for (; i < iz; ++i) { // uupaa-looper
        key = keys[i];
        if (override || !(key in base)) {
            base[key] = extend[key];
        }
    }
    return base;
}

function mm_wiz(ooo) { // @var_args <Object/Function, Object>: <base, extend> pairs
                       // @help: mm.wiz
                       // @desc: prototype extend without enumerability, mixin with "invisible" magic.
                       //        do not look prototype chain.

    // cannot use assert functions in this function.

    var args = arguments, i = 0, iz = args.length, override = false;

    if (args.length & 0x1) { // has odd arg
        iz &= 0xfffe;
        override = !!(args[iz - 1]); // true -> override
    }

    for (; i < iz; i += 2) {
        _extend(args[i], args[i + 1]);
    }

    function _extend(object, extend) {
        var key, keys = Object.keys(extend), i = 0, iz = keys.length;

        for (; i < iz; ++i) { // uupaa-looper
            key = keys[i];
            if (override || !(key in object)) {
                Object.defineProperty(object, key, {
                    configurable: true, // false is immutable
                    enumerable: false,  // false is invisible
                    writable: true,     // false is read-only
                    value: extend[key]
                });
            }
        }
    }
}

// --- match ---
function mm_has(spec,   // @arg Object/Function:
                find) { // @arg Object: { key: value, ... }
                        // @ret Boolean:
                        // @help: mm.has
                        // @desc: has hash pair(s).
                        //        do not look prototype chain.
//{@assert
    mm.allow(spec, "Object/Function");
    mm.allow(find, "Object");
//}@assert

    return typeof spec.has === "function" ? spec.has(find)
                                          : Object_has(spec, find);
}

function mm_like(lval,   // @arg Mix: left value
                 rval) { // @arg Mix: right value
                         // @ret Boolean: true is like value and like structures
                         // @help: mm.like
                         // @desc: Like and deep matching.
                         //        This function does not search inside the prototype chain of the object.
                         //     `` 類似検索と深度探索を行い、よく似ているオブジェクトなら true を返します。
                         //        Object のプロトタイプチェーンは辿りません
    return (lval && typeof lval.like === "function") ? lval.like(rval)
                                                     : Object_like(lval, rval);
}

// --- iterate / enumerate ---
function mm_map(data, // @arg Object/Function/Array/Hash: data
                fn) { // @arg Function: callback function
                      // @ret Array: [result, ...]
                      // @help: mm.map
                      // @desc: mm#map, Array#map
//{@assert
    mm.allow(data, "Object/Function/Array/Hash");
    mm.allow(fn,   "Function");
//}@assert

    return typeof data.map === "function" ? data.map(fn)
                                          : Object_map(data, fn);
}

function mm_each(data, // @arg Object/Function/Array/Hash: data
                 fn) { // @arg Function: callback function
                       // @help: mm.each
                       // @desc: mm#each, Array#each
//{@assert
    mm.allow(data, "Object/Function/Array/Hash");
    mm.allow(fn,   "Function");
//}@assert

    typeof data.each === "function" ? data.each(fn)
                                    : Object_each(data, fn);
}

function mm_some(data, // @arg Object/Function/Array/Hash: data
                 fn) { // @arg Function: fn(value, key)
                       // @ret Boolean:
                       // @help: mm.some
                       // @desc: return true if the return fn(value, key) is truthy
//{@assert
    mm.allow(data, "Object/Function/Array/Hash");
    mm.allow(fn,   "Function");
//}@assert

    return typeof data.some === "function" ? data.some(fn)
                                           : Object_some(data, fn);
}

function mm_every(data, // @arg Object/Function/Array/Hash: data
                  fn) { // @arg Function: fn(value, key)
                        // @ret Boolean:
                        // @help: mm.every
                        // @desc: return false if the return fn(value, key) is falsy
//{@assert
    mm.allow(data, "Object/Function/Array/Hash");
    mm.allow(fn,   "Function");
//}@assert

    return typeof data.every === "function" ? data.every(fn)
                                            : Object_every(data, fn);
}

function mm_match(data, // @arg Object/Function/Array/Hash: data
                  fn) { // @arg Function: fn(value, key)
                        // @ret Boolean:
                        // @help: mm.match
                        // @desc: return value if the return fn(value, key) is truthy
//{@assert
    mm.allow(data, "Object/Function/Array/Hash");
    mm.allow(fn,   "Function");
//}@assert

    return typeof data.match === "function" ? data.match(fn)
                                            : Object_match(data, fn);
}

function mm_count(data) { // @arg Object/Function/Array/Hash: data
                          // @ret Object: { value: value-count, ... }
                          // @help: mm.count
                          // @desc: count the number of values
//{@assert
    mm.allow(data, "Object/Function/Array/Hash");
//}@assert

    return typeof data.count === "function" ? data.count()
                                            : Object_count(data);
}

function mm_pick(data,    // @arg Object/Function/Array/Hash:
                 names) { // @arg String/StringArray:
                          // @ret Array:
//{@assert
    mm.allow(data,  "Object/Function/Array/Hash");
    mm.allow(names, "String/StringArray");
//}@assert

    return typeof data.pick === "function" ? data.pick(names)
                                           : Object_pick(data, names);
}

function mm_keys(data) { // @arg Object/Function/Array/Hash/Style/Node/Global:
                         // @ret Array: [key, ...]
                         // @help: mm.keys
                         // @desc: enumerate keys
//{@assert
    mm.allow(data, "Object/Function/Array/Hash/Style/Node/Global");
//}@assert

    return typeof data.keys === "function" ? data.keys()
                                           : Object.keys(data);
}

function mm_values(data) { // @arg Object/Function/Array/Hash/Style/Node/Global:
                           // @ret Array: [value, ...]
                           // @help: mm.values
                           // @desc: enumerate values
//{@assert
    mm.allow(data, "Object/Function/Array/Hash/Style/Node/Global");
//}@assert

    return typeof data.values === "function" ? data.values()
                                             : Object_values(data);
}

// --- utility ---
function mm_nop() { // @help: mm.nop
                    // @desc: no operation function
}

function mm_uid(group) { // @arg String: uid group name
                         // @ret Integer: unique number, at 1 to 0x1fffffffffffff
                         // @help: mm.uid
                         // @desc: get unique id
                         //        mm.uid("class") -> for Class instance
//{@assert
    mm.allow(group, "String");
//}@assert

    var db = _mm_uid_db;

    db[group] || (db[group] = 0);

    // IEEE754 fraction size. 0x1fffffffffffff = Math.pow(2, 53) - 1
    if (++db[group] >= 0x1fffffffffffff) { // overflow?
        db[group] = 1; // reset
    }
    return db[group];
}

function mm_cast(mix) { // @arg Mix:
                        // @ret Mix:
                        // @help: mm.cast
                        // @desc: remove the characteristic
    switch (mm_type(mix)) {
    case "attr":    return mm_cast_attr(mix);     // cast(Attr) -> Object
    case "Hash":    return mix.valueOf();         // cast(Hash) -> Object
    case "list":    return mm_cast_list(mix);     // cast(List) -> Array
    case "style":   return mm_cast_style(mix);    // cast(Style) -> Object
    case "string":  return Date.from(mix) || mix; // cast(DateString) -> Date/String
    }
    return mix;
}

function mm_cast_attr(mix) { // @arg Attr: NamedNodeMap
                             // @ret Object:
                             // @help: mm.cast.attr
//{@assert
    mm.allow(mix, "Attr");
//}@assert

    var rv = {}, i = 0, attr;

    for (; attr = mix[i++]; ) {
        rv[attr.name] = attr.value;
    }
    return rv;
}

function mm_cast_list(mix,  // @arg FakeArray: Arguments or NodeList
                      from, // @arg Integer(= 0): slice from index
                      to) { // @arg Integer(= length): slice to index. allow negative index
                            // @ret Array/NodeArray:
                            // @help: mm.cast.list
//{@assert
    mm.allow(from, "Integer/undefined");
    mm.allow(to,   "Integer/undefined");
//}@assert

    to = (to || 0) | 0;

    var rv = [], i = (from || 0) | 0;

    if (to <= 0) {
        to = mix.length + to; // mm.cast.list(mix, 1, -2)
    }
    for (; i < to; ++i) {
        rv.push(mix[i]);
    }
    return rv;
}

function mm_cast_style(mix) { // @arg Style: CSSStyleDeclaration
                              // @ret Object:
                              // @help: mm.cast.style
//{@assert
    mm.allow(mix, "Style");
//}@assert

    var rv = {}, key, value, i = 0, iz = mix.length;

    if (iz) { // [Firefox][WebKit][IE]
        for (; i < iz; ++i) {
            key = mix.item(i);
            value = mix[key];
            if (value && typeof value === "string") { // skip methods
                rv[key] = value;
            }
        }
    } else {
//{@opera
        for (key in mix) {
            value = mix[key];
            if (value && typeof value === "string") {
                rv[key] = value;
            }
        }
//}@opera
    }
    return rv;
}

function mm_copy(mix,    // @arg Mix: source object
                 depth,  // @arg Integer(= 0): max depth, 0 is infinity
                 hook) { // @arg Object(= null): handle the unknown object
                         // @ret Mix/null: copied object, null is fail
                         // @throw: TypeError("UNKNOWN_TYPE: ...")
                         // @help: mm.copy
                         // @desc: Object with the reference -> deep copy
                         //        Object without the reference -> shallow copy
                         //        do not look prototype chain.
//{@assert
    mm.allow(depth, "Integer/undefined");
    mm.allow(hook,  "Function/undefined");
//}@assert

    return _recursiveCopy(mix, depth || 0, hook || null, 0);
}

function _recursiveCopy(mix, depth, hook, nest) { // @inner:
    if (depth && nest > depth) {
        return;
    }
    var rv, keys, i = 0, iz;

    switch (mm_type(mix)) {
    // --- deep copy ---
    case "undefined":
    case "null":    return "" + mix; // "null" or "undefined"
    case "boolean":
    case "string":
    case "number":  return mix.valueOf();
    case "regexp":  return RegExp(mix.source,
                                  (mix + "").slice(mix.source.length + 2));
    case "Hash":    return mix.copy();
    case "date":    return new Date(+mix);
    case "array":
        for (rv = [], iz = mix.length; i < iz; ++i) {
            rv[i] = _recursiveCopy(mix[i], depth, hook, nest + 1);
        }
        return rv;
    case "object":
        for (rv = {}, keys = Object.keys(mix), iz = keys.length; i < iz; ++i) {
            rv[keys[i]] = _recursiveCopy(mix[keys[i]], depth, hook, nest + 1);
        }
        return rv;
    // --- shallow copy (by reference) ---
    case "function":
        return mix;
    }
    if (hook) {
        return hook(mix);
    }
    throw new TypeError("UNKNOWN_TYPE: " + mix);
}

function mm_dump(mix,     // @arg Mix: data
                 spaces,  // @arg Integer(= 4): spaces, -1, 0 to 8
                 depth) { // @arg Integer(= 5): max depth, 0 to 100
                          // @ret String:
                          // @help: mm.dump
                          // @desc: Dump Object
//{@assert
    mm.allow(spaces, "Integer/undefined");
    mm.allow(depth,  "Integer/undefined");
//}@assert

    spaces = spaces === void 0 ? 4 : spaces;
    depth  = depth || 5;

//{@assert
    mm.deny(spaces, (spaces < -1 || spaces > 8  ));
    mm.deny(depth,  (depth  <  1 || depth  > 100));
//}@assert

    return _recursiveDump(mix, spaces, depth, 1);
}

function _recursiveDump(mix,    // @arg Mix: value
                        spaces, // @arg Integer: spaces
                        depth,  // @arg Integer: max depth
                        nest) { // @arg Integer: nest count from 1
                                // @ret String:
                                // @inner:
    function _dumpArray(mix) {
        if (!mix.length) {
            return "[]";
        }
        var ary = [], i = 0, iz = mix.length;

        for (; i < iz; ++i) {
            ary.push(indent + _recursiveDump(mix[i], spaces, depth, nest + 1)); // recursive call
        }
        return "[" + lf + ary.join("," + lf) +
                     lf + " ".repeat(spaces * (nest - 1)) + "]";
    }

    function _dumpObject(mix) {
        function _getName(mix) {
            return mix.__CLASS__ ? "mm." + mix.__CLASS__ + sp
                 : mix.nickname  ? mix.nickname("") + "()" + sp : "";
        }
        var ary = [], key, minify = spaces === -1,
            keys = Object.keys(mix).sort(), i = 0, iz = keys.length,
            skip = /^__[\w]+__$/;

        if (!iz) {
            return _getName(mix) + "{}";
        }
        for (; i < iz; ++i) {
            key = keys[i];
            if (!skip.test(key)) {
                ary.push(indent + (minify ? (      key +  ':')
                                          : ('"' + key + '":')) + sp +
                         _recursiveDump(mix[key], spaces, depth, nest + 1)); // recursive call
            }
        }
        return _getName(mix) + "{" + lf + ary.join("," + lf) +
                                     lf + " ".repeat(spaces * (nest - 1)) + "}";
    }

    function _dumpNode(node) { // @arg: Node:
                               // @ret: String: "<body>"
                               //               "<div body>div:nth-child(1)>div>"
                               // @ref: HTMLElement#path
        var name = node.nodeName ? node.nodeName.toLowerCase() : "",
            roots = /^(?:html|head|body)$/;

        if (typeof node.path === "function") {
            // /^<(\w+) ?(.*)?>$/.exec( "<div body>div:nth-child(1)>div>" )
            return "<@@@@>".at(name, roots.test(name) ? "" : " " + node.path());
        }
        return name ? '<' + name + '>'
                    : node === document ? '<document>'
                                        : '<node>';
    }

    if (depth && nest > depth) {
        return "...";
    }

    var lf = spaces > 0 ? "\n" : "", // line feed
        sp = spaces > 0 ? " "  : "", // a space
        indent = " ".repeat(spaces * nest);

    switch (mm_type(mix)) {
    case "null":
    case "global":
    case "number":
    case "boolean":
    case "undefined":   return "" + mix;
    case "date":        return mix.toJSON();
    case "node":        return _dumpNode(mix);
    case "attr":        return _dumpObject(mm_cast_attr(mix));
    case "list":
    case "array":       return _dumpArray(mix);
    case "style":       return _dumpObject(mm_cast_style(mix));
    case "regexp":      return "/" + mix.source + "/";
    case "Hash":        return _dumpObject(mix.valueOf());
    case "object":
    case "function":    return _dumpObject(mix);
    case "string":      return '"' + _toJSONEscapedString(mix) + '"';
    }
    return "";
}

function _toJSONEscapedString(str) { // @arg String:
                                     // @ret String:
                                     // @inner: to JSON escaped string
    var JSON_ESCAPE = {
            '\b': '\\b',    // backspace       U+0008
            '\t': '\\t',    // tab             U+0009
            '\n': '\\n',    // line feed       U+000A
            '\f': '\\f',    // form feed       U+000C
            '\r': '\\r',    // carriage return U+000D
            '"':  '\\"',    // quotation mark  U+0022
            '\\': '\\\\'    // reverse solidus U+005C
        };

    return str.replace(/(?:[\b\t\n\f\r\"]|\\)/g, function(_) {
                return JSON_ESCAPE[_];
            }).replace(/(?:[\x00-\x1f])/g, function(_) {
                return "\\u00" +
                       ("0" + _.charCodeAt(0).toString(16)).slice(-2);
            });
}

function mm_pair(key,     // @arg Object/Integer/String: key
                 value) { // @arg Mix: value
                          // @ret Object: { key: value }
                          // @help: mm.pair
                          // @desc: make pair
//{@assert
    mm.allow(key, "Object/Integer/String");
//}@assert

    if (typeof key === "number" || typeof key === "string") {
        var rv = {};

        rv[key] = value;
        return rv;
    }
    return key; // Object or Object Like Object
}

function mm_wrap(mix) { // @arg Mix: result value
                        // @ret Function:
                        // @help: mm.wrap
                        // @desc: `function-producing` function
    return function() {
        return mix;
    };
}

function mm_clean(data,           // @arg Object/Function/Array/Hash:
                  typeofFilter) { // @arg String(= ""): typeof filter
                                  // @ret DenseObject: new Object as dense object
                                  // @help: mm.clean
                                  // @desc: convert sparse Object to dense Object, trim undefined, null and NaN value
                                  //        ``疎なオブジェクト(sparse object)を密なオブジェクト(dense object)に変換します。
                                  //          undefined, null および NaN の値を除去します
//{@assert
    mm.allow(data,         "Object/Function/Array/Hash");
    mm.allow(typeofFilter, "String/undefined");
//}@assert

    return typeof data.clean === "function" ? data.clean(typeofFilter)
                                            : Object_clean(data, typeofFilter);
}

function mm_clear(obj) { // @arg Object/Function/Class:
                         // @ret Object/Function/Class:
                         // @ref: mm.clear, Array#clear
                         // @help: mm.clear
                         // @desc: clear Object
//{@assert
    mm.allow(obj, "Object/Function/Class");
//}@assert

    var keys = Object.keys(obj), i = 0, iz = keys.length;

    for (; i < iz; ++i) {
        delete obj[keys[i]];
    }
    return obj;
}

function mm_codec(type) { // @arg Integer: mm.codec.INTEGER_TO_HEXSTRING,
                          //               mm.codec.HEXSTRING_TO_INTEGER,
                          //               mm.codec.INTEGER_TO_BYTESTRING,
                          //               mm.codec.BYTESTRING_TO_INTEGER
                          // @ret Object:
                          // @help: mm.codec
                          // @desc: codec

//  INTEGER_TO_HEXSTRING:   1, {     0 : "00" ..   255 : "ff"}   255  ->   "ff"
//  HEXSTRING_TO_INTEGER:   2, {   "00":   0  ..   "ff": 255 }   "ff" ->   255
//  INTEGER_TO_BYTESTRING:  3, {     0 :"\00" ..   255 :"\ff"}   255  -> "\255"
//  BYTESTRING_TO_INTEGER:  4  {  "\00":   0  ..  "\ff": 255 } "\255" ->   255
//                             {"\f780": 128  .."\f7ff": 255 }

//{@assert
    mm.allow(type, "Integer");
//}@assert
    _mm_codec_db.init || _mm_codec_init();

    return _mm_codec_db[type];
}

function _mm_codec_init() { // @inner:
    var db = _mm_codec_db, i = 0, hex, bin;

    for (; i < 0x100; ++i) {
        hex = (i + 0x100).toString(16).slice(1);
        bin = String.fromCharCode(i);
        db[1][i]   = hex;    // {   255 :   "ff" }
        db[2][hex] = i;      // {   "ff":   255  }
        db[3][i]   = bin;    // {   255 : "\255" }
        db[4][bin] = i;      // { "\255":   255  }
    }
    // http://twitter.com/edvakf/statuses/15576483807
    for (i = 0x80; i < 0x100; ++i) { // [Webkit][Gecko]
        db[4][String.fromCharCode(0xf700 + i)] = i; // "\f780" -> 0x80
    }
    db.init = true;
}

// --- assert / debug ---
function mm_say(ooo) { // @var_args Mix:
                       // @help: mm.say
                       // @desc: alert(mm.dump(mix)) short hand
    alert(mm_dump.apply(null, arguments));
}

function mm_deny(mix,     // @arg Mix:
                 judge) { // @arg Function/Boolean/TypeNameString:
                          // @help: mm.deny
                          // @desc: raise an assertion in a type match
    mm_allow(mix, judge, true);
}

function mm_allow(mix,          // @arg Mix:
                  judge,        // @arg Function/Boolean/InterfaceNameString/TypeNameString:
                                //          types: "Primitive/Global/List/Node/Hash/Class"
                                //                 "null/undefined/Boolean/Number/Integer/String"
                                //                 "Date/Object/Array/Function/RegExp/CodedArray"
                  __negate__) { // @hidden Boolean(= false):
                                // @help: mm.allow
                                // @desc: raise an assertion in a type mismatch
    __negate__ = __negate__ || false;

    var assert = false, origin = "";

    if (judge == null) { // mm.allow(mix, undefined or null) -> nop
        return;
    }
    switch (typeof judge) {
    case "function": assert = !(judge(mix) ^ __negate__); break;
    case "boolean":  assert = !(judge      ^ __negate__); break;
    case "string":   assert = !(judge.split("/").some(function(type) {
            if (mix) {
                if (type in mm.Interface) {
                    origin = "interface";
                    if (typeof _judgeInterface) {
                        return _judgeInterface(mix, mm.Interface[type]);
                    }
                    return true;
                }
                if (type in mm.Class) {
                    return true;
                }
            }
            return _judgeType(mix, type);
        }) ^ __negate__);
        break;
    default:
        throw new TypeError("BAD_ARG");
    }
    if (assert) { // http://uupaa.hatenablog.com/entry/2011/11/18/115409
        debugger;
        try {
            var caller = mm.strict ? null : (arguments.callee || 0).caller,
                nickname = caller ? caller.nickname() : "???",
                asserter = __negate__ ? "mm.deny" : "mm.allow";

            if (origin === "interface") {
                throw new TypeError(
                        "\n\n>>> " + nickname + " in " + asserter +
                        "(" + mm_dump(mix, 0) + ", " + judge + ")\n" +
                        "\ninterface @@ @@\n".at(judge,
                                                 mm_dump(mm.Interface[judge])) );
            } else {
                throw new TypeError(
                        "\n\n>>> " + nickname + " in " + asserter +
                        "(" + mm_dump(mix, 0) + ", " + judge + ")\n" +
                        "\nhelp: @@\n\n".at(_getHelpURL(caller)) );
            }
        } catch (o_o) {
            mm_log(mm.env.chrome ? o_o.stack.replace(/at eval [\s\S]+$/m, "")
                                 : o_o + "");
            throw new TypeError("ASSERTION");
        }
    }
}

//{@interface
function _judgeInterface(mix, spec) {
    return Object_every(spec, function(type, key) {
        if (key in mix) { // mix has key
            return spec[key].split("/").some(function(type) {
                if (type in mm.Interface) {
                    return _judgeInterface(mix[key], mm.Interface[type]);
                }
                return _judgeType(mix[key], type);
            });
        }
        return false;
    });
}
//}@interface

function _judgeType(mix, type) {
    type = type.toLowerCase();
    if (mix == null && type === mix + "") { // "null" or "undefined"
        return true;
    }
    return type === "class"     ? !!mix.__CLASS__
         : type === "integer"   ? Number.isInteger(mix)
         : type === "primitive" ? mix == null || typeof mix !== "object"
         : type === "codedarray"? Array.isCodedArray(mix)
         : type === mm_type(mix);
}

function mm_pollution() { // @ret Array: [key, ...]
                          // @help: mm.pollution
                          // @desc: detect global object pollution
    if (mm_pollution._keys) {
        return mm_pollution._keys.xor( Object.keys(global) );
    }
    mm_pollution._keys = Object.keys(global);
    return [];
}

// --- type / detect ---
function mm_type(mix) { // @arg Mix: search
                        // @ret TypeLowerCaseString:
                        // @help: mm.type
                        // @desc: get type/class name
    var rv, type;

    rv = mix === null   ? "null"
       : mix === void 0 ? "undefined"
       : mix === global ? "global"
       : mix.nodeType   ? "node"
       : mix.__CLASS__  ? mix.__CLASS__ // ES Spec: [[Class]] like internal property
       : "";

    if (rv) {
        return rv;
    }
    // typeof primitive -> "number", "string", "boolean"
    type = typeof mix;
    if (type !== "object") {
        return type;
    }

    // Object.prototype.toString.call(Hoge) -> "[object Hoge]"
    // (new Hoge).constructor.name -> "Hoge" (except IE)
    // (new Hoge).constructor + "" -> "[object Hoge]" or "function Hoge()..."

    type = Object.prototype.toString.call(mix);
    if (type === "[object Object]") {
        rv = mix.constructor.name;
        if (!rv) {
            type = mix.constructor + "";
        }
    }
    if (!rv) {
        rv = ( /^\[object (\w+)\]$/.exec(type)   ||
               /^\s*function\s+(\w+)/.exec(type) || ["", ""] )[1];
    }

    if (!rv || rv === "Object") {
        if (mix[mm.strict ? "" : "callee"] ||
            typeof mix.item === "function") {
            return "list"; // Arguments
        }
    }
    if (rv in _mm_type_alias_db) {
        return _mm_type_alias_db[rv];
    }
    return rv ? rv.toLowerCase() : "object";
}

function mm_type_alias(obj) { // @arg Object: { fullTypeName: shortTypeName, ... }
                                 // @help: mm.type.add
    Object_each(obj, function(value, key) {
        _mm_type_alias_db["[object " + key + "]"] = value;
    });
}

function mm_complex(arg1,   // @arg String/Object(= undefined):
                    arg2) { // @arg String/Number(= undefined):
                            // @ret Integer: 1 ~ 4
                            // @help: mm.complex
                            // @desc: detect argument combinations
    //  [1][get all items]  mm.complex() -> 1
    //  [2][get one item]   mm.complex(key:String) -> 2
    //  [3][set one item]   mm.complex(key:String, value:Mix) -> 3
    //  [4][set all items]  mm.complex({ key: value:Mix, ... }) -> 4

    return arg1 === void 0 ? 1
         : arg2 !== void 0 ? 3
         : arg1 && typeof arg1 === "string" ? 2 : 4;
}

// --- log ---
function mm_log(ooo) { // @var_args Mix: message
                       // @help: mm.log
                       // @desc: push log db
    _mm_log_db.push({ type: 0, time: Date.now(),
                      msg:  [].slice.call(arguments).join(" ") });
    _mm_log_db.length > mm_log.limit && mm_log_dump();
}

function mm_log_warn(ooo) { // @var_args Mix: message
                            // @help: mm.log.warn
                            // @desc: push log db
    _mm_log_db.push({ type: 1, time: Date.now(),
                      msg:  [].slice.call(arguments).join(" ") });
    _mm_log_db.length > mm_log.limit && mm_log_dump();
}

function mm_log_error(ooo) { // @var_args Mix: message
                             // @help: mm.log.error
                             // @desc: push log db
    _mm_log_db.push({ type: 2, time: Date.now(),
                      msg:  [].slice.call(arguments).join(" ") });
    _mm_log_db.length > mm_log.limit && mm_log_dump();
}

function mm_log_copy() { // @ret: Object { data: [log-data, ...], index: current-index }
                         // @help: mm.log.copy
                         // @desc: copy log
    return { data: _mm_log_db.copy(), index: _mm_log_index };
}

function mm_log_dump(url) { // @arg String(= ""): "" or url(http://example.com?log=@@)
                            // @help: mm.log.dump
                            // @desc: dump log
    function _stamp(db) {
        return new Date(db.time).format(db.type & 4 ? "[D h:m:s ms]:" : "[I]:");
    }
    var db = _mm_log_db, i = _mm_log_index, iz = db.length,
        console = global.console,
        space = mm.env.webkit ? "  " : "";

    if (!url) {
        if (console) {
            for (; i < iz; ++i) {
                switch (db[i].type) {
                case 0: console.log( space + _stamp(db[i]) + db[i].msg); break;
                case 1: console.warn(space + _stamp(db[i]) + db[i].msg); break;
                case 2: console.error(       _stamp(db[i]) + db[i].msg); break;
                case 4: console.log( space + _stamp(db[i]) + db[i].msg);
                case 6: console.error(       _stamp(db[i]) + db[i].msg); break;
                }
            }
        }
    } else if (url.indexOf("http") === 0) {
        if (global.Image) {
            for (; i < iz; ++i) {
                (new Image).src = url.at(db[i].msg);
            }
        }
    }
    _mm_log_index = i;
}

function mm_log_clear() { // @help: mm.log.clear
                          // @desc: clear log db
    _mm_log_index = 0;
    _mm_log_db = [];
}

function mm_logg(label,  // @arg String/Function: label (group name)
                 mode) { // @arg Integer(= 0x0): 0x4 is perf mode
                         // @ret Object: { out, error, valueOf }
                         // @help: mm.logg
                         // @desc: log group
//{@assert
    mm.allow(label, "String/Function");
    mm.allow(mode,  "Integer/undefined");
//}@assert

    label = label.nickname ? label.nickname() : label;
    mode  = mode || 0;

    var now = Date.now(),
        nest = mm_logg.nest++,
        line = mm.env.lang === "ja" ? ["\u2502", "\u250c", "\u2502", "\u2514"]
                                    : ["|",      "+-",     "| ",     "`-"    ];

    _mm_log_db.push({ type: mode, time: Date.now(), msg: _msg(1, "") });
    _logg.out   = _out;
    _logg.error = _error;
    return _logg;

    function _msg(index, msg) {
        return "@@@@ @@( @@ )".at(line[0].repeat(nest), line[index], label, msg);
    }
    function _error(ooo) {
        _mm_log_db.push({ type: mode + 2, time: Date.now(),
                          msg:  _msg(2, [].slice.call(arguments).join(" ")) });
    }
    function _logg(ooo) {
        _mm_log_db.push({ type: mode, time: Date.now(),
                          msg:  _msg(2, [].slice.call(arguments).join(" ")) });
    }
    function _out() {
        _mm_log_db.push({ type: mode, time: Date.now(),
                          msg:  _msg(3, (new Date).diff(now)) });
        --mm_logg.nest;
        _mm_log_db.length > mm_log.limit && mm_log_dump();
    }
}

// --- Messaging ---
function Msg_bind(ooo) { // @var_args Instance: register drain instance
                         // @ret this:
                         // @throw: Error("NOT_DELIVERABLE")
                         // @help: Msg#bind
                         // @desc: register the drain(destination of the message) instance
    Array.prototype.slice.call(arguments).forEach(function(instance) {
        if (instance &&
            instance.__CLASS_UID__ && typeof instance.msgbox === "function") {

            this._deliverable[instance.__CLASS_UID__] = instance; // overwrite
        } else {
            throw new Error("NOT_DELIVERABLE");
        }
    }, this);

    // update broadcast address
    this._broadcast = mm_values(this._deliverable);
    return this;
}

function Msg_unbind(ooo) { // @var_args Instance: drain instance. undefined is unbind all instance
                           // @ret this:
                           // @help: Msg#unbind
                           // @desc: unregister drain instance
    var args = arguments.length ? Array.prototype.slice.call(arguments)
                                : this._broadcast;

    args.each(function(instance) {
        if (instance.__CLASS_UID__) {
            delete this._deliverable[instance.__CLASS_UID__];
        }
    }, this);

    // update broadcast address
    this._broadcast = mm_values(this._deliverable);
    return this;
}

function Msg_list(classList) { // @arg Boolean(= false): true is return [className, ...]
                               // @ret Object/ClassNameStringArray: { __CLASS_UID__: instance, ... }
                               //                                                or [className, ...]
                               // @help: Msg#list
                               // @desc: get registered instance list
    return classList ? mm_pick(this._deliverable, "__CLASS__")
                     : mm_copy(this._deliverable);
}

function Msg_to(ooo) { // @var_args Instance: delivery to address.
                       //            undefined   is Broadcast
                       //            Instance    is Unicast
                       //            instance... is Multicast
                       // @ret WrapperedObject: { that, addr, deli, post, send }
                       // @help: Msg#to
                       // @desc: set destination address
    var deli = {}, i;

    for (i in this._deliverable) {
        deli[i] = this._deliverable[i];
    }
    return {
        that: this,
        addr: arguments.length ? Array.prototype.slice.call(arguments)
                               : this._broadcast.concat(), // shallow copy
        deli: deli,
        post: Msg_post,
        send: Msg_send
    };
}

function Msg_send(msg,   // @arg String: msg
                  ooo) { // @var_args Mix: msgbox args. msgbox(msg, arg, ...)
                         // @ret Array: [result, ...], "NOT_DELIVERABLE" is ERROR
                         // @help: Msg#send
                         // @desc: send a message synchronously
//{@assert
    mm.allow(msg, "String");
//}@assert

    var rv = [], instance,
        addr = (this.addr || this._broadcast).concat(), i = 0, iz = addr.length,
        args = Array.prototype.slice.call(arguments),
        deli = this.deli || this._deliverable;

    for (; i < iz; ++i) {
        instance = deli[ addr[i].__CLASS_UID__ ];

        if (instance && instance.msgbox) {
            rv[i] = instance.msgbox.apply(instance, args);
        } else {
            rv[i] = "NOT_DELIVERABLE";
            if (instance) {
                mm_log(msg + " is not deliverable. " + instance.__CLASS__);
            }
        }
    }
    return rv;
}

function Msg_post(msg,   // @arg String: msg
                  ooo) { // @var_args Mix: msgbox args. msgbox(msg, arg, ...)
                         // @ret this:
                         // @help: Msg#post
                         // @desc: post a message asynchronously
//{@assert
    mm.allow(msg, "String");
//}@assert

    var addr = (this.addr || this._broadcast).concat(), // shallow copy
        args = Array.prototype.slice.call(arguments),
        deli = this.deli || this._deliverable;

    0..wait(function() {
        var instance, i = 0, iz = addr.length;

        for (; i < iz; ++i) {
            instance = deli[ addr[i].__CLASS_UID__ ];

            if (instance && instance.msgbox) {
                instance.msgbox.apply(instance, args);
            } else {
                if (instance) {
                    mm_log(msg + " is not deliverable. " + instance.__CLASS__);
                }
            }
        }
    });
    return this.that || this;
}

function Date_from(date) { // @arg Date/String:
                           // @ret Date/null:
                           // @help: Date.from
                           // @desc: parse date string
//{@assert
    mm.allow(date, "Date/String");
//}@assert

    if (date.typeDate) {
        return date;
    }
    var DATE_PARSE = /^(\d{4})-(\d\d)-(\d\d)T(\d\d):(\d\d):(\d\d)(?:\.(\d*))?Z$/,
                     // [1]y    [2]m   [3]d   [4]h   [5]m   [6]s       [7]ms
        m = DATE_PARSE.exec(date), d;

    if (m) {
        return new Date(Date.UTC(+m[1], +m[2] - 1,   +m[3], // Y, M, D
                                 +m[4], +m[5], +m[6], m[7] ? +m[7] : 0));
    }
    d = new Date(date);
    return isNaN(+d) ? null : d; // date.valueOf() -> NaN -> parse error
}

function Date_diff(diffDate) { // @arg Date/Integer: diff date
                               // @ret Object: { days, times, toString }
                               //    days - Integer: days
                               //    times - Object: Date#times result
                               //    toString - Function:
                               // @help: Date#diff
                               // @desc: date.diff(time_t) or date.diff(date)
//{@assert
    mm.allow(diffDate, "Date/Integer");
//}@assert

    var span = Math.abs(+this - +diffDate),
        diff = new Date(span); // 1970-01-01 + span

    return {
        days: (span / 86400000) | 0,
        times: diff.times(),
        toString: function(format) { // @arg String(= "m:s.ms"): Date#format
            return diff.format(format || "m:s.ms");
        }
    };
}

function Date_dates() { // @ret Object: { y, m, d }
                        // @help: Date#dates
                        // @desc: get date info
    return { y:  this.getUTCFullYear(),         // 1970 -
             m:  this.getUTCMonth() + 1,        //    1 - 12
             d:  this.getUTCDate() };           //    1 - 31
}

function Date_times() { // @ret Object: { h, m, s, ms }
                        // @help: Date#times
                        // @desc: get time info
    return { h:  this.getUTCHours(),            //    0 - 23
             m:  this.getUTCMinutes(),          //    0 - 59
             s:  this.getUTCSeconds(),          //    0 - 59
             ms: this.getUTCMilliseconds() };   //    0 - 999
}

function Date_format(format) { // @arg String(= "I"): format("Y-M-D h:m:s.ms")
                               // @ret String: formated date string
                               // @help: Date#format
                               // @desc: format date
//{@assert
    mm.allow(format, "String/undefined");
//}@assert

    var rv = [],
        ary = (format || "I").split(""), key, i = 0, iz = ary.length,
        iso = this.toJSON(),
        m   = iso.split(/[^\d]/),
        map = {
            I: iso,  d: (+this / 86400000) | 0,
            Y: m[0], M: m[1], D: m[2], h: m[3], m: m[4], s: m[5], ms: m[6]
        };

    for (; i < iz; ++i) {
        key = ary[i];
        if (key === "m" && ary[i + 1] === "s") {
            key = "ms";
            ++i;
        }
        rv.push( map[ key ] || key );
    }
    return rv.join("");
}

function Array_range(begin,          // @arg Integer: begin `` 開始番号を数値で指定します
                     end,            // @arg Integer: end   `` 終了番号を数値で指定します。フィルタによる制限が無い限り、戻り値にはendで指定した終了番号が含まれます
                     filterOtStep) { // @arg Function/Integer(= 1): filter or skip number `` フィルター関数またはスキップ数を指定します。省略可能です
                                     // @ret Array: [begne, ... end] `` [begin, ... end] の配列を返します
                                     // @see: Array.range, Number#to
                                     // @throw: Error("BAD_ARG") `` 引数が不正です
                                     // @help: Array.range
                                     // @desc: range generator `` 連続した数値の配列を作成します
//{@assert
    mm.allow(begin,        "Integer");
    mm.allow(end,          "Integer");
    mm.allow(filterOtStep, "Function/Integer/undefined");
//}@assert

    return (begin).to(end, filterOtStep); // Number#to
}

function Array_toArray(mix) { // @arg Mix/Array:
                              // @ret Array:
                              // @help: Array.toArray
    return Array.isArray(mix) ? [mix] : mix;
}

function Array_isCodedArray(mix) { // @arg Mix:
                                   // @ret Boolean:
                                   // @help: Array.isCodedArray
    return Array.isArray(mix) && !!mix.code;
}

function Array_chain(param) { // @arg Mix:
                              // @ret Mix/undefined:
                              // @help: Array#chain
                              // @desc: return value or undefined if the return fn(value, key) is truthy
    var rv, value, fn, i = 0, iz = this.length;

    for (; i < iz; i += 2) { // [<value, fn>, <value, fn>, ...]
        if (i in this) {
            value = this[i];
            fn = this[i + 1];
            if (typeof fn === "function") {
                rv = fn(value, i, param); // fn(value, index, param)
                if (rv) {
                    return rv;
                }
            }
        }
    }
    return;
}

function Array_match(fn,     // @arg Function:
                     that) { // @arg this(= undefined): fn this
                             // @ret Mix/undefined:
                             // @help: Array#match
                             // @desc: return value if the return fn(value, key) is truthy.
    var i = 0, iz = this.length;

    for (; i < iz; ++i) {
        if (i in this && fn.call(that, this[i], i, this)) {
            return this[i];
        }
    }
    return;
}

function Array_at(format) { // @arg String: format `` フォーマット文字列を指定します。フォーマット文字列中の @@ を配列の各要素で置換します
                            // @ret String: "formatted string" `` 置換後の文字列を返します
                            // @this: replacement arguments `` "@@" を置換する引数を指定します
                            // @desc: placeholder( "@@" ) replacement `` 配列の各要素を引数として String#at() を実行します
                            // @help: Array#at
//{@assert
    mm.allow(format, "String");
//}@assert

    var ary = this, i = 0;

    return format.replace(/@@/g, function() {
        return ary[i++];
    });
}

function Array_has(find) { // @arg Mix/MixArray: element or [element, ...]
                           // @ret Boolean:
                           // @desc: Array has all element(s)
                           // @help: Array#has
    if (Array.isArray(find)) {
        var i = 0, iz = find.length;

        for (; i < iz; ++i) {
            if (this.indexOf(find[i]) < 0) {
                return false;
            }
        }
        return true;
    }
    return this.indexOf(find) >= 0;
}

function Array_copy(deep) { // @arg Boolean(= false): true is deep copy
                            // @help: Array#copy
                            // @desc: has non-copyable object -> shallow copy
                            //        copyable object -> deep copy
    return deep ? mm_copy(this)  // deep copy
                : this.concat(); // shallow copy
}

function Array_unique() { // @ret DenseArray: new Array has unique element(s)
                          // @help: Array#unique
                          // @desc: make array from unique element (trim null and undefined elements)
                          //        `` 配列の要素を走査し、ユニークな要素だけを持つ新しい配列を生成します
                          //           要素の比較は === 演算子で行います。
                          //           null, undefined, NaN を除去します
    return this.sieve().values;
}

function Array_clean(typeofFilter) { // @arg String(= ""): typeof filter. "number", "string"
                                     // @ret DenseArray: new array
                                     // @help: Array#clean
                                     // @desc: convert sparse array to dense array, trim undefined, null and NaN value
                                     //        ``疎な配列(sparse array)を密な配列(dense array)に変換します。
                                     //          undefined, null および NaN を配列から除去します
//{@assert
    mm.allow(typeofFilter, "String/undefined");
//}@assert

    typeofFilter = typeofFilter || "";

    var rv = [], value, i = 0, iz = this.length;

    for (; i < iz; ++i) {
        value = this[i];
        if (value === value && value != null) {
            if (!typeofFilter || typeof value === typeofFilter) {
                rv.push(value);
            }
        }
    }
    return rv;
}

function Array_decode(startIndex, // @arg Integer(= 0):
                      endIndex) { // @arg Integer(= undefined):
                                  // @ret String:
                                  // @this CodedArray: [mix, ...] + { code: String }
                                  // @help: Array#decode
                                  // @desc: decode CodedArray to String
//{@assert
    mm.allow(this,       !!this.code); // CodedArray
    mm.allow(startIndex, "Integer/undefined");
    mm.allow(endIndex,   "Integer/undefined");
//}@assert

    var code = this.code || "byte";

    switch (code.toLowerCase()) {
    case "":      throw new TypeError("BAD_ARG");
    case "byte":
    case "utf16": return _Array_utf16(this, startIndex, endIndex);
    case "utf8":  return _Array_utf8(this, startIndex, endIndex);
    }
    return "";
}

function _Array_utf8(data,       // @arg Array:
                     startIndex, // @arg Integer(= 0):
                     endIndex) { // @arg Integer(= undefined):
    var rv = [], c = 0,
        i  = startIndex || 0,
        iz =   endIndex || data.length;

    if (iz > data.length) {
        iz = data.length;
    }

    for (; i < iz; ++i) {
        c = data[i];
        if (c < 0x80) {         // 0x00 - 0x7F (1 byte)
            rv.push(c);
        } else if (c < 0xE0) {  // 0xC0 - 0xD0 (2 bytes)
            rv.push( (c & 0x1f) <<  6 | (data[++i] & 0x3f) );
        } else if (c < 0xF0) {  // 0xE0 - 0xEF (3 bytes)
            rv.push( (c & 0x0f) << 12 | (data[++i] & 0x3f) <<  6 |
                                        (data[++i] & 0x3f) );
        } else if (c < 0xF8) {  // 0xE0 - 0xE7 (4 bytes)
            rv.push( (c & 0x07) << 18 | (data[++i] & 0x3f) << 12 |
                                        (data[++i] & 0x3f) <<  6 |
                                        (data[++i] & 0x3f) );
        }
    }
    return _Array_utf16(rv); // Array#utf16
}

function _Array_utf16(data,       // @arg Array:
                      startIndex, // @arg Integer(= 0):
                      endIndex) { // @arg Integer(= undefined):
    var rv = [], i = 0, iz = data.length, bulkSize = 10240;

    // pre slice
    if (startIndex !== void 0 ||
          endIndex !== void 0) {

        data = data.slice(startIndex || 0, Math.max(endIndex || iz, iz));
        iz = data.length;
    }

    // avoid String.fromCharCode.apply(null, BigArray) exception
    for (; i < iz; i += bulkSize) {
        rv.push( String.fromCharCode.apply(null, data.slice(i, i + bulkSize)) );
    }
    return rv.join("");
}

function Array_count() { // @ret Object: { value: value-count, ... }
                         // @help: Array#count
                         // @desc: count the number of values
    return Object_count(this);
}

function Array_sieve() { // @ret Object: { values:Array, dups:Array }
                         // @help: Array#sieve
                         // @desc: sieve values, duplicate values
                         //        `` 配列の要素を走査し、重複する要素を分離します
                         //           要素の比較は === 演算子で行います。
                         //           null, undefined, NaN を除去します

    var ary = this.clean(), values = [], dups = [], i = 0, iz = ary.length;

    for (; i < iz; ++i) {
        values.indexOf(ary[i]) >= 0 ? dups.push(ary[i])
                                    : values.push(ary[i]);
    }
    return { values: values, dups: dups };
}

function Array_shifts() { // @ret Array: cloned new Array
                          // @help: Array#shifts
                          // @desc: shift all elements
    var rv = this.concat(); // shallow copy

    this.length = 0;
    return rv; // return all elements
}

function Array_replace(find,  // @arg Mix: find value
                       value, // @arg Mix(= null): replace value. null or undefined is remove
                       all) { // @arg Boolean(= false): true is find all elements
                              // @ret this:
                              // @help: Array#replace
                              // @desc: replace or remove element(s)
    var index = 0, remove = value == null;

    while (index = this.indexOf(find, index) + 1) {
        remove ? this.splice(index - 1, 1)
               : this.splice(index - 1, 1, value);
        if (!all) {
            break;
        }
        --index;
    }
    return this;
}

function Array_shuffle() { // @ret DenseArray: new Array
                           // @help: Array#shuffle
                           // @desc: shuffle element(s)
    var rv = this.clean(), i = rv.length, j, k;

    if (i) {
        // Fisher-Yates
        while (--i) {
            j = (Math.random() * (i + 1)) | 0;
            if (i !== j) {
                k     = rv[i];
                rv[i] = rv[j];
                rv[j] = k;
            }
        }
    }
    return rv;
}

// --- calculate ---
function Array_sum() { // @ret Number: sum
                       // @desc: sum of numeric elements `` 数値要素の合計を返します。数値要素以外は無視します
                       // @help: Array#sum
    var rv = 0, ary = this.clean("number"), i = 0, iz = ary.length;

    for (; i < iz; ++i) {
        rv += ary[i];
    }
    return rv;
}

function Array_dump() { // @ret String: [ 0x1234, 0x12, 0x0, ... ]
                        // @desc: Hex dump
                        // @help: Array#dump
    var rv, value = this, v, i, iz;

    for (rv = [], i = 0, iz = value.length; i < iz; ++i) {
        v = value[i];
        if (typeof v === "number") {
            rv[i] = v < 0 ? ("-0x" + v.hh(4).slice(1)) // Number#hh
                          : ( "0x" + v.hh(4));
        } else {
            rv[i] = "NaN";
        }
    }
    return "[ " + rv.join(", ") + " ]"; // [ 0x1234, 0x12, 0x0, ... ]
}

function Array_clamp(low,    // @arg Number: low numeric value
                     high) { // @arg Number: high numeric value
                             // @ret Array: clamped numeric elements
                             // @desc: to clamp numeric elements `` 数値要素の値をlowからhightの範囲に制限し数値要素だけの配列を返します
                             // @help: Array#clamp
//{@assert
    mm.allow(low,  "Number");
    mm.allow(high, "Number");
//}@assert

    return this.clean("number").map(function(num) {
        return num.clamp(low, high); // Number#clamp
    });
}

function Array_nsort(desc) { // @arg Boolean(= false): false is ascending(0 -> 99)
                             //                        true is descending(99 -> 0)
                             // @ret Array: new Array
                             // @desc: numeric sort
                             // @help: Array#nsort
    function ascending(a, b) { // 0, 1, .. 98, 99
        return a - b;
    }

    function descending(a, b) { // 99, 98, .. 1, 0
        return b - a;
    }

//{@assert
    mm.allow(desc, "Boolean/undefined");
//}@assert

    return this.clean("number").sort(desc ? descending : ascending);
}

function Array_average(median) { // @arg Boolean(= false): true is median `` ソートしたサンプルの中央の値を採用します
                                 //                        false is total/length `` 合計値をサンプル数で割った値を採用します
                                 // @ret Number: average
                                 // @desc: average of number elements(arithmetic mean) `` 数値要素の平均値を返します
                                 // @help: Array#average
//{@assert
    mm.allow(median, "Boolean/undefined");
//}@assert

    var ary = this.clean("number"), iz = ary.length;

    if (!median) {
        return ary.sum() / iz;
    }
    ary.nsort(); // 0, 1, .. 98, 99
    // `` 奇数ならソートした中央の値を平均値とし、偶数なら中央の2値の平均を取得
    return iz % 2 ? ary[(iz - 1) / 2]                    // odd  `` 奇数
                  : (ary[iz / 2 - 1] + ary[iz / 2]) / 2; // even `` 偶数
}

function Array_or(merge) { // @arg Array: merge `` 比較対象を配列で指定します
                           // @ret Array: filterd array `` 両方の配列に存在する要素を持つ新しい配列を返します
                           // @desc: OR operator`` 2つの配列をマージし重複する要素を取り除いた新しい配列を生成します
                           // @help: Array#or
//{@assert
    mm.allow(merge, "Array");
//}@assert

    return this.concat(merge).unique();
}

function Array_and(compare) { // @arg Array: compare `` 比較対象を配列で指定します
                              // @ret Array: filterd array `` 両方に含まれる要素からなる新しい配列を返します
                              // @desc: AND operator`` 両方の配列に存在する要素からなる新しい配列を生成します
                              // @help: Array#and
//{@assert
    mm.allow(compare, "Array");
//}@assert

    var rv = [], i = 0, iz = this.length;

    for (; i < iz; ++i) {
        if (i in this) {
            if (compare.indexOf(this[i]) >= 0) { // has
                rv.push(this[i]);
            }
        }
    }
    return rv;
}

function Array_xor(compare) { // @arg Array: compare `` 比較対象を配列で指定します
                              // @ret Array: filterd array `` 両方に含まれない要素からなる新しい配列を返します
                              // @desc: XOR operator`` 両方の配列に存在する要素を除外した新しい配列を生成します
                              // @help: Array#xor
//{@assert
    mm.allow(compare, "Array");
//}@assert

    var rv = [], index, i = 0, iz = this.length;

    for (; i < iz; ++i) {
        if (i in this) {
            index = compare.indexOf(this[i]);
            index >= 0 ? compare.splice(index, 1)
                       : rv.push(this[i]);
        }
    }
    return rv.concat(compare);
}

function Array_fill(value, // @arg Primitive/Object/Array/Date(= undefined): fill value
                    from,  // @arg Integer(= 0): fill from index
                    to) {  // @arg Integer(= length): fill to index
                           // @ret Array: new Array
                           // @see: http://www.ruby-lang.org/ja/man/html/Array.html
                           // @desc: fill value `` 要素をvalueで上書きします。
                           // @help: Array#fill
//{@assert
    mm.allow(value, "Primitive/Array/Date");
    mm.allow(from,  "Integer/undefined");
    mm.allow(to,    "Integer/undefined");
//}@assert

    var rv = this.concat(), i = from || 0, iz = to || rv.length;

    switch (mm_type(value)) {
    case "date":   for (; i < iz; ++i) { rv[i] = new Date(value); } break;
    case "array":  for (; i < iz; ++i) { rv[i] = value.concat();  } break;
    case "object": for (; i < iz; ++i) { rv[i] = mm_copy(value);  } break;
    default:       for (; i < iz; ++i) { rv[i] = value; }
    }
    return rv;
}

function Array_clear() { // @ret this:
                         // @desc: removes all elements from self `` 配列から全ての要素を削除します。配列自身を変更します
                         // @help: Array#clear
    this.length = 0;
    return this;
}

function Array_choice() { // @ret Mix:
                          // @desc: Random choice
                          // @help: Array#choice
    var index = (Math.random() * this.length) | 0;

    return this[index];
}

function Array_reject(fn) { // @arg Function: callback(element, index)
                            // @ret DenseArray: new Array
                            // @desc: reject elements
                            // @help Array#rejct
//{@assert
    mm.allow(fn, "Function");
//}@assert

    var rv = [], ary = this.clean(), i = 0, iz = ary.length;

    for (; i < iz; ++i) {
        fn(ary[i], i) || rv.push(ary[i]);
    }
    return rv;
}

function Array_select(fn) { // @arg Function: callback(element, index)
                            // @ret DenseArray: new Array
                            // @desc: select elements
                            // @help: Array#select
//{@assert
    mm.allow(fn, "Function");
//}@assert

    var rv = [], ary = this.clean(), i = 0, iz = ary.length;

    for (; i < iz; ++i) {
        fn(ary[i], i) && rv.push(ary[i]);
    }
    return rv;
}

function Array_flatten() { // @ret DenseArray: flat new array
                           // @desc: array flatten `` ネストしている配列を展開し、フラットな新しい配列を返します
                           // @help: Array#flatten
    function _recursiveExpand(ary) {
        var i = 0, iz = ary.length, value;

        for (; i < iz; ++i) {
            if (i in ary) {
                value = ary[i];
                Array.isArray(value) ? _recursiveExpand(value) // recursive call
                                     : rv.push(value);
            }
        }
    }

    var rv = [];

    _recursiveExpand(this);
    return rv;
}

// --- String ----------------------------------------------
function String_trims(chr) { // @arg String: trim char
                             // @ret String: trimed string
                             // @help: String#trims
                             // @desc: trim both all spaces and strip all characters
                             //   `` trim()を行い、文字列の両端からchrを全て除去します
//{@assert
    mm.allow(chr, "String");
//}@assert

    var esc = RegExp.esc(chr);

    return this.trim().replace(RegExp("^" + esc + "+"), "").
                       replace(RegExp(esc + "+" + "$"), "");
}

function String_trimTag() { // @ret String:
                            // @help: String#trimTag
                            // @desc: trim both spaces and strip HTML tags
                            //   `` trim()を行い、HTMLタグ("<...>", "</...>")を全て削除します
    return this.trim().replace(/<\/?[^>]+>/g, "");
}

function String_trimQuote() { // @ret String: trimed string
                              // @help: String#trimQuote
                              // @desc: trim both spaces and strip single/double quotes
                              //    `` trim()を行い、両端からダブルクォート/シングルクォートを削除します。
                              //       削除するのは対応がとれているクォートだけです
    var str = this.trim(), m = /^["']/.exec(str);

    if (m) {
        m = RegExp(m[0] + "$").exec(str);
        if (m) {
            return str.trims(m[0]);
        }
    }
    return str;
}

function String_insert(str,     // @arg String:
                       index) { // @arg Integer(= 0):
                                // @ret String:
                                // @help: String#insert
                                // @desc: insert string
//{@assert
    mm.allow(str,   "String");
    mm.allow(index, "Integer/undefined");
//}@assert

    index = index || 0;

    var leftSide  = this.slice(0, index),
        rightSide = this.slice(index);

    return leftSide + str + rightSide;
}

function String_remove(str,     // @arg String:
                       index) { // @arg Integer(= 0):
                                // @ret String:
                                // @help: String#remove
                                // @desc: remove string
//{@assert
    mm.allow(str,   "String");
    mm.allow(index, "Integer/undefined");
//}@assert

    if (str) {
        index = this.indexOf(str, index || 0);
        if (index >= 0) {
            return this.slice(0, index) + this.slice(index + str.length);
        }
    }
    return this + "";
}

function String_unpack(glue,    // @arg String(= ":"):
                       joint) { // @arg String(= ";"):
                                // @ret Hash:
                                // @help: String#unpack
    return Hash.unpack(this + "", glue, joint);
}

function String_at(ooo) { // @var_args Mix: replace values
                          // @ret String: "@@:@@".at(1,2) -> "1:2"
                          // @help: String#at
                          // @desc: search for "@@", replace the argument
    var i = 0, args = arguments;

    return this.replace(/@@/g, function() {
        return args[i++];
    });
}

function String_up(index) { // @arg Integer(= undefined): position. allow negative index
                            //                            undefined equals this.toUpperCase()
                            // @ret String:
                            // @help: String#up
                            // @desc: String#toUpperCase(index)
//{@assert
    mm.allow(index, "Integer/undefined");
//}@assert
    if (index) {
        // calc negative index
        index = index < 0 ? this.length + index : index;
        if (index in this) {
            return this.slice(0, index) + this[index].toUpperCase() +
                   this.slice(index + 1);
        }
    }
    return this.toUpperCase();
}

function String_low(index) { // @arg Integer(= undefined): position. allow negative index
                             //                            undefined equals this.toLowerCase()
                             // @ret String:
                             // @help: String#low
                             // @desc: String#toLowerCase(index)
//{@assert
    mm.allow(index, "Integer/undefined");
//}@assert
    if (index) {
        // calc negative index
        index = index < 0 ? this.length + index : index;
        if (index in this) {
            return this.slice(0, index) + this[index].toLowerCase() +
                   this.slice(index + 1);
        }
    }
    return this.toLowerCase();
}

function String_has(find,      // @arg String: character(s) `` 比較対象の文字(列)です
                    anagram) { // @arg Boolean(= false): true is anagram search
                               // @ret Boolean:
                               // @help: String#has
                               // @desc: String has character(s) and ignore-case matching
                               //        `` 文字列が文字(列)を含んでいる場合に true を返します。
                               //           anagram が true なら順番を無視して検索します。
//{@assert
    mm.allow(find,    "String");
    mm.allow(anagram, "Boolean/undefined");
//}@assert

    if (anagram) {
        if (this.length < find.length) {
            return false;
        }

        var chr, a = this.count(), b = find.count();

        for (chr in b) {
            if (!a[chr] || a[chr] < b[chr]) {
                return false;
            }
        }
        return true;
    }
    return this.indexOf(find) >= 0;
}

function String_isURL(isRelative) { // @arg Boolean(= false):
                                    // @ret Boolean:
                                    // @desc: is absolute url or relative url
                                    // @help: String#isURL
    if (isRelative) {
        return RegExp.URL.test("http://a.a/" + this.replace(/^\/+/, ""));
    }
    return /^(https?|wss?):/.test(this) ? RegExp.URL.test(this)
                                        : RegExp.FILE.test(this);
}

function String_count(find) { // @arg String(= ""): find character.
                              // @ret Integer/Object: count or { char: count, ... }
                              // @help: String#count
                              // @desc: count the number of character
//{@assert
    mm.allow(find, "String/undefined");
    mm.deny(find,  find && find.length > 1);
//}@assert

    var rv = {}, c, ary = this.split(""), i = 0, iz = ary.length;

    for (; i < iz; ++i) {
        c = ary[i];
        rv[c] ? ++rv[c] : (rv[c] = 1);
    }
    return find ? (rv[find] || 0) : rv;
}

function String_numbers(joint) { // @arg String(= ","):
                                 // @ret NumberArray:
                                 // @help: String#numbers
                                 // @desc: to number array
//{@assert
    mm.allow(joint, "String/undefined");
//}@assert

    return this.trim().split(joint || ",").map(parseFloat).clean("number");
}

function String_format(ooo) { // @var_args Mix: sprintf format
                              // @ret String:
                              // @help: String#format
                              // @desc: format `` 文字列をフォーマットします
    var next = 0, index = 0, args = arguments;

    return this.replace(
                /%(?:(\d+)\$)?(#|0| )?(\d+)?(?:\.(\d+))?(l)?([%iduoxXfcs])/g, _parse);
                //   ~~~~~    ~~~~~~~ ~~~~~      ~~~~~      ~~~~~~~~~~~~~~
                //  argIndex   flag   width    precision        types
                //
    function _parse(_,        // @arg String: dummy
                    argIndex, // @arg String: matched arg index
                    flag,     // @arg String: flag (#|0| )
                    width,    // @arg String: width
                    prec,     // @arg String: precision
                    size,     // @arg String: dummy
                    types) {  // @arg String: types (%|i|d|u|o|x|X|f|c|s)

        if (types === "%") { // escape "%%" -> "%"
            return types;
        }
        index = argIndex ? parseInt(argIndex) : next++;

        // 0x0001: parse int        (%i, %d, %u, %o, %x, %X)
        // 0x0002: parse float      (%f)
        // 0x0004: to string        (%s)
        // 0x0010: negative padding control (%i, %d, %f)
        // 0x0020: to unsinged      (%u, %o, %x, %X)
        // 0x0040: add prefix       (%o -> "0", %x -> "0x", %X -> "0x")
        // 0x0080: precision        (%f, %s)
        // 0x0100: to octet         (%o)
        // 0x0200: to hex           (%x, %X)
        // 0x0800: padding          (%c)
        // 0x1000: to upper case    (%X)
        // 0x2000: get char         (%c)
        // 0x4000: check overflow   (%c)
        var BITS = {
                i: 0x0011, // "%i" padding + to int
                d: 0x0011, // "%d" padding + to int
                u: 0x0021, // "%u" padding + to unsinged
                o: 0x0161, // "%o" padding + to octet + to unsigned + add prefix("0")
                x: 0x0261, // "%x" padding + to hex   + to unsigned + add prefix("0")
                X: 0x1261, // "%X" padding + to upper case + to hex + to unsigned + add prefix("0")
                f: 0x0092, // "%f" precision + padding + to float
                c: 0x6800, // "%c" get first char + padding
                s: 0x0084  // "%s" precision + to string
            },
            bits = BITS[types], overflow, pad,
            rv = (args[index] === void 0) ? "" : args[index];

        bits & 0x0001 && (rv = parseInt(rv));
        bits & 0x0002 && (rv = parseFloat(rv));
        bits & 0x0003 && (rv = rv === rv ? rv : ""); // isNaN
        bits & 0x0004 && (rv = ((types === "s" ? rv : types) || "").toString());
        bits & 0x0020 && (rv = rv >= 0 ? rv : rv % 0x100000000 + 0x100000000);
        bits & 0x0300 && (rv = rv.toString(bits & 0x100 ? 8 : 16));
        bits & 0x0040 && flag === "#" && (rv = (bits & 0x100 ? "0" : "0x") + rv);
        bits & 0x0080 && prec && (rv = bits & 2 ? rv.toFixed(prec)
                                                : rv.slice(0, prec));
        bits & 0x6000 && (overflow = (typeof rv !== "number" || rv < 0));
        bits & 0x2000 && (rv = overflow ? "" : String.fromCharCode(rv));

        rv = bits & 0x1000 ? rv.toString().toUpperCase()
                           : rv.toString();
        // padding
        if (!(bits & 0x0800 || width === void 0 || rv.length >= width)) {
            pad = ((!flag || flag === "#") ? " " : flag).repeat(width - rv.length);
            rv  = ((bits & 0x0010 && flag === "0") && !rv.indexOf("-")) ?
                        "-" + pad + rv.slice(1) :
                        pad + rv;
        }
        return rv;
    }
}

function String_unique() { // @ret String:
                           // @help: String#unique
                           // @desc: remove duplicate characters

    return this.split("").unique().join("");
}

function String_code(code) { // @arg String(= "byte"): "byte", "utf8", "utf16"
                             // @ret CodedArray: [mix, ...] + { code: String }
                             // @help: String#code
                             // @desc: convert String to CodedArray
//{@assert
    mm.allow(code, ["", "byte", "utf8", "utf16"].has(code.toLowerCase()));
//}@assert

    var rv = [];

    rv.code = (code || "byte").toLowerCase();

    switch (rv.code) {
    case "byte":  return _String_toByteArray(rv, this, 0xff);
    case "utf8":  return _String_toUTF8Array(rv, this);
    case "utf16": return _String_toByteArray(rv, this, 0x1fffff);
    }
    return rv;
}

function _String_toByteArray(rv,       // @arg Array:
                             data,     // @arg String:
                             filter) { // @arg Integer:
                                       // @inner: String to ByteArray
    var i = 0, iz = data.length;

    for (; i < iz; ++i) {
        rv[i] = data.charCodeAt(i) & filter;
    }
    return rv;
}

function _String_toUTF8Array(rv,     // @arg Array:
                             data) { // @arg String:
                                     // @ret UTF8IntegerArray: [UTF8Integer, ...]
                                     // @inner: String to UTF8IntegerArray
    // RFC3629 - UTF-8, a transformation format of ISO 10646 -
    // +------------------+-------------------+-----------+-----------+-----------+-----------+
    // | Code             | Representation    | 1st byte  | 2nd byte  | 3rd byte  | 4th byte  |
    // +------------------+-------------------+-----------+-----------+-----------+-----------+
    // | 0x0000 -  0x007F | 00000000 0zzzzzzz | 0zzz zzzz |           |           |           |
    // +------------------+-------------------+-----------+-----------+-----------+-----------+
    // | 0x0080 -  0x07FF | 00000yyy yyzzzzzz | 110y yyyy | 10zz zzzz |           |           |
    // +------------------+-------------------+-----------+-----------+-----------+-----------+
    // | 0x0800 -  0xD7FF | xxxxyyyy yyzzzzzz | 1110 xxxx | 10yy yyyy | 10zz zzzz |           |
    // +------------------+-------------------+-----------+-----------+-----------+-----------+
    // | 0xD800 -  0xDBFF | 110110vv vvwwwwxx | 1111 0uuu | 10uu wwww | 10xx yyyy | 10zz zzzz |
    // |                  | 110111yy yyzzzzzz |           |           |           |           |
    // +------------------+-------------------+-----------+-----------+-----------+-----------+
    // | 0xE000 -  0xFFFF | xxxxyyyy yyzzzzzz | 1110 xxxx | 10yy yyyy | 10zz zzzz |           |
    // +------------------+-------------------+-----------+-----------+-----------+-----------+
    // |0x10000 -0x10FFFF | 00000000 000xxxyy | 1111 0xxx | 10yy yyyy | 10zz zzzz | 10ww wwww |
    // |                  | yyyyzzzz zzwwwwww |           |           |           |           |
    // +------------------+-------------------+-----------+-----------+-----------+-----------+
    var i = 0, iz = data.length, c = 0, next, u;

    for (; i < iz; ++i) {
        c = data.charCodeAt(i);
        if (c < 0x80) { // 1 byte
            rv.push(c);
        } else if (c < 0x0800) { // 2 bytes
            rv.push(c >>>  6 & 0x1f | 0xc0, c        & 0x3f | 0x80);
        } else if (c >= 0xD800 && c <= 0xE000) { // 4bytes
            next = data.charCodeAt(i + 1);
            if (next >= 0xDC00 && next <= 0xDFFF) {
                u = (c >>> 6 & 0x0f) + 1;
                rv.push( u >>> 2 & 0x07 | 0xf0,
                        (u  << 4 & 0x30 | 0x80) |    c >>> 2 & 0xf,
                        (c  << 4 & 0x30 | 0x80) | next >>> 6 & 0xf,
                            next & 0x3f | 0x80);
            } else {
                throw new URIError("BAD_ARG");
            }
        } else if (c < 0x10000) { // 3 bytes
            rv.push(c >>> 12 & 0x0f | 0xe0, c >>>  6 & 0x3f | 0x80,
                                            c        & 0x3f | 0x80);
        } else if (c < 0x110000) { // 4 bytes
            rv.push(c >>> 18 & 0x07 | 0xf0, c >>> 12 & 0x3f | 0x80,
                    c >>>  6 & 0x3f | 0x80, c        & 0x3f | 0x80);
        }
    }
    return rv;
}

function String_overflow(maxLength, // @arg Integer:         `` 文字列の最大長を指定します
                         omit) {    // @arg String(= "..."): `` 省略記号の指定です。省略可能です
                                    // @ret String:         `` 加工後の文字列を返します
                                    // @help: String#overflow
                                    // @desc: overflow string `` 最大長以下になるように文字列を切り落とし省略した事をしめす"..."を末尾に追加します
//{@assert
    mm.allow(maxLength, "Integer");
    mm.allow(omit,      "String/undefined");
//}@assert

    omit = (omit || "...");
    var omitLength = omit.length;

    if (this.length > maxLength) {
        if (maxLength - omitLength < 1) {
            return omit.slice(0, maxLength);
        }
        return this.slice(0, maxLength - omitLength) + omit;
    }
    return "" + this;
}

function Number_to(end,            // @arg Integer: end number `` 終了番号を数値で指定します。filterが1ならendで指定した終了番号を含みます
                   filterOrStep) { // @arg Function/Integer(= 1): filter function or step number
                                   // @ret Array: [begin, ... end]
                                   // @this: begin number
                                   // @help: Number#to
                                   // @desc: create number array `` 数値の配列を作成します
                                   // @throw: Error("BAD_ARG")
//{@assert
    mm.allow(end,          "Integer");
    mm.allow(filterOrStep, "Function/Integer/undefined");
//}@assert

    var rv = [], begin = this | 0, reverse = begin > end,
        i  = (reverse ? end : begin) | 0,
        iz = (reverse ? begin : end) | 0,
        type = typeof filterOrStep,
        step = 1;

    if (type === "function") {
        for (; i <= iz; ++i) {
            filterOrStep(i) && rv.push(i);
        }
    } else {
        if (type === "number") {
            step = filterOrStep | 0;
        }
        if (step < 1 || end >= 0x7FFFFFFF) {
            throw new Error("BAD_ARG");
        }
        for (; i <= iz; i += step) {
            rv.push(i);
        }
    }
    return reverse ? rv.reverse() : rv;
}

function Number_pad(digits,  // @arg Integer(= 2): digits. 1 - 32
                    radix) { // @arg Integer(= 10): radix. 2 - 36
                             // @ret String:
                             // @help: Number#pad
                             // @desc: to uint32 and pad zero
//{@assert
    mm.allow(digits, "Integer/undefined");
    mm.allow(radix,  "Integer/undefined");
    mm.deny(digits, digits && (digits < 1 || digits > 32));
    mm.deny(radix,  radix  && (radix  < 2 || radix  > 36));
//}@assert

    digits = digits || 2;
    radix  = radix  || 10;

    var num = Math.abs(+this) >>> 0;

    // 0..pad() -> "00"
    // 9..pad() -> "09"
    // (-11.1).pad(4) -> "0011"
    if (digits === 2 && radix === 10 && num < 100) {
        return num < 10 ? "0" + num : "" + num;
    }
    return ("00000000000000000000000000000000" +
            num.toString(radix)).slice(-digits);
}

function Number_xor(value) { // @arg Integer:
                             // @ret Integer:
                             // @help: Number#xor
                             // @desc: 32bit xor value
//{@assert
    mm.allow(value, "Integer/undefined");
//}@assert

    return (this ^ value) >>> 0; // to uint32
}

function Number_wait(fn_that, // @arg Function/Array: callback or [that, callback]
                     ooo) {   // @var_args Mix(= undefined): callback.apply(that, var_args)
                              // @this Number: delay seconds
                              // @ret Integer: atom (setTimeout timer id)
                              // @help: Number#wait
                              // @desc: lazy evaluate `` 関数を遅延評価します
//{@assert
    mm.allow(fn_that, "Function/Array");
    if (Array.isArray(fn_that)) {
        if (typeof fn_that[1] !== "function" || fn_that.length !== 2) {
            throw new Error("BAD_ARG");
        }
    }
//}@assert

    var that = fn_that[0] || null,
        fn   = fn_that[1] || fn_that,
        args = Array.prototype.slice.call(arguments, 1);

    return setTimeout(function() {
                fn.apply(that, args);
            }, this * 1000);
}

function Number_times(fn_that, // @arg Function/Array: callback or [that, callback]
                      ooo) {   // @var_args Mix(= undefined): callback.apply(that, var_args, call_count)
                               // @ret ResultMixArray: iterator results `` コールバック関数の戻り値を配列で返します
                               // @help: Number#times
                               // @desc: n times iterator function `` 関数を数回呼び出し、結果を配列で返します
//{@assert
    mm.allow(fn_that, "Function/Array");
    if (Array.isArray(fn_that)) {
        if (typeof fn_that[1] !== "function" || fn_that.length !== 2) {
            throw new Error("BAD_ARG");
        }
    }
//}@assert

    var rv   = [],
        that = fn_that[0] || null,
        fn   = fn_that[1] || fn_that,
        args = Array.prototype.slice.call(arguments, 1),
        i = 0, iz = +this | 0,
        fn_args = args ? args.concat() : [],
        fn_args_last = fn_args.length;

    if (iz > 0) {
        for (; i < iz; ++i) {
            fn_args[fn_args_last] = i; // add/update index
            rv.push(fn.apply(that, fn_args));
        }
    }
    return rv;
}

function Number_clamp(low,    // @arg Number: low numeric value
                      high) { // @arg Number: high numeric value
                              // @ret Number: clamped value
                              // @desc: to clamp numeric elements `` 値をlowからhightの範囲に制限します
                              // @help: Number#clamp
//{@assert
    mm.allow(low,  "Number");
    mm.allow(high, "Number");
//}@assert

    var num = +this, swap;

    // swap low <-> high
    if (low > high) {
        swap = [high, low];
        low  = swap[0];
        high = swap[1];
    }
    return num < low  ? low  :
           num > high ? high : num;
}

function Number_toRadians() { // @ret Number: radians value
                              // @help Number#toRadians
                              // @desc: Degree to Radian
    return this * Math.PI / 180;
}

function Number_toDegrees() { // @ret Number: degrees value
                              // @help Number#toDegrees
                              // @desc: Radian to Degree
    return this * 180 / Math.PI;
}

function Number_chr() { // @ret String:
                        // @help: Number#chr
                        // @desc: convert char code to String
    return String.fromCharCode(this);
}

function Number_rand() { // @ret Integer/Number:
                         // @help: Number#rand
                         // @desc: create random number
    var num = +this;

    return num ? (Math.random() * num) | 0 // 10..rand() -> from 0   to 10 (integer)
               :  Math.random();           //  0..rand() -> from 0.0 to 1.0 (number)
}

function Function_help(that) { // @arg this:
                               // @help: Function#help
                               // @desc: show help url
    that = that || this;
    var url = _getHelpURL(that);

    return url + "\n\n" + that + "\n\n" + url;
}

function Function_help_add(url,    // @arg URLString: help url string
                           word) { // @arg StringArray/RegExp: keywords or pattern
                                   // @desc: add help chain
//{@assert
    mm.allow(url,  "String");
    mm.allow(word, "Array/RegExp");
//}@assert

    if (Array.isArray(word)) {
        word = RegExp("^(" + word.join("|") + ")(?:([#\\.])([\\w\\,]+))?$");
    }

    Function_help_add._db.push(word, function(rex, index, param) {
        var m = rex.exec(param),
            dotfn = "@@@@#@@.@@",
            proto = "@@@@#@@.prototype.@@";

        if (!m) { return false; }
        return !m[2] ? "@@@@".at(url, m[1])
             : m[2] === "." ? dotfn.at(url, m[1], m[1], m[3])
                            : proto.at(url, m[1], m[1], m[3]);
    });
}

Function_help_add._db = [];

function _getHelpURL(fn) { // @arg Function/undefined:
                           // @inner: get help url
    var rv, help = /@help:\s*([^\n]*)\n/.exec("\n" + fn);

    if (help) {
        rv = Function_help_add._db.chain(help[1].trim());
    }
    return rv || "";
}

function Function_callby(that,  // @arg this: method this
                         ooo) { // @var_args Mix:
                                // @ret Mix:
                                // @help: Function#callby
                                // @desc: method call, expand the Arguments object
    var ary = [], args = arguments, i = 1, iz = args.length;

    for (; i < iz; ++i) {
        if (mm_type(args[i]) === "list") {
            Array.prototype.push.apply(ary, mm_cast_list(args[i]));
        } else {
            ary.push( args[i] );
        }
    }
    return this.apply(that, ary);
}

function Function_nickname(defaultName) { // @arg String(= ""): default nickname
                                          // @ret String: function name
                                          // @help: Function#nickname
                                          // @desc: get function name
//{@assert
    mm.allow(defaultName, "String/undefined");
//}@assert
    var name = this.name || (this + "").split("(")[0].trim().slice(9); // )

    return name ? name.replace(/^mm_/, "mm.") // mm_like -> mm.like
                : defaultName; // [IE][Opera<11]
}

function RegExp_esc(str) { // @arg String:
                           // @ret EscapedString:
                           // @help: RegExp.esc
//{@assert
    mm.allow(str, "String");
//}@assert
    return str.replace(/([.*+?^=!:${}()|[\]\/\\])/g, "\\$1");
}

function RegExp_flag(command) { // @arg String(= ""): ""(clear). "+g"(add), "-g"(remove)
                                // @ret RegExp: new RegExp Object
                                // @help: RegExp#flag
                                // @desc: add/remove/clear RegExp flag
//{@assert
    mm.allow(command, "String/undefined");
//}@assert
    var flag = (this + "").slice(this.source.length + 2);

    if (!command) { // flag() -> clear
        flag = "";
    } else if (command[0] === "-") { // flag("-img") -> remove
        command.slice(1).split("").each(function(f) {
            flag = flag.remove(f);
        });
    } else { // flag("+img") -> add
        flag = (flag + command.trims("+")).unique();
    }
    return RegExp(this.source, flag);
}

// --- Await -----------------------------------------------
function Function_await(waits,  // @arg Integer: wait count
                        tick) { // @arg Function(= undefined): tick callback({ ok, args, state })
                                // @ret AwaitInstance:
                                // @this: callback function. callback(result)
                                //    result - Object: { ok, args, state }
                                //      ok - Boolean: true is result.state === 200
                                //      args - Array: pass(arg) and miss(arg) args collections
                                //      state - Integer: 200(success), 400(error)
                                // @help: Await#await
                                // @desc: create Await instance
//{@assert
    mm.allow(waits, "Integer");
    mm.allow(tick,  "Function/undefined");
    if (waits < 1) { throw new Error("BAD_ARG"); }
//}@assert

    return new Await(this, waits, tick);
}

function Await_missable(missables) { // @arg Integer:
//{@assert
    mm.allow(missables, "Integer");
    if (missables < 0 || missables >= this._db.waits) {
        throw new Error("BAD_ARG");
    }
//}@assert
    this._db.missables = missables;
    return this;
}

function Await_pass(value) { // @arg Mix(= undefined): value
                             // @ret this:
                             // @help: Await#pass
                             // @desc: pass a process
    ++this._db.pass;
    this._db.args.push(value);
    _Await_next(this._db);
    return this;
}

function Await_miss(value) { // @arg Mix(= undefined): value
                             // @ret this:
                             // @help: Await#miss
                             // @desc: miss a process
    ++this._db.miss;
    this._db.args.push(value);
    _Await_next(this._db);
    return this;
}

function _Await_next(db) {
    if (db.state === 100) {
        db.state = db.miss > db.missables ? 400        // `` miss が missables を超えて呼ばれている -> 失敗
                 : db.pass + db.miss >= db.waits ? 200 // `` pass + miss が waits 以上呼ばれている -> 成功
                 : db.state;
    }
    db.tick && db.tick({ ok: db.state === 200, args: db.args, state: db.state }); // tick callback

    if (db.state > 100) { // change state?
        if (db.fn) {
            db.fn({ ok: db.state === 200, args: db.args, state: db.state }); // end callback
            db.fn = db.tick = null;
            db.args = []; // gc
        }
    }
}

function Await_state() { // @ret Integer: current state,
                         //                 100 is continue,
                         //                 200 is success,
                         //                 400 is error
                         // @help: Await#state
                         // @desc: get current state
    return this._db.state;
}

// --- test ----------------------------------------------
function Array_test(label, // @arg String(= ""): label
                    arg) { // @arg Mix(= undefined): test arg
                           // @this: test case
                           // @help: Array#test
                           // @desc: unit test
//{@assert
    mm.allow(label, "String/undefined");
//}@assert

    if (!this.length) { return; }

    var nicknames = _enumNicknames(this.clean()), // { object, array }
        plan, group, param;

    plan = _streamTokenizer( nicknames.array.join(" > ") ); // [ ["fn1"], ["fn2", "fn3"] ]
    group = plan.shift();
    param = mm.mix(nicknames.object, { arg: arg, pass: 0, miss: 0,
                                       logg: mm_logg(label || "") });

    group && _recursiveTestCase( plan, group, param );
}

function _recursiveTestCase(plan,    // @arg StringArrayArray: [[fn1, fn2, ...], [fn3, ...]]
                            group,   // @arg Array: group
                            param) { // @arg FunctionObject: { init, fin, fn1, ... }
                                     // @throw: TypeError("ARGUMENT_IS_MISSING")
                                     //         TypeError("BAD_TYPE")
                                     // @inner: do test
    var i = 0, iz = group.length;

    group.each(function(action) { // @param String: command string. "fn1"

        var lval, rval, // left-value, right-value
            jrv, // judge function result value
            jfn, // judge function name
            msg;

        switch (mm.type(param[action])) {
        case "array": // [ left-values, right-value, override-judge-function ]
            try {
                lval = param[action][0];
                rval = param[action][1];
                jfn = param[action][2] || mm.like;
                jrv = jfn(lval, rval);
                msg = "= @@( @@ )".at( jfn.nickname(),
                                       mm_dump(lval, 0) + ", " +
                                       mm_dump(rval, 0) );
            } catch (O_o) {
                msg = O_o + "";
            }
            _callback( jrv, msg);
            break;
        case "boolean":
            _callback( param[action] );
            break;
        case "function": // function -> sync or async lazy evaluation
                         //
                         // sync_ok: function() { return true; }
                         // sync_ng: function() { return false; }
                         // async_ok: function(callback) { 1..wait(callback); }
                         // async_ok: function(callback) { 1..wait(function() { return true; }); }
                         // async_err: function() { 1..wait(callback); } -> "ARGUMENT_IS_MISSING"
            jrv = param[action](_callback);

            if (jrv === false || // sync_ng
                jrv === true) {  // sync_ok
                _callback(jrv);
                break;
            } else if (jrv === void 0 && !param[action].length) { // function.argument.length is 0
                debugger;
                throw new TypeError("ARGUMENT_IS_MISSING: " + action);
            }
            break;
        default:
            debugger;
            throw new TypeError("BAD_TYPE: " + action);
        }

        // inner -
        function _callback(result, // @arg Boolean:
                           msg) {  // @arg String(= ""): log message
                                   // @lookup: param, action, i, iz
            var miss = result === false, nextAction, arg;

            miss ? param.logg.error(action + ":", result, msg)
                 : param.logg(action + ":", result, msg);
            miss ? ++param.miss
                 : ++param.pass;


            // Array#test.tick の戻り値が false ならテストを中断する
            if (typeof Array_test.tick === "function") {
                arg = {
                    ok:   !miss,
                    msg:  msg    || "",
                    name: action || "",
                    pass: param.pass,
                    miss: param.miss
                };
                if (Array_test.tick(arg) === false) {
                    return;
                }
            }
            if (++i >= iz) {
                nextAction = plan.shift();
                nextAction ? _recursiveTestCase( plan, nextAction, param )
                           : param.logg.out(); // end of action
            }
        }
    });
}

function _enumNicknames(ary) { // @arg FunctionArray/MixArray:
                               // @ret Object: { array, object }
                               //        array - Array: [ nickname, key, ... ]
                               //        object - Object: { nickname: function, ... key: value ... }
                               // @desc: enum function nickname from Array
                               // @inner: enum nicknames
    var rv = { object: {}, array: [] }, i = 0, iz = ary.length, key;

    for (; i < iz; ++i) {
        key = typeof ary[i] === "function" ? ary[i].nickname("" + i)
                                           : "" + i;
        rv.object[key] = ary[i];
        rv.array.push(key);
    }
    return rv;
}

function _streamTokenizer(command) { // @arg String: command string. "a>b+c>d>foo"
                                     // @ret ArrayArrayString: exec plan. [ ["a"], ["b", "c"], ["d"], ["foo"] ]
                                     //                                     ~~~~~  ~~~~~~~~~~  ~~~~~  ~~~~~~~
                                     //                                     group   group       group  group
                                     //
                                     //     b+c is parallel execution
                                     // String#stream に存在する alias "d:a1" パース機能を削除
                                     // @inner: stream DSL tokenizer
    var plan = [], remain = [];

    command.match(/([\w\-\u00C0-\uFFEE]+|[/+>])/g).each(function(token) {
        token === "+" ? 0 :
        token === ">" ? (remain.length && plan.push(remain.shifts())) // Array#shifts
                      : remain.push(token);
    });
    remain.length && plan.push(remain.concat());
    return plan;
}

/*
            command
        _________________
        "fn1 > fn2 + fn3".stream({ ... })
               v
        _streamTokenizer(command)
               v
              plan
    ________________________________
    [ [ "fn1" ],  [ "fn2", "fn3" ] ]
        ~~~~~     ~~~~~~~~~~~~~~~~
        action         group (parallel execution group)

 */

// Array#stream
function Array_stream() { // @this - FunctionArray
                          // @ret Object: { uid: number, halt: function }
                          // @help: Array#stream
                          // @desc: create Stream
    return _enumNicknames(this).array.join(" > ").stream(this);
}

// String#stream
function String_stream(methods) { // @arg Object/Array: { fn, ... } or [ fn, ... ]
                                  // @ret Object: { uid: number, halt: function }
                                  // @this: command. "fn1 > fn2 + fn3"
                                  // @throw Error("NEED_RETURN")
                                  // @desc: create Stream
                                  // @help: String#stream
//{@assert
    mm.allow(methods, "Object/Array/undefined");
//}@assert

    function halt() {
        String_stream._halt[uid] = 1; // halt switch
        methods.halted = true;
        methods.halt && methods.halt("halt");
    }

    var plan = _streamTokenizer(this), // plan: [ [ "fn1" ],  [ "fn2", "fn3" ] ]
        uid = mm.uid("stream");

    methods = Array.isArray(methods) ? _enumNicknames(methods).object
                                     : methods;

    String_stream._halt[uid] = 0;

    plan.length && _stream(plan, methods, uid);

    return { uid: uid, halt: halt };
}
String_stream._halt = {};

// inner - exec stream functions
function _stream(plan,    // @arg StringArrayArray: [[fn1, fn2, ...], [fn3, ...]]
                 methods, // @arg Object: { init, fin, halt, fn1, ... }
                 uid) {   // @arg Number: unique id
                          // @throw Error("NEED_RETURN")
    if (!String_stream._halt[uid]) { // halted?
        var group = plan.shift();

        group && _nextStream( plan, group, methods, uid );
    }
}

// inner - next stream plan
function _nextStream(plan,    // @arg StringArrayArray: [[fn1, fn2, ...], [fn3, ...]]
                     group,   // @arg Array: parallel execution group. [action, ...]
                     methods, // @arg Object: { init, fin, halt, fn1, ... }
                     uid) {   // @arg Number: unique id
                              // @throw Error("NEED_RETURN")

    var i = 0, iz = group.length, halt = 0;

    group.each(function(action) { // @param String: command string. "fn1"
        if (isFinite(action)) { // "... > 1000 > ..." -> delay 1000ms

            setTimeout(function() {
                _judge(true);
            }, +action);

        } else {
            // function -> sync or async lazy evaluation
            var r = methods[action](_judge);

            if (r === false || r === true) {
                _judge(r);
            } else if (r === void 0 && methods[action].length < 1) { // fn(no-arg) { no-return }
                throw new Error("NEED_RETURN: " + action);
            }
        }

        function _judge(result) { // @param Boolean:
            if (!halt) {
                if (result === false) {
                    methods.halted = !!++halt;
                    methods.halt && methods.halt(action);
                } else if (++i >= iz) {
                    _stream(plan, methods, uid); // recursive call
                }
            }
        }
    });
}

// --- Object ----------------------------------------------
function Object_has(spec,   // @arg Object/Function:
                    find) { // @arg Object: { key: value, ... }
                            // @ret Boolean:
    var key, keys = Object.keys(find), i = 0, iz = keys.length;

    for (; i < iz; ++i) { // uupaa-looper
        key = keys[i];
        if (!(key in spec) || !Object_like( spec[key], find[key] )) {
            return false;
        }
    }
    return true;
}

function Object_like(lval,   // @arg Mix: left value
                     rval) { // @arg Mix: right value
                             // @ret Boolean: true is like value and like structures
                             // @inner: Like and deep matching.
                             //         This function does not search inside the prototype chain of the object.
    var ltype = mm_type(lval),
        rtype = mm_type(rval),
        alike = { string: 1, date: 1, list: 2, array: 2, object: 3, Hash: 3 };

    if (ltype !== rtype) {
        if (alike[ltype] &&
            alike[ltype] === alike[rtype]) {
            if (rtype === "string" || rtype === "list" || rtype === "Hash") {
                return Object_like(lval, mm_cast(rval));
            }
            return Object_like(mm_cast(lval), rval);
        }
        return false;
    }
    switch (ltype) {
    case "list":    return mm_cast_list(lval) + "" === mm_cast_list(rval) + "";
    case "array":   return lval + "" === rval + "";
    case "regexp":  return lval.source === rval.source;
    case "object":  return ((Object.keys(lval).length === Object.keys(rval).length) &&
                           Object_has(lval, rval));
    case "number":  return isNaN(lval) && isNaN(rval) ? true : lval === rval;
    }
    return (lval && lval.toJSON) ? lval.toJSON() === rval.toJSON()
                                 : lval === rval;
}

function Object_map(obj,  // @arg Object/Function:
                    fn) { // @arg Function: callback function
                          // @ret Array: [result, ...]
    var rv = [], key, keys = Object.keys(obj), i = 0, iz = keys.length;

    for (; i < iz; ++i) { // uupaa-looper
        key = keys[i];
        rv.push( fn(obj[key], key) );
    }
    return rv;
}

function Object_each(obj,  // @arg Object/Function:
                     fn) { // @arg Function: callback function
    var key, keys = Object.keys(obj), i = 0, iz = keys.length;

    for (; i < iz; ++i) { // uupaa-looper
        key = keys[i];
        fn(obj[key], key);
    }
}

function Object_some(obj,  // @arg Object/Function:
                     fn) { // @arg Function: fn(value, key)
                           // @ret Boolean:
    var key, keys = Object.keys(obj), i = 0, iz = keys.length;

    for (; i < iz; ++i) { // uupaa-looper
        key = keys[i];
        if ( fn(obj[key], key) ) {
            return true;
        }
    }
    return false;
}

function Object_every(obj,  // @arg Object/Function:
                      fn) { // @arg Function: fn(value, key)
                            // @ret Boolean:
    var key, keys = Object.keys(obj), i = 0, iz = keys.length;

    for (; i < iz; ++i) { // uupaa-looper
        key = keys[i];
        if ( !fn(obj[key], key) ) {
            return false;
        }
    }
    return true;
}

function Object_match(obj,  // @arg Object/Function:
                      fn) { // @arg Function: fn(value, key)
                            // @ret Mix/undefined:
    var key, keys = Object.keys(obj), i = 0, iz = keys.length;

    for (; i < iz; ++i) { // uupaa-looper
        key = keys[i];
        if ( fn(obj[key], key) ) {
            return obj[key];
        }
    }
    return;
}

function Object_clean(data,           // @arg Object/Function:
                      typeofFilter) { // @arg String(= ""): typeof filter
                                      // @ret DenseObject: new Object
                                      // @desc: convert sparse object to dense object, trim undefined, null and NaN value
    typeofFilter = typeofFilter || "";

    var rv = {}, key, value, keys = Object.keys(data), i = 0, iz = keys.length;

    for (; i < iz; ++i) { // uupaa-looper
        key = keys[i];
        value = data[key];
        if (value === value && value != null) {
            if (!typeofFilter || typeof value === typeofFilter) {
                rv[key] = value;
            }
        }
    }
    return rv;
}

function Object_count(obj) { // @arg Object/Function/Array:
                             // @ret Object: { value: value-count, ... }
    var rv = {}, value, keys = Object.keys(obj), i = 0, iz = keys.length;

    for (; i < iz; ++i) { // uupaa-looper
        value = obj[keys[i]] + ""; // toString(value)
        rv[value] ? ++rv[value] : (rv[value] = 1);
    }
    return rv;
}

function Object_pick(obj,     // @arg Object/Function/Array:
                     names) { // @arg String/StringArray:
                              // @ret Array: [mix, ...]
    var rv = [], key, keys = Object.keys(obj), i = 0, iz = keys.length,
        child, ary = Array.toArray(names), j, jz = ary.length;

    for (; i < iz; ++i) { // uupaa-looper
        child = obj[keys[i]];

        for (j = 0; j < jz; ++j) {
            key = ary[j];
            child.hasOwnProperty(key) && rv.push( child[key] );
        }
    }
    return rv;
}

function Object_values(obj) { // @arg Object/Function/Array/Style/Node/Global:
                              // @ret Array: [value, ...]
    var rv = [], keys = Object.keys(obj), i = 0, iz = keys.length;

    for (; i < iz; ++i) { // uupaa-looper
        rv.push( obj[keys[i]] );
    }
    return rv;
}

// --- Hash ------------------------------------------------
function Hash_clean(typeofFilter) { // @arg String(= ""):
                                    // @ret Hash:
                                    // @help: Hash#clean
//{@assert
    mm.allow(typeofFilter, "String/undefined");
//}@assert
    return new Hash(Object_clean(this._, typeofFilter));
}

function Hash_pack(glue,    // @arg String(= ":"): glue
                   joint) { // @arg String(= ";"): joint
                            // @ret String: "key:value;key:value;..."
                            // @desc: serialize hash key/values ({ key: valye, ... }) to "key:value;..."
                            // @help: Hash#pack
//{@assert
    mm.allow(glue,  "String/undefined");
    mm.allow(joint, "String/undefined");
//}@assert

    glue  = glue  || ":";
    joint = joint || ";";

    var rv = [], key, keys = Object.keys(this._), i = 0, iz = keys.length;

    for (; i < iz; ++i) { // uupaa-looper
        key = keys[i];
        rv.push(key + glue + this._[key]);
    }
    return rv.join(joint);
}

function Hash_unpack(data,    // @arg String: "key:value;..."
                     glue,    // @arg String(= ":"): glue
                     joint) { // @arg String(= ";"): joint
                              // @ret Hash: mm({ key: value, ... })
                              // @help: Hash.unpack
                              // @desc: deserialize string("key:value;...") to Has({ key: value, ... })
//{@assert
    mm.allow(data,  "String");
    mm.allow(glue,  "String/undefined");
    mm.allow(joint, "String/undefined");
//}@assert

    glue  = glue  || ":";
    joint = joint || ";";

    var rv = {}, index, key, value,
        ary = data.trims(joint).split(joint), i = 0, iz = ary.length,
        primitive = {
            "": "",
            "NaN": NaN,
            "null": null,
            "true": true,
            "false": false,
            "undefined": void 0
        };

    for (; i < iz; ++i) {
        index = ary[i].indexOf(glue);
        key = index >= 0 ? ary[i].slice(0, index)
                         : ary[i];
        value = "";
        if (index >= 0) {
            value = ary[i].slice(index + 1).trim();
            value = value in primitive ? primitive[value] // primitive -> convert
                  : isFinite(value) ? parseFloat(value)   // number    -> parse float
                  : value;                                // other     -> string
        }
        rv[key.trim()] = value;
    }
    return new Hash(rv);
}

// --- env -----------------------------------------------
// http://code.google.com/p/mofmof-js/wiki/UserAgentStrings
// http://googlewebmastercentral-ja.blogspot.com/2011/05/android.html
function _detectEnv(rv) { // @inner:
    if (!global.location || !global.navigator || global.window !== global) {
        return rv;
    }
    var nav = global.navigator, ua = nav.userAgent;

    rv.lang     = (nav.language || nav.browserLanguage || "").split("-", 1)[0]; // "en-us" -> "en"
    rv.retina   = (global.devicePixelRatio || 1) >= 2;
    rv.secure   =  global.location.protocol === "https:";
//{@ie
    if (rv.ie) {
        rv.ie8  = !!document.querySelector;
        rv.ie9  = !!global.getComputedStyle;
        rv.ie10 = !!global.msSetImmediate;
    }
//}@ie
    rv.ios      = /iPhone|iPad|iPod/.test(ua);
    rv.ipad     = /iPad/.test(ua);
    rv.chrome   = /Chrome/.test(ua);
    rv.webkit   = /WebKit/.test(ua);
    rv.safari   = rv.webkit && !rv.chrome;
    rv.android  = /Android/i.test(ua);
    return rv;
}

// --- build and export API --------------------------------
if (typeof module !== "undefined") { // is modular
    module.exports = { mm: HashFactory };
}

_extendNativeObjects(mm_mix, mm_wiz);
_defineLibraryAPIs(mm_mix);
_defineHashPrototype(mm_wiz);

mm.help.add(
    "http://code.google.com/p/mofmof-js/wiki/",
    "Object,Array,String,Boolean,Number,Date,Function,mm,Class,Hash,Await,Msg".split(","));

})(this.self || global);
//{@url
(function(global) { // @arg GlobalObject: global or window

function _defineLibraryAPIs(mix) {
    mm.url = mix(mm_url, {              // mm.url(url):URLString/URLObject
        resolve:    mm_url_resolve,     // mm.url.resolve(url):URLString
        normalize:  mm_url_normalize,   // mm.url.normalize(url):URLString
        buildQuery: mm_url_buildQuery,  // mm.url.buildQuery(obj, joint="&"):URLQueryString
        parseQuery: mm_url_parseQuery   // mm.url.parseQuery(query):URLQueryObject
    });
}

// --- local vars ---

// --- impl ---
function mm_url(url) { // @arg URLObject/URLString(= ""): "https://..."
                       // @ret URLString/URLObject:
                       // @desc: url accessor
                       // @help: mm.url
//{@assert
    mm.allow(url, "Object/String/undefined");
//}@assert

    return !url ? mm_url_resolve()
         : typeof url === "string" ? _url_parse(url)
                                   : _url_build(url);
}

function mm_url_resolve(url) { // @arg URLString(= ""): relative URL or absolute URL
                               // @ret URLString: absolute URL
                               // @desc: convert relative URL to absolute URL
                               // @help: mm.url.resolve
//{@assert
    mm.allow(url, "String/undefined");

    if (!global.document) {
        throw new Error("BAD_LOCATION");
    }
//}@assert

    url = url || "";
    if (!url && global.location) {
        return global.location.href; // current URL
    }
    if (url && /^(https?|file|wss?):/.test(url)) { // is absolute url?
        return url;
    }
    // convert relative url to absolute url
    var a = global.document.createElement("a");

    a.setAttribute("href", url);    // <a href="hoge.htm">
    return a.cloneNode(false).href; // -> "http://example.com/hoge.htm"
}

function _url_build(obj) { // @arg URLObject/Object: need { protocol, host, pathname, search, fragment }
                           // @ret URLString: "{protocol}//{host}{pathname}?{search}#{fragment}"
                           // @inner: build URL

//{@assert
    mm.allow(obj, "Object");
//}@assert

    //  URL({ protocol: "http:",
    //        host:     "user:pass@example.com:8080",
    //        pathname: "/dir1/dir2/file.ext",
    //        search:   "a=b&c=d",
    //        fragment: "fragment" })
    //
    //      -> "http://user:pass@example.com:8080/dir1/dir2/file.ext?a=b&c=d#fragment"
    var slash = obj.protocol ? (obj.protocol === "file:" ? "///"
                                                         : "//") : "";

    return [obj.protocol, slash,
            obj.host     || "",
            obj.pathname || "/",
            obj.search   || "",
            obj.fragment || ""].join("");
}

function _url_parse(url) { // @arg URLString: abs or rel,
                           //                   "http://user:pass@example.com:8080/dir1/dir2/file.ext?a=b&c=d#fragment"
                           // @ret URLObject: { href, protocol, scheme, secure, host,
                           //                   auth, hostname, port, pathname, dir, file,
                           //                   search, query, fragment, ok }
                           //     href     - String: "http://user:pass@example.com:8080/dir1/dir2/file.ext?a=b;c=d#fragment"
                           //     protocol - String: "http:"
                           //     scheme   - String: "http:"
                           //     secure   - Boolean: false
                           //     host     - String: "user:pass@example.com:8080". has auth
                           //     auth     - String: "user:pass"
                           //     hostname - String: "example.com"
                           //     port     - Number: 8080
                           //     pathname - String: "/dir1/dir2/file.ext"
                           //     dir      - String: "/dir1/dir2"
                           //     file     - String: "file.ext"
                           //     search   - String: "?a=b&c=d"
                           //     query    - URLQueryObject: { a: "b", c: "d" }
                           //     fragment - String: "#fragment"
                           //     ok       - Boolean: true is valid url
                           // @inner: parse URL

    function _extends(obj) { // @arg URLObject:
                             // @ret URLObject:
        var ary = obj.pathname.split("/");

        obj.href       = obj.href     || "";
        obj.protocol   = obj.protocol || "";
        obj.scheme     = obj.protocol;        // [alias]
        obj.secure     = obj.secure   || false;
        obj.host       = obj.host     || "";
        obj.auth       = obj.auth     || "";
        obj.hostname   = obj.hostname || "";
        obj.port       = obj.port     || 0;
        obj.pathname   = obj.pathname || "";
        obj.file       = ary.pop();
        obj.dir        = ary.join("/") + "/";
        obj.search     = obj.search   || "";
        obj.query      = mm_url_parseQuery(obj.search);
        obj.fragment   = obj.fragment || "";
        obj.ok         = obj.ok       || true;
        return obj;
    }

//{@assert
    mm.allow(url, "String");
//}@assert

    var m, ports = { "http:": 80, "https": 443, "ws:": 81, "wss:": 816 };

    m = RegExp.FILE.exec(url);
    if (m) {
        return _extends({
            href:       url,
            protocol:   m[1],
            pathname:   m[2],
            search:     m[3],
            fragment:   m[4]
        });
    }

    m = RegExp.URL.exec(url);
    if (m) {
        return _extends({
            href:       url,
            protocol:   m[1],
            secure:     m[1] === "https:" || m[1] === "wss:",
            host:       m[2],
            auth:       m[3],
            hostname:   m[4],
            port:       m[5] ? +m[5] : (ports[m[1]] || 0),
            pathname:   m[6],
            search:     m[7],
            fragment:   m[8]
        });
    }

    m = RegExp.PATH.exec(url);
    if (m) {
        return _extends({
            href:       url,
            pathname:   m[1],
            search:     m[2],
            fragment:   m[3]
        });
    }
    return _extends({
        href:       url,
        pathname:   url,
        ok:         false
    });
}

function mm_url_normalize(url) { // @arg URLString:
                                 // @ret URLString:
                                 // @help: mm.url.normalize
                                 // @desc: path normalize
//{@assert
    mm.allow(url, "String");
//}@assert

    var rv = [],
        path,
        dots = /^\.+$/,
        obj  = _url_parse(url),
        dirs = obj.dir.split("/"),
        i = 0, iz = dirs.length;

    // normalize("dir/.../a.file") -> "/dir/a.file"
    // normalize("../../../../a.file") -> "/a.file"
    for (; i < iz; ++i) {
        path = dirs[i];
        if (path === "..") {
            rv.pop();
        } else if (!dots.test(path)) {
            rv.push(path);
        }
    }
    // tidy slash "///" -> "/"
    path = ("/" + rv.join("/") + "/").replace(/\/+/g, "/");

    obj.pathname = path + obj.file;
    return _url_build(obj); // rebuild
}

// mm.url.buileQuery
function mm_url_buildQuery(obj,     // @arg URLQueryObject: { key1: "a", key2: "b", key3: [0, 1] }
                           joint) { // @arg String(= "&"): joint string "&" or "&amp;" or ";"
                                    // @ret URLQueryString: "key1=a&key2=b&key3=0&key3=1"
                                    // @help: mm.url.buileQuery
                                    // @desc: build query string
//{@assert
    mm.allow(obj,   "Object");
    mm.allow(joint, "String/undefined");
//}@assert

    joint = joint || "&";

    var rv = [], i, j, jz, key, value;

    for (i in obj) {
        key   = global.encodeURIComponent(i);
        value = obj[i];

        if (Array.isArray(value)) {
            for (j = 0, jz = value.length; j < jz; ++j) {
                rv.push(key + "=" + global.encodeURIComponent(value[j])); // "key3=0;key3=1"
            }
        } else { // value is Literal
            rv.push(key + "=" + global.encodeURIComponent(value)); // "key1=a;key2=b"
        }
    }
    return rv.join(joint); // "key1=a;key2=b;key3=0;key3=1"
}

// mm.url.parseQuery
function mm_url_parseQuery(query) { // @arg URLString/URLQueryString: "key1=a;key2=b;key3=0;key3=1"
                                    // @ret URLQueryObject: { key1: "a", key2: "b", key3: ["0", "1"] }
                                    // @help: mm.url.parseQuery
                                    // @desc: parse query string
    function _parse(_, key, value) {
        var k = global.encodeURIComponent(key),
            v = global.encodeURIComponent(value);

        if (rv[k]) {
            if (Array.isArray(rv[k])) {
                rv[k].push(v);
            } else {
                rv[k] = [rv[k], v];
            }
        } else {
            rv[k] = v;
        }
        return "";
    }

//{@assert
    mm.allow(query, "String");
//}@assert

    var rv = {};

    if (query.indexOf("?") >= 0) {
        query = query.split("?")[1].split("#")[0];
    }
    query.replace(/&amp;|&|;/g, ";"). // "&amp;" or "&" or ";" -> ";"
          replace(/(?:([^\=]+)\=([^\;]+);?)/g, _parse);

    return rv;
}

// --- build and export ---
_defineLibraryAPIs(mm.mix);

})(this);
//}@url
//{@easing
(function() {

function _defineLibraryAPIs() {

    // This code block base idea from [Robert Penner's EASING EQUATIONS]
    //      (c) 2001 Robert Penner, all rights reserved.
    //      http://www.robertpenner.com/easing_terms_of_use.html

    // Math.easing - easing functions
    Math.easing = {
            linear: "(c*t/d+b)", // linear(t,b,c,d)
                                 //     t:Number - current time (from 0)
                                 //     b:Number - beginning value
                                 //     c:Number - change in value(delta)(end - begin)
                                 //     d:Number - duration(unit: ms)
    // Quad ---
            inquad: "(q1=t/d,c*q1*q1+b)",
           outquad: "(q1=t/d,-c*q1*(q1-2)+b)",
         inoutquad: "(q1=t/(d*0.5),q1<1?c*0.5*q1*q1+b:-c*0.5*((--q1)*(q1-2)-1)+b)",
    // Cubic ---
           incubic: "(q1=t/d,c*q1*q1*q1+b)",
          outcubic: "(q1=t/d-1,c*(q1*q1*q1+1)+b)",
        inoutcubic: "(q1=t/(d*0.5),q1<1?c*0.5*q1*q1*q1+b:c*0.5*((q1-=2)*q1*q1+2)+b)",
        outincubic: "(q1=t*2,q2=c*0.5,t<d*0.5?(q3=q1/d-1,q2*(q3*q3*q3+1)+b)" +
                                            ":(q3=(q1-d)/d,q2*q3*q3*q3+b+q2))",
    // Quart ---
           inquart: "(q1=t/d,c*q1*q1*q1*q1+b)",
          outquart: "(q1=t/d-1,-c*(q1*q1*q1*q1-1)+b)",
        inoutquart: "(q1=t/(d*0.5),q1<1?c*0.5*q1*q1*q1*q1+b" +
                                      ":-c*0.5*((q1-=2)*q1*q1*q1-2)+b)",
        outinquart: "(q1=t*2,q2=c*0.5,t<d*0.5?(q3=q1/d-1,-q2*(q3*q3*q3*q3-1)+b)" +
                                            ":(q4=q1-d,q3=q4/d,q2*q3*q3*q3*q3+b+q2))",
    // Back ---
            inback: "(q1=t/d,q2=1.70158,c*q1*q1*((q2+1)*q1-q2)+b)",
           outback: "(q1=t/d-1,q2=1.70158,c*(q1*q1*((q2+1)*q1+q2)+1)+b)",
         inoutback: "(q1=t/(d*0.5),q2=1.525,q3=1.70158," +
                        "q1<1?(c*0.5*(q1*q1*(((q3*=q2)+1)*q1-q3))+b)" +
                            ":(c*0.5*((q1-=2)*q1*(((q3*=q2)+1)*q1+q3)+2)+b))",
         outinback: "(q1=t*2,q2=c*0.5," +
                        "t<d*0.5?(q3=q1/d-1,q4=1.70158,q2*(q3*q3*((q4+1)*q3+q4)+1)+b)" +
                               ":(q3=(q1-d)/d,q4=1.70158,q2*q3*q3*((q4+1)*q3-q4)+b+q2))",
    // Bounce ---
          inbounce: "(q1=(d-t)/d,q2=7.5625,q3=2.75,c-(q1<(1/q3)?(c*(q2*q1*q1)+0)" +
                    ":(q1<(2/q3))?(c*(q2*(q1-=(1.5/q3))*q1+.75)+0):q1<(2.5/q3)" +
                    "?(c*(q2*(q1-=(2.25/q3))*q1+.9375)+0)" +
                    ":(c*(q2*(q1-=(2.625/q3))*q1+.984375)+0))+b)",
         outbounce: "(q1=t/d,q2=7.5625,q3=2.75,q1<(1/q3)?(c*(q2*q1*q1)+b)" +
                    ":(q1<(2/q3))?(c*(q2*(q1-=(1.5/q3))*q1+.75)+b):q1<(2.5/q3)" +
                    "?(c*(q2*(q1-=(2.25/q3))*q1+.9375)+b)" +
                    ":(c*(q2*(q1-=(2.625/q3))*q1+.984375)+b))"
    };

    // create easing functions
    mm.each(Math.easing, function(jsExpressionString, easingName) {
        Math[easingName] = new Function("t,b,c,d, q1,q2,q3,q4", // q1~q4 is tmp args
                                        "return " + jsExpressionString);
    });
}

_defineLibraryAPIs();

})();
//}@easing
//{@fx

(function(global) {

function _defineLibraryAPIs(mix) {
    mm.fx = mix(mm_fx, {
        spec:       mm_fx_spec,         // mm.fx.spec(a:Number/NumberArray, b:Number/NumberArray,
                                        //            time:Number = 200, delay:Number = 0, easing:Function = Math.inoutcubic, freeze:Boolean = false):Object
        defs:       mm_fx_defs,         // mm.fx.defs(time:Number = 200, delay:Number = 0, easing:Function = Math.inoutcubic, freeze:Boolean = false):Object
        kill:       mm_fx_kill,         // mm.fx.kill(uid)
        tick:       mm_fx_tick          // mm.fx.tick(fn):Hash { type, tid }
    });
}

// --- library scope vars ----------------------------------
// http://d.hatena.ne.jp/uupaa/20110622
// http://uupaa.hatenablog.com/entry/2012/02/01/083607
var _frame = global.requestAnimationFrame    ||
             global.oRequestAnimationFrame   ||
             global.msRequestAnimationFrame  ||
             global.mozRequestAnimationFrame ||
             global.webkitRequestAnimationFrame, // -> cancelRequestAnimationFrame
    _immediate = global.setImmediate       ||
                 global.oSetImmediate      ||
                 global.msSetImmediate     ||
                 global.mozSetImmediate    ||
                 global.webkitSetImmediate, // -> clearImmediate
    _uid  = [], // uid db
    _kuid = []; // kill uid db

// --- implement -------------------------------------------
function mm_fx_spec(a,        // @arg Number/NumberArray: point A. begin point
                    b,        // @arg Number/NumberArray: point B. end point
                    time,     // @arg Number(= 200): duration time (msec value)
                    delay,    // @arg Number(= 0): delay time (msec value)
                    easing,   // @arg Function(= Math.inoutcubic): easing function
                    freeze) { // @arg Boolean(= false): true is freeze
                              // @ret Object: { a, b, time, delay, easing, freeze }
                              // @help: mm.fx.arg
                              // @desc: build mm.fx spec param
//{@assert
    mm.allow(a, "Number/Array");
    mm.allow(b, "Number/Array");
//}@assert

    var rv = mm_fx_defs(time, delay, easing, freeze);

    rv.a = a;
    rv.b = b;
    return rv;
}

function mm_fx_defs(time,     // @arg Number(= 200): duration time (msec value)
                    delay,    // @arg Number(= 0): delay time (msec value)
                    easing,   // @arg Function(= Math.inoutcubic): easing function
                    freeze) { // @arg Boolean(= false): true is freeze
                              // @ret Object: { time, delay, easing, freeze }
                              // @help: mm.fx.defs
                              // @desc: build mm.fx default spec
//{@assert
    mm.allow(time,   "Number/undefined");
    mm.allow(delay,  "Number/undefined");
    mm.allow(easing, "Function/undefined");
    mm.allow(freeze, "Boolean/undefined");
//}@assert

    return { time: time || 200,
             delay: delay || 0,
             easing: easing || Math.inoutcubic,
             freeze: freeze || false };
}

// mm.fx
function mm_fx(spec,   // @arg Hash: mm.fx.spec() result { a, b, time, delay, easing, freeze }
               tick,   // @arg Function: tick(step, spec, result, elapsed)
                       //   tick.step - Number: 0 is setup, 1 is tick, 2 is teardown
                       //   tick.spec - Object: mm.fx spec
                       //   tick.result - Object: result value { key: value, ... }
                       //   tick.elapsed - Number: elapsed time
               defs) { // @arg Object(= null): mm.fx.defs() result { time, delay, easing, freeze }
                       // @ret Number: fx uid, killingTicket for killing animation
                       // @help: mm.fx
                       // @desc: easing, mass effect

    function _kill() { // @lookup: fxuid, fxdb
        var i = 0, iz = fxdb.length,
            index = _kuid.indexOf(fxuid) + 1;

        if (index) {
            _kuid.splice(index - 1, 1);
        }
        for (i = 0; i < iz; ++i) {
            if (fxdb[i].state !== COMPLETED) {
                fxdb[i].state = FREEZE;
            }
        }
    }

    function _tick() { // @lookup: spec, fxuid, past, fxdb, tick, state
        var now = Date.now(),
            curt,
            spec,
            result = {},
            updateState = false,
            i = 0, iz = fxdb.length, j, jz, remain = iz;

        if (_kuid.length &&
            _kuid.indexOf(fxuid) >= 0) {
            _kill();
        }
        for (; i < iz; ++i) {
            curt = null;
            spec = fxdb[i];

            switch (spec.state) {
            case COMPLETED:
                --remain;
                break;
            case WAIT:
                spec.past || (spec.past = now);

                if (now >= spec.past + spec.delay) { // delay end?
                    spec.state = RUNNING; // WAIT -> RUNNING
                    curt = spec.a.concat(); // Array#copy
                    updateState = true;
                }
                break;
            case RUNNING:
                updateState = true;
                if (now >= spec.past + spec.delay + spec.time) { // timeout?
                    spec.state = COMPLETED; // RUNNING -> COMPLETED
                    curt = spec.b.concat(); // Array#copy
                    --remain;
                } else {
                    for (curt = [], j = 0, jz = spec.a.length; j < jz; ++j) {
                        curt.push(
                            spec.easing(now - spec.past - spec.delay, // current time
                                        spec.a[j],                    // begin
                                        spec.b[j] - spec.a[j],        // delta
                                        spec.time));                  // duration
                    }
                    spec.c = curt.concat(); // Array#copy
                }
                break;
            case FREEZE:
                updateState = true;
                spec.state = COMPLETED; // FREEZE -> COMPLETED
                curt = (spec.freeze ? spec.c : spec.b).concat(); // Array#copy
                --remain;
            }

            if (curt !== null) {
                if (spec.isArray) {
                    result[spec.key] = [];
                    for (j = 0, jz = spec.a.length; j < jz; ++j) {
                        result[spec.key].push(curt[j]);
                    }
                } else {
                    result[spec.key] = curt[0];
                }
            }
        }
        if (updateState) {
            if (tick(1, spec, result, now - spec.past) === false) {
                // tick() -> false
                //      false is killing animation `` アニメーションの強制終了
                _kill();
            }
        }
        if (remain > 0) {
            _frame ? _frame(_tick)
                   : setTimeout(_tick, 4);
        } else {
            _uid.remove(fxuid); // Array#remove
            tick(2, spec, {}, 0); // teardown
        }
    }

    function _buildMassEffectDB(spec) { // @lookup:
        var rv = [], key, value,
            df = mm.arg(defs, { time: 200, delay: 0,
                                easing: Math.inoutcubic, freeze: false });

        for (key in spec) {
            value = spec[key];
            if (value.a !== void 0 && value.b !== void 0) {
                rv.push({
                    key:    key,                    // "x", "y"
                    a:      Array.isArray(value.a) ? value.a : [value.a], // point A
                    b:      Array.isArray(value.b) ? value.b : [value.b], // point B
                    c:      Array.isArray(value.a) ? value.a : [value.a], // Current value
                    time:   value.time   || df.time,
                    delay:  value.delay  || df.delay,
                    easing: value.easing || df.easing,
                    freeze: value.freeze || df.freeze,
                    isArray:Array.isArray(value.a),
                    state:  WAIT,
                    past:   0
                });
            }
        }
        return rv;
    }

    var WAIT = 0, RUNNING = 1, FREEZE = 2, COMPLETED = 4,
        fxuid = mm.uid("mm_fx"),
        fxdb = _buildMassEffectDB(spec);

    _uid.push(fxuid);

    tick(0, spec, {}, 0); // setup
//    _frame(_tick);
    return fxuid;
}

// mm.fx.kill
function mm_fx_kill(uid) { // @arg Number: mm.fx() result id
                           // @help: mm.fx.kill
                           // @desc: killing animation
//{@assert
    mm.allow(uid, "Number");
//}@assert

    if (_kuid.indexOf(uid) < 0) {
        _kuid.push(uid);
    }
}

// mm.fx.tick
function mm_fx_tick(tick) { // @arg Function: callback
                            // @ret Hash: { type, tid }
                            //      return.type - Number: 0 is setTimeout
                            //                            1 is requestAnimationFrame
                            //                            2 is setImmediate
                            //      return.tid - Number: timer id
                            // @help: mm.fx.tick
                            // @desc: timer api wrapper
//{@assert
    mm.allow(tick, "Function");
//}@assert

    return _frame     ? { type: 1, tid: _frame(tick) } :
           _immediate ? { type: 2, tid: _immediate(tick) }
                      : { type: 0, tid: setTimeout(tick, 4) }
}

// --- build and export ---
_defineLibraryAPIs(mm.mix);

})(this.self || global);

//}@fx

var uu; // @global Function: uupaa.js library namespace

uu || (function(global,     // @arg Global: window or global
                document) { // @arg Document:

function _defineLibraryAPIs(mix) {

    uu = mix(uu_factory, {              // uu("E>F>G", ...):NodeArray
                                        // uu(["E>F>G", contextNode], ...):NodeArray
                                        // uu(node):mmm
                                        // uu([node, ...]):mmm
        // --- environment / information ---
        docs:       "http://code.google.com/p/mofmof-js/wiki/", // uu.docs
        // --- node builder ---
        node:       uu_node,            // uu.node(node, args):node
        head:       function(/* ... */) { return uu_node(document.head, arguments); },
        body:       function(/* ... */) { return uu_node(document.body, arguments); },
        text:       function(text)      { return document.createTextNode(text); },
        // --- css-selector ---
        query:      uu_query,           // uu.query("E>F>G"):NodeArray
                                        // uu.query(["E>F>G", contextNode]):NodeArray
        // --- node, attr / css ---
        attr:   mix(uu_attr, {          // uu.attr(node, key = undef, value = undef):String/Hash/Node
            set:    uu_attr_set         // uu.attr.set(node, hash):Node
        }),
        css:    mix(uu_css, {           // uu.css(node, key = undef, value = undef):String/Hash/Node
            set:    uu_css_set          // uu.css.set(node, hash):Node
        }),
        style:  mix(uu_style, {
            create: uu_style_create,    // uu.style.create(id, rules):Node
            add:    uu_style_add        // uu.style.add(id, rules):Node
        }),
        // --- utility ---
        uid:        uu_uid,             // uu.uid(node):Number
        dump:       uu_dump,            // uu.dump(node = <html>, space = 4, depth = 5):String
        vendor:     uu_vendor,          // uu.vendor("user-select"):Hash { base, prefixed }
        // --- boot loader ---
        boot:       mm.env.ie8 ? uu_boot_ie678 : uu_boot,
                                        // uu.boot(fn_that)
        main:       uu_main,            // uu.main(fn_that)
        // --- url dispatcher ---
        page:       uu_page             // uu.page(path = location.href, ...)
    });
    // generate uu.div(), uu.p(), uu.img(), ... functions
    HTML_TAGS.split(",").each(function(tag) {
        uu[tag] = function(/* ... */) { // @var_args Mix:
            return uu_node(document.createElement(tag), arguments);
        };
    });
}

function _polyfillAndExtend(wiz, HTMLElement, HTMLDocument) {
    wiz(document, {
        html:       document.documentElement,                   // document.html
        head:       document.getElementsByTagName("head")[0]    // document.head
    });
    var extras = {
        on:         HTMLElement_on,     // node#on(type, fn):this
        one:        HTMLElement_one,    // node#one(type, fn):this
        off:        HTMLElement_off,    // node#off(type = "", fn = null):this
        add:        HTMLElement_add,    // node#add(node):this
        cut:        HTMLElement_cut,    // node#cut():this
        top:        HTMLElement_top,    // node#top(node):this
        has:        HTMLElement_has,    // node#has(node:Node/CSSQueryString):Boolean
        find:       HTMLElement_find,   // node#find(query:CSSQueryString, from = 0, to = length):NodeArray++
                                        // node#find("div").cut()   -> cut all
                                        // node#find("div").clear() -> clear all children
        clear:      HTMLElement_clear,  // node#clear():this
        path:       HTMLElement_path,   // node#path():CSSQueryString
        addClass:   HTMLElement_addClass,     // node#addClass("class"):this
        hasClass:   HTMLElement_hasClass,     // node#hasClass("class"):Boolean
        toggleClass: HTMLElement_toggleClass, // node#toggleClass("class"):Boolean
        removeClass: HTMLElement_removeClass  // node#removeClass("class"):this
    };
    wiz(HTMLElement.prototype,  extras);
    wiz(HTMLDocument.prototype, extras);

    global.NodeList && wiz(NodeList.prototype, {
        toArray:    Array.prototype.slice
    });
//{@gecko
//{@ie [IE9]
    global.HTMLCollection && wiz(HTMLCollection.prototype, {
        toArray:    function(from, to) { return mm.cast.list(this, from, to); }
    });
//}@ie
//}@gecko

//{@ie
    var extras_ie8 = {
        addEventListener: function(type, fn, capture) {
            function _handleEvent(ev) {
                ev.target = ev.srcElement;
                ev.mouse  = ev.button || 0;
                ev.target || (ev.currentTarget = node);

                switch (ev.type){
                case "contextmenu": ev.mouse = 2; break;
                case "mousedown":
                case "mouseup":
                    ev.mouse = (ev.button & 1) ? 0 : (ev.button & 2) ? 2 : 1;
                    break;
                case "mouseover":
                case "mouseout":
                    ev.relatedTarget = ev.target === ev.fromElement
                                     ? ev.toElement : ev.fromElement;
                }
                ev.pageX = ev.clientX + (owner.scrollLeft || 0);
                ev.pageY = ev.clientY + (owner.scrollTop  || 0);
                isfn ? fn(ev)
                     : fn.handleEvent.call(fn, ev);
            }

            var node = this,
                isfn = typeof fn === "function",
                owner = (node.ownerDocument || document).documentElement;

            if (type === "DOMContentLoaded") {
                return isfn ? uu_boot_ie678(fn)
                            : uu_boot_ie678([fn.handleEvent, fn]);
            }
            this.attachEvent("on" + type, _handleEvent);
        },
        removeEventListener: function(type, fn, capture) {
            this.detachEvent("on" + type, fn);
        }
    };
    if (mm.env.ie8) {
        wiz(global,            extras_ie8);
        wiz(document,          extras_ie8);
        wiz(Element.prototype, extras_ie8);
    }
//}@ie
}

var HTML_TAGS = // HTML tags, exclude <html><head><body>
        "a,b,br,button,dd,div,dl,dt,form,h1,h2,h3,h4,h5,h6,hr,i,img," +
        "iframe,input,li,ol,option,p,pre,select,span,table,tbody,tr," +
        "td,th,thead,tfoot,textarea,u,ul," +
        "abbr,article,aside,audio,canvas,datalist," +
        "details,eventsource,figure,footer,header,hgroup," +
        "mark,menu,meter,nav,output,progress,section,time,video",
    FIX_ATTR = { // fix attribute name
        w:          "width",
        h:          "height",
        htmlFor:    "for",
        className:  "class"
    },
    FIX_STYLE = { // fix style property name
        // rect: left(x), top(y), width(w), height(h)
        x:          "left",
        y:          "top",
        w:          "width",
        h:          "height",
        // border(b), margin(m), padding(p), outline(o)
        b:          "border",
        m:          "margin",
        p:          "padding",
        // color(c), background-color(bc), background-position-x(bpx)
        c:          "color",
        bc:         "backgroundColor",
        bpx:        "backgroundPositionX",
        bpy:        "backgroundPositionY",
        // opacity(o)
        o:          "opacity",
        // font: font-size(fs), font-weight(fw)
        fs:         "fontSize",
        fw:         "fontWeight",
        // matrix: rotate(r), scale-x/y(sx/sy), translate-x/y(tx/ty)
        r:          "rotate",
        sx:         "scaleX",       // transform.scaleX
        sy:         "scaleY",       // transform.scaleY
        tx:         "translateX",   // transform.translateX
        ty:         "translateY",   // transform.translateY
        mb_x:       mm.env.mobile ? "translateX" : "left",
        mb_y:       mm.env.mobile ? "translateY" : "top"
    },
    NUMBER_SETTER = function(node, prop, value) { node.style[prop] = value; },
    STYLE_POLYFILL = {
        zIndex:     NUMBER_SETTER,
        opacity:    NUMBER_SETTER,
        lineHeight: NUMBER_SETTER,
        fontWeight: NUMBER_SETTER,
        userSelect: function(node, prop, value) { _userSelect(value !== "none"); }
    },
    VENDOR_PREFIX = mm.env.webkit ? "Webkit" :
                    mm.env.gecko  ? "Moz" :
                    mm.env.ie     ? "ms" :
                    mm.env.opera  ? "O" : "";
//    _dispatch_db = {}; // { readyEventType: [[low order], [mid order], [high order]], ... }

// --- implement ---
// uu - factory
function uu_factory(mix           // @arg CSSQueryString/CSSQueryStringAndContextArray/Node/NodeArray: css-selector
                    /*, ... */) { // @var_args Mix:
                                  // @ret NodeArray:
                                  // @help: uu#uu.factory
                                  // @desc: css-selector or wrap object

    // 1. uu(node, uu.p())           -> node.add(uu.p()) -> [node]
    // 2. uu("E>F>#G")               -> mm.cast(document.query("E>F>G")) -> [<node id="G">]
    // 3. uu("E>F>#G", uu.p())       -> mm.cast(document.query("E>F>G")) -> [<node id="G">]
    // 4. uu(["E>F>#G", node])       -> mm.cast(node.query("E>F>G"))     -> [<node id="G">]
    // 5. uu([node1, node2], uu.p()) -> node1.add(uu.p()), node2.add(uu.p()) -> [node1, node2]

//{@assert
    mm.allow(mix, "String/Array/Node");
//}@assert

    var rv, i, iz, args,
        isary = Array.isArray(mix),
        query = isary ? mix[0] : mix,
        ctx =  (isary ? mix[1] : null) || document;

    rv = mix.nodeType ? [mix]
       : typeof query === "string" ? ctx.find(query)
       : mix;

    if (arguments.length >= 2) {
        args = Array.prototype.slice.call(arguments, 1);
        for (i = 0, iz = rv.length; i < iz; ++i) {
            uu_node.call({ clone: !!i }, rv[i], args);
        }
    }
    return rv;
}

// uu.query
function uu_query(query) { // @arg CSSQueryString/CSSQueryStringAndContextNodeArray: "E>F>G" or ["E>F>G", context]
                           // @ret NodeArray: [node, ...]
                           // @help: uu#uu.query
                           // @desc: query node
//{@assert
    mm.allow(query, "String/Array");
//}@assert

    return Array.isArray(query) ? query[1].find(query[0])
                                : document.find(query);
}

// uu.node - node builder
function uu_node(node,   // @arg Node:
                 args) { // @arg Arguments/MixArray(= undefined): [Node/String/Hash, ...]
                         // @this: { clone }
                         //     this.clone - Boolean: true is apply cloneNode(true)
                         // @ret Node:
                         // @help: uu#uu.node
                         // @desc: node builder

    //  [1][Node]            uu.div(uu.p())                           -> <div><p></p></div>
    //  [2][TextNode]        uu.div(uu.text("hello"))                 -> <div>hello</div>
    //  [3][TextNode]        uu.div("::hello")                        -> <div>hello</div>
    //  [4][TextNode atmark] uu.div("::format @@ @@", "hello", "world") -> <div>format hello world</div>
    //  [5][attr]            uu.div("id:a;class:hello")               -> <div id="a" class="hello"></div>
    //  [6][attr]            uu.div({id:"a","class":"hello"})         -> <div id="a" class="hello"></div>
    //  [7][attr atmark]     uu.div("id:@@", "a")                     -> <div id="a"></div>
    //  [8][css]             uu.div("", "color:red;float:left")       -> <div style="color:red;float:left"></div>
    //  [9][css]             uu.div("", {color:"red",float:"left"})   -> <div style="color:red;float:left"></div>
    //  [10][css atmark]     uu.div("", "color:@@", "red")            -> <div style="color:red"></div>
    //  [11][complex]        uu.div("id:@@", "a", {color:"red"}, "::@@ @@", "hello", "world")
    //                                                                -> <div id="a" style="color:red">hello world</div>

//{@assert
    mm.allow(node, "Node");
    mm.allow(args, "List/Array");
//}@assert

    if (!args || !args.length) {
        return node;
    }

    args = mm.cast.list(args);

    var token, isstr, match, prop = 0,
        i = 0, iz = args.length,
        at = /@@/g;

    for (; i < iz; ++i) {
        token = args[i];

        if (token.nodeType) { // node -> appendChild(node)
            this.clone ? node.appendChild(token.cloneNode(true))
                       : node.appendChild(token);
        } else {
            isstr = typeof token === "string";
            if (isstr) {
                if (token.indexOf("@@") >= 0) { // "width:@@px".at(100) -> "width:100px"
                    match = token.match(at).length;
                    token = args.slice(i + 1, i + match + 1).at(args[i]); // Array#at(format)
                    i += match;
                }
                if (token.indexOf("::") === 0) { // uu.div("::text") -> uu.div(uu.text("text"))
                    node.appendChild(document.createTextNode(token.slice(2)));
                    continue;
                }
            }
            switch (++prop) {
            case 1: token && uu_attr_set(node, isstr ? token.unpack()
                                                     : token);
                    break;
            case 2: token && uu_css_set( node, isstr ? token.unpack()
                                                     : token);
                    break;
            default:
                throw new Error(token);
            }
        }
    }
    return node;
}

// uu.uid
function uu_uid(node) { // @arg Node:
                        // @ret Number: node unique id
                        // @help: uu#uid
                        // @desc: create node unique id

    var mark = "data-uuuid", // node["data-uuuid"]
        rv = node[mark];

    if (!rv) {
        node[mark] = rv = mm.uid("uu_uid");
    }
    return rv;
}

// uu.dump
function uu_dump(node,    // @arg Node(= <html>):
                 space,   // @arg String(= 4):
                 depth) { // @arg Number(= 5): max depth, 0 is infinity
                          // @ret String:
                          // @desc: Dump Node Tree
//{@assert
    mm.allow(node,  "Node/String/undefined");
    mm.allow(space, "Number/undefined");
    mm.allow(depth, "Number/undefined");
//}@assert
    typeof node === "string" && (node = document.querySelector(node));

    node  = (!node || node === document) ? document.documentElement : node;
    space = space === void 0 ? 4 : space;
    depth = depth || 5;

    return '"<' + node.nodeName.toLowerCase() + '>":' +
           (space ? " "  : "") + _uu_dump(node, space, depth, 1);
}

// inner - mm.dump impl
function _uu_dump(mix,    // @arg Node: parentNode
                  space,  // @arg Number: space
                  depth,  // @arg Number: max depth
                  nest) { // @arg Number: nest count from 1
                          // @ret String:

    function _dumpArray(mix) {
        if (!mix.length) {
            return "[]";
        }
        var ary = [], i = 0, iz = mix.length;

        for (; i < iz; ++i) {
            ary.push(indent + _uu_dump(mix[i], space, depth, nest + 1));
        }
        return "[" + lf + ary.join("," + lf) +
                     lf + " ".repeat(space * (nest - 1)) + "]";
    }

    function _dumpHash(mix) {
        var ary = [], key,
            keys = Object.keys(mix).sort(), i = 0, iz = keys.length,
            name = mix.__CLASS__ ? "mm." + mix.__CLASS__ + sp
                 : mix.nickname  ? mix.nickname("anonymous") + sp : "";

        if (!iz) {
            return name + "{}";
        }
        for (; i < iz; ++i) {
            key = keys[i];
            ary.push(indent + '"' + key + '":' + sp +
                     _uu_dump(mix[key], space, depth, nest + 1));
        }
        return name + "{" + lf + ary.join("," + lf) +
                            lf + " ".repeat(space * (nest - 1)) + "}";
    }

    function _dumpNode(node) {
        var ary = [],
            attr = uu_attr(node), key, text;

        // add query path
        if (!/html|head|body|title|meta|script|link|style/i.test(node.nodeName)) {
            ary.push(indent + '"query":' + sp + '"' + uu.path(node) + '"');
        }
        // add attribute
        for (key in attr) {
            ary.push(indent + '"' + key + '":' + sp + '"' + attr[key] + '"');
        }
        // node tree
        for (node = node.firstChild; node; node = node.nextSibling) {
            switch (node.nodeType) {
            case 1: // ELEMENT_NODE
                ary.push(indent + '"<' + node.nodeName.toLowerCase() + '>":' + sp +
                         _uu_dump(node, space, depth, nest + 1));
                break;
            case 3: // TEXT_NODE
                text = (node.textContent || "").crlf(" ").trim().overflow(30);
                text && ary.push(indent + '"text":' + sp + '"' + text + '"');
            }
        }
        return name + "{" + lf + ary.join("," + lf) +
                            lf + " ".repeat(space * (nest - 1)) + "}";
    }

    if (depth && nest > depth) {
        return "...";
    }

    var lf = space ? "\n" : "", // line feed
        sp = space ? " "  : "", // a space
        indent = " ".repeat(space * nest);

    switch (mm.type(mix)) {
    case "null":      return "null";
    case "undefined": return "undefined";
    case "global":    return "global";
    case "boolean":
    case "number":    return "" + mix;
    case "date":      return mix.toJSON();
    case "regexp":    return "/" + mix.source + "/";
    case "node":      return _dumpNode(mix);
    case "list":
    case "array":     return _dumpArray(mix);
    case "style":     return _dumpHash(mm.cast.style(mix));
    case "attr":      return _dumpHash(mm.cast.attr(mix));
    case "object":
    case "function":  return _dumpHash(mix);
    case "string":    return '"' + mix + '"';
    }
    return "";
}

// uu.vendor
function uu_vendor(sample) { // @arg String: "user-select" or "userSelect"
                             // @ret Hash: { base, prefixed }
                             //     return.base - String: "userSelect"
                             //     return.prefixed - String: "WebkitUserSelect"
                             // @help: uu#uu.vendor
                             // @desc: convert vendornized string
//{@assert
    mm.allow(sample, "String");
//}@assert

    var rv = "", ary = sample.split("-"), i = 1, iz = ary.length;

    for (rv = ary[0]; i < iz; ++i) {
        rv += ary[i].up(0);
    }
    return { base: rv, prefixed: VENDOR_PREFIX + rv.up(0) };
}

// uu.attr - attribute accessor
function uu_attr(node,    // @arg Node/CSSQueryString:
                 key,     // @arg String/Hash(= undefined): "key"
                 value) { // @arg String(= undefined): "value"
                          // @ret String/Hash/Node:
                          // @help: uu#uu.attr
                          // @desc: node attribute accessor, complex argeuments

    //  [1][get items]  uu.attr(node)                   -> { key: "value", ... }
    //  [2][get item]   uu.attr(node, key)              -> "value"
    //  [3][set item]   uu.attr(node, key, "value")     -> node
    //  [4][mix items]  uu.attr(node, { key: "value" }) -> node
//{@assert
    mm.allow(node,  "Node/String");
    mm.allow(key,   "String/Hash/undefined");
    mm.allow(value, "String/undefined");
//}@assert

    typeof node === "string" && (node = document.querySelector(node));

    switch (mm.complex(key, value)) {
    case 1: return mm.cast.attr(node.attributes || []); // <document> has not attributes
    case 2: return (node.getAttribute( FIX_ATTR[key] || key ) || "") + "";
    case 3: key = mm.pair(key, value);
    }
    return uu_attr_set(node, key);
}

// uu.attr.set
function uu_attr_set(node,   // @arg Node/CSSQueryString:
                     hash) { // @arg Hash: { key: value, ... }
                             // @ret Node:
                             // @help: uu#uu.attr.set
                             // @desc: setAttribute
//{@assert
    mm.allow(node, "Node/String");
    mm.allow(hash, "Hash");
//}@assert

    typeof node === "string" && (node = document.querySelector(node));

    for (var attr in hash) {
        switch (attr) {
        case "checked":
        case "disabled": node[attr] = !!hash[attr]; // node.disabled = true / false
            break;
        default:
            node.setAttribute( FIX_ATTR[attr] || attr, hash[attr]);
        }
    }
    return node;
}

// uu.css - css and StyleSheet accessor
function uu_css(node,    // @arg Node/CSSQueryString:
                key,     // @arg String/Hash(= void): CSS Property Keyword or "px"
                value) { // @arg String(= void): value
                         // @ret Hash/String/Node:
                         // @help: uu#uu.css
                         // @desc: css style accessor, complex argeuments

    //  [1][get computed items] uu.css(node)              -> { key: value, ... }
    //  [2][mix items]          uu.css(node, { key: value, ... }) -> node
    //  [3][get item]           uu.css(node, key)         -> value
    //  [4][set item]           uu.css(node, key, value)  -> node
    //  [5][create <style>]     uu.css("E{...}", node-id) ->

//{@assert
    mm.allow(node,  "Node/String");
    mm.allow(key,   "String/Hash/undefined");
    mm.allow(value, "String/undefined");
//}@assert

    typeof node === "string" && (node = document.querySelector(node));

    // 1: uu.css(), 2: uu.css(key), 3: uu.css(key, value), 4: uu.css({key:value, ...})
    switch (mm.complex(key, value)) {
    case 1: return mm.cast.style(global.getComputedStyle(node));
    case 2: return global.getComputedStyle(node)[ FIX_STYLE[key] || key ] || "";
    case 3: return uu_css_set(node, mm.pair(key, value));
    }
    return uu_css_set(node, key);
}

// uu.css.set
function uu_css_set(node,   // @arg Node/CSSQueryString:
                    hash) { // @arg Hash: { key: value, ... }
                            // @ret Node:
                            // @help: uu#uu.css.set
                            // @desc: set css properties
//{@assert
    mm.allow(node, "Node/String");
    mm.allow(hash, "Hash");
//}@assert

    typeof node === "string" && (node = document.querySelector(node));

    var prop, value, vend, polyfill, isnum = /\d$/;

    for (prop in hash) {
        value = hash[prop] + "";
        prop = FIX_STYLE[prop] || prop; // either "text-align" or "textAlign"

        polyfill = STYLE_POLYFILL[prop];

        if (polyfill) {
            polyfill(node, prop, value);
        } else {
            isnum.test(value) && (value += "px"); // "10" -> "10px"
            if (node.style[prop] !== void 0) {
                node.style[prop] = value + "";
            } else {
                vend = VENDOR_PREFIX + prop.up(0);
                if (node.style[vend] !== void 0) {
                    node.style[vend] = value + "";
                }
            }
        }
    }
    return node;
}

// uu.style
function uu_style() {
}

// uu.style.create
function uu_style_create(id,      // @arg String: node id
                         rules) { // @arg CSSRuleString: "E { prop: value } E { ... }"
                                  // @ret Node: <style id="arguments.id">
                                  // @help: uu#uu.style.create
                                  // @desc: add <style> rules
//{@assert
    mm.allow(id,    "String");
    mm.allow(rules, "String");
//}@assert

    var rv;

    if (id) {
        rv = document.querySelector("#" + id);
    }
    if (!rv) {
        if ("textContent" in document.documentElement) { // modern browser
            rv = document.createElement("style");
            rv.id = id;
            rv.textContent = rules;
            document.head.appendChild(rv);
//{@ie
        } else if (document.createStyleSheet) { // IE
            rv = document.createStyleSheet();
            rv.id = id;
            rv.cssText = rules;
//}@ie
        }
    }
    return rv;
}

// uu.style.add
function uu_style_add(id,      // @arg String: node id
                      rules) { // @arg CSSRuleString: "E { prop: value } E { ... }"
                               // @ret Node: <style id="arguments.id">
                               // @help: uu#uu.style.add
                               // @desc: add <style> rules
    mm.deny("TODO: NOT IMPL", "string");
}

// inner - set userSelect
function _userSelect(on) { // @arg Boolean(= false): true is on, false is off
    var body = document.body,
        vend = uu_vendor("user-select");

    if (body.style[vend.base] !== void 0) {
        body.style[vend.base] = on ? "" : "none";
    } else if (body.style[vend.mod] !== void 0) {
               body.style[vend.mod] = on ? "" : "none";
//{@ie
//{@opera
    } else { // if ie or opera
        body.unselectable  = on ? "" : "on";
        body.onselectstart = on ? "" : mm.pao(false);
//}@opera
//}@ie
    }
}

//{@ie
function uu_boot_ie678(fn_that) {
    function _callback() {
        var fn   = fn_that[0] || fn_that,
            that = fn_that[1] || null;

        fn.call(that);
    }

    // DOMContentLoaded for IE. http://d.hatena.ne.jp/uupaa/20100410/1270882150
    function _IE_DOMContentLoaded(){
        try {
            (new Image()).doScroll(); // [!] throws
            _callback();
        } catch (err) {
            setTimeout(_IE_DOMContentLoaded, 64); // delay after 64ms
        }
    }

    _IE_DOMContentLoaded();
}
//}@ie

// uu.boot
function uu_boot(fn_that) { // @arg Function/FunctionAndThatArray: fn or [fn, that]
                            // @help: uu#uu.boot
                            // @desc: boot loader (DOMContentLoaded event handler)
    function _callback() {
        var fn   = fn_that[0] || fn_that,
            that = fn_that[1] || null;

        fn.call(that);
    }
    if (document.readyState === "complete") {
        _callback();
    } else {
        document.addEventListener("DOMContentLoaded", _callback, false);
    }
}

// uu.main
function uu_main(fn_that) { // @arg Function/FunctionAndThatArray: fn or [fn, that]
                            // @help: uu#uu.main
                            // @desc: window.onload event handler
    var fn   = fn_that[0] || fn_that,
        that = fn_that[1] || null;

    if (document.readyState === "complete") {
        fn.call(that);
    } else {
        global.addEventListener("load", function() {
            fn.call(that);
        }, false);
    }
}

// uu.page - url dispatcher
function uu_page(path          // @param String(= location.href):
                 /*, ... */) { // @param PatternAndFunctionArray:
                               //          [<pattern, callback>, ..., missMatch]
                               //          pattern - PatternString/RegExp:
                               //          callback - Function: callback
                               //          missMatch - Function: miss matched callback
                               // @help: uu#uu.ready
                               // @see: http://code.google.com/p/x3-js/wiki/x3#x3.ready
                               // @desc: url dispatcher
    // uu.page("", "#a$",   function() { mm.log("page a"); },
    //             "b.htm", function() { mm.log("page b"); },
    //                      function() { mm.log("other page"); });
    path = path || location + "";

    var ary = [].slice.call(arguments).slice(1), pattern, callback;

    while ((pattern = ary.shift()) && (callback = ary.shift())) {
        if (path.indexOf(pattern) >= 0 || RegExp(pattern).test(path)) {
            return callback();
        }
    }
    pattern(); // miss match
};

// HTMLElement.prototype.on
function HTMLElement_on(type, // @arg String: event type
                        fn) { // @arg Function: callback
                              // @ret Node: this
                              // @desc: node.addEventListener alias
    // remove the existing event data
    this.__EVENT__ = _eventWalker(this.__EVENT__ || [], function(t, f) {
        return type === t && fn === f;
    });
    this.__EVENT__.push(type, fn);
    this.addEventListener(type, fn, false);

    return this;
}

// HTMLElement.prototype.one
function HTMLElement_one(type, // @arg String: event type
                         fn) { // @arg Function: callback
                               // @ret Node: this
                               // @desc: one time event handler
    // remove the existing event data
    var that = this;

    this.__EVENT__ = _eventWalker(this.__EVENT__ || [], function(t, f) {
        return type === t && fn === f;
    });
    this.__EVENT__.push(type, fn);
    this.addEventListener(type, function(ev) {
        fn.handleEvent ? fn.handleEvent(ev)
                       : fn.call(that, ev);
        that.removeEventListener(type, fn, false);
    }, false);

    return this;
}

// HTMLElement.prototype.off
function HTMLElement_off(type, // @arg String(= ""): event type
                         fn) { // @arg Function(= null): callback
                               // @ret Node: this
                               // @desc: node.removeEventListener alias
    // [1] node.off()            -> remove all events
    // [2] node.off("click")     -> remove all click events
    // [3] node.off("",      fn) -> remove all fn events
    // [4] node.off("click", fn) -> remove a event
    var that = this;

    this.__EVENT__ = _eventWalker(this.__EVENT__ || [], function(t, f) {
        var match = type && fn ? type === t && fn === f
                  : type       ? type === t
                  : fn         ? fn   === f
                  : true;

        if (match) {
            that.removeEventListener(t, f, false);
        }
        return match;
    });

    return this;
}

// inner - HTMLElement_on, HTMLElement_off helper
function _eventWalker(ary,  // @arg Array: [<type, fn>, <type, fn>, ...]
                      fn) { // @arg Function: callback(type, fn)
                            // @ret Array: [<type, fn>, <type, fn>, ...]
    var rv = [], i = 0, iz = ary.length;

    for (; i < iz; i += 2) {
        if (!fn(ary[i], ary[i + 1])) { // false is add pair, true is remove pair
            rv.push(ary[i], ary[i + 1]);
        }
    }
    return rv;
}

// HTMLElement.prototype.add
function HTMLElement_add(node) { // @arg Node: child node
                                 // @ret this:
                                 // @desc: appendChild
    node && this.appendChild(node);
    return this;
}

// HTMLElement.prototype.cut
function HTMLElement_cut() { // @ret this:
                             // @desc: to cut a parent-child connection
    if (this.parentNode) {
        this.parentNode.removeChild(this);
    }
    return this;
}

// HTMLElement.prototype.top
function HTMLElement_top(node) { // @ret this:
                                 // @desc: insert to top
    node && this.insertBefore(node, this.firstChild);
    return this;
}

// HTMLElement.prototype.has
function HTMLElement_has(node) { // @arg Node/CSSQueryString:
                                 // @ret Boolean:
                                 // @desc: has node
//{@assert
    mm.allow(node, "Node/String");
//}@assert

    if (node.nodeType) {
        while (node = node.parentNode) {
            if (this === node) {
                return true;
            }
        }
        return false;
    }
    return !!this.querySelector(node);
}

// HTMLElement.prototype.find
function HTMLElement_find(query, // @arg CSSQueryString:
                          from,  // @arg Number(= 0):
                          to) {  // @arg Number(= length):
                                 // @ret NodeArray:
                                 // @desc: find nodes
    var rv;

    if (mm.env.ie8) {
        rv = mm.cast.list(this.querySelectorAll(query), from, to);
    } else {
        rv = this.querySelectorAll(query).toArray(from, to); // return NodeArray
    }
    rv.cut = NodeArray_cut;
    rv.clear = NodeArray_clear;
    return rv;
}

function NodeArray_cut() { // @ret NodeArray:
    return NodeArray_each(this, "cut");
}

function NodeArray_clear() { // @ret NodeArray:
    return NodeArray_each(this, "clear");
}

// inner -
function NodeArray_each(ary,      // @arg NodeArray:
                        method) { // @arg String:
                                  // @ret NodeArray:
    var i = ary.length;

    while (i--) {
        ary[i][method]();
    }
    return ary;
}

// HTMLElement.prototype.clear
function HTMLElement_clear() { // @ret this:
                               // @desc: clear all children
    while (this.lastChild) {
        this.removeChild(this.lastChild);
    }
    return this;
}

// HTMLElement.prototype.path
function HTMLElement_path() { // @ret CSSQueryString: "body>div:nth-child(5)"
                              // @help: HTMLElement#path
                              // @desc: get CSSQueryString
    var rv = [], curt = this, feat, index,
        roots = /^(?:html|head|body)$/i;

    while (curt && curt.nodeType === 1) { // 1 = Node.ELEMENT_NODE
        feat = "";

        if (roots.test(curt.nodeName)) {
            rv.push(curt.nodeName);
            break;
        }
        if (curt.className) {
            feat = "." + curt.className;
        }
        if (curt.id) {
            feat += "#" + curt.id;
        } else if (curt.parentNode &&
                   curt.parentNode.children.length > 1) {
            index = mm.cast.list(curt.parentNode.children).indexOf(curt);
            feat += ":nth-child(" + (index + 1) + ")";
        }
        rv.push(curt.nodeName + feat);
        curt = curt.parentNode;
    }
    return rv.reverse().join(">").toLowerCase();
}

// HTMLElement#addClass
function HTMLElement_addClass(name) { // @arg ClassNameString:
                                      // @ret Node: this
    name = name.trim();
    this.hasClass(name) || (this.className += " " + name);
    return this;
}

// HTMLElement#removeClass
function HTMLElement_removeClass(name) { // @arg ClassNameString:
                                         // @ret Node: this
    name = name.trim();
    this.className = (" " + this.className + " ").replace(" " + name + " ", "").trim();
    return this;
}

// HTMLElement#toggleClass
function HTMLElement_toggleClass(name) { // @arg ClassNameString:
                                         // @ret Boolean: true is removed, false is added
    name = name.trim();
    var rv = this.hasClass(name);

    rv ? this.removeClass(name) : this.addClass(name);
    return !rv;
}

// HTMLElement#hasClass
function HTMLElement_hasClass(name) { // @arg ClassNameString:
                                      // @ret Boolean: ture is has
    name = name.trim();
    return (" " + this.className + " ").indexOf(" " + name + " ") >= 0;
}

// inner - prebuild camelized hash - http://handsout.jp/slide/1894
//          { width: "width", "text-align": "TextAlign", ... }
function _prebuildCamelizedStyleDB() {
    var DECAMELIZE = /([a-z])([A-Z])/g,
        NEXT_TOKEN = /-[a-z]/g,
        key, value, prefixed,
        htmlNode = document.documentElement,
        props = mm.env.webkit ? global.getComputedStyle(htmlNode, 0)
                              : htmlNode.style;

    if (mm.env.webkit) {
        for (key in props) {
            if (typeof props[key] === "string") {
                key = value = props.item(key); // key = "-webkit-...", "z-index"

                if (key.indexOf("-") >= 0) {
                    value = key.replace(NEXT_TOKEN, function(m) {
                        return m[1].toUpperCase();
                    });
                }
                FIX_STYLE[key]   = value; // { "z-index": "zIndex" }
                FIX_STYLE[value] = value; // {   zIndex : "zIndex" }
            }
        }
    } else {
        for (key in props) {
            if (typeof props[key] === "string") {
                prefixed = ((mm.env.gecko && !key.indexOf("Moz")) ? "-moz" + key.slice(3) :
                            (mm.env.ie    && !key.indexOf("ms"))  ? "-ms"  + key.slice(2) :
                            (mm.env.opera && !key.indexOf("O"))   ? "-o"   + key.slice(1) : key);

                value = prefixed.replace(DECAMELIZE, function(_, chr, Chr) {
                            return chr + "-" + Chr.toLowerCase();
                        });
                FIX_STYLE[value] = key;   // { "z-index": "zIndex" }
                FIX_STYLE[key]   = key;   // {   zIndex : "zIndex" }
            }
        }
    }
}

// --- build and export api ---
if (typeof module !== "undefined") { // is modular
    module.exports = { uu: uu_factory };
}
_defineLibraryAPIs(mm.mix);
_polyfillAndExtend(mm.wiz, global.HTMLElement  || global.Element,   // [IE8]
                           global.HTMLDocument || global.Document); // [IE8]

// setup boot loader
uu.boot(function() {
    _prebuildCamelizedStyleDB();
    global.boot && global.boot();
    global.main && uu_main(global.main);
});

})(this.self || global, this.document);
(function(global, document, getComputedStyle) {

    //  [1][offset from LayoutParentNode] uu.css.box.rect(<div>)         -> { x: 100, y: 100, w: 100, h: 100, from: <?> }
    //  [2][offset from AncestorNode]     uu.css.box.rect(<div>, <html>) -> { x: 200, y: 200, w: 100, h: 100, from: <html> }
    //  uu.css.setPosition(node, "static");
    //  uu.css.setPosition(node, "absolute");
    //  uu.css.setPosition(node, "relative");

function _defineLibraryAPIs(mix) {
    uu.BORDER =     0x1;
    uu.MARGIN =     0x2;
    uu.PADDING =    0x4;
    uu.calc = {
        px:         uu_calc_px,         // uu.calc.px(node, value):Number
        edge:       uu_calc_edge,       // uu.calc.edge(node):Hash { b, m, p }
        offset:     uu_calc_offset,     // uu.calc.offset(node, from = null):{ x, y, from }
        boxSize:    uu_calc_boxSize,    // uu.calc.boxSize(node):Hash { w, h }
        boxRect:    uu_calc_boxRect,    // uu.calc.boxRect(node, from = null):Hash { x, y, w, h, from }
        vboxSize:   uu_calc_vboxSize,   // uu.calc.vboxSize(node):Hash { w, h }
        vboxRect:   uu_calc_vboxRect    // uu.calc.vboxRect(node, from = null):Hash { x, y, w, h, from }
    };
    uu.css.box = mix(uu_css_box, {      // uu.css.box
        attach:     uu_css_box_attach,  // uu.css.box.attach(node):Hash {}
        detach:     uu_css_box_detach   // uu.css.box.detach(node):Hash { x, y, offset, margin }
    });
}

// --- local vars ---
// none


// uu.calc.px - calc pixel value
function uu_calc_px(node,    // @arg Node: context
                    value) { // @arg Number/CSSUnitString: 12, "12", "12px",
                             //                            "12pt", "12em", "auto"
                             // @ret Number: pixel value
                             // @help: uu#uu.calc.px
                             // @desc: calc pixel value
    return isFinite(value)   ? +value                           // "12.1"   -> 12.1
         : /px$/.test(value) ? parseFloat(value) || 0           // "12.1px" -> 12.1
         : /pt$/.test(value) ? (parseFloat(value) * 4 / 3) | 0  // "12.1pt" -> 12.1 * 1.333 -> 16.12
         : /em$/.test(value) ? _calcEmByFontSize(node, value)   // "12.1em" -> 12.1 * 1em -> ??
         : _calcPixelByProperty(node, value, "left");           // "auto"   -> calc -> ??
}

// inner - calc by font-size
function _calcEmByFontSize(node,    // @arg Node:
                           value) { // @arg NumberString/CSSEmUnitString: "12", "12em"
                                    // @ret Number: pixel value
    var fontSize = getComputedStyle(node, 0).fontSize,
        bias = /pt$/.test(fontSize) ? 4 / 3 // "12pt"           -> *1.333
                                    : 1;    // "12px" and other -> *1

    return (parseFloat(value) * parseFloat(fontSize) * bias) | 0;
}

// inner - calc css unit to pixel
function _calcPixelByProperty(node,  // @arg Node:
                              value, // @arg CSSUnitString: "10em", "10pt", "10px", "auto"
                              by) {  // @arg String: by property, "left", "width", ...
                                     // @ret Number: pixel value
//{@ie
    function _ie678(node,  // @param Node:
                    value, // @param CSSUnitString: "10em", "10pt", "10px", "auto"
                    by) {  // @param String: by property, "left", "width", ...
                           // @ret Number: pixel value
        var ns = node.style,
            nr = node.runtimeStyle,
            mem = [ns[by], nr[by]]; // keep !important value

        // overwrite
        nr[by] = node.currentStyle[by];
        ns[by] = value;

        // get pixel
        value = ns.pixelLeft;

        // restore
        ns[by] = mem[0];
        nr[by] = mem[1];

        return value || 0;
    }
    if (mm.env.ie8) {
        return _ie678(node, value, by);
    }
//}@ie

    var ns = node.style,
        mem = [ns.left, 0, 0]; // [left, position, display]

//{@webkit
    if (mm.env.webkit) {
        mem[1] = ns.getPropertyValue("position");
        mem[2] = ns.getPropertyValue("display");
        ns.setProperty("position", "absolute", "important");
        ns.setProperty("display",  "block",    "important");
    }
//}@webkit

    // effect style
    ns.setProperty(by, value, "important");

    value = parseInt(getComputedStyle(node).left); // get pixel

    // restore style
    ns.removeProperty(by);
    ns.setProperty(by, mem[0], ""); // remove !important

//{@webkit
    if (mm.env.webkit) {
        ns.removeProperty("position");
        ns.removeProperty("display");
        ns.setProperty("position", mem[1], "");
        ns.setProperty("display",  mem[2], "");
    }
//}@webkit
    return value || 0;
}

// uu.calc.edge
function uu_calc_edge(node,   // @arg Node:
                      menu) { // @arg Number(= uu.BORDER | uu.MARGIN | uu.PADDING): cook menu
                              // @ret Hash: { b, m, p }
                              //    b - EdgeHash: { top, left, right, bottom }
                              //    m - EdgeHash: { top, left, right, bottom }
                              //    p - EdgeHash: { top, left, right, bottom }
                              //    {b|m|p}.top    - Number: {border|margin|padding} top width
                              //    {b|m|p}.left   - Number: {border|margin|padding} left width
                              //    {b|m|p}.right  - Number: {border|margin|padding} right width
                              //    {b|m|p}.bottom - Number: {border|margin|padding} bottom width
                              // @help: uu#uu.calc.edge
                              // @desc: calc edge size(margin, padding, border)
//{@assert
    mm.allow(node, "Node");
    mm.allow(menu, "Number/undefined");
//}@assert

    menu = menu || (uu.BORDER | uu.MARGIN | uu.PADDING);

    var db = {
            "0px": 0, "1px": 1, "2px": 2, "3px": 3, thin: 1, medium: 3, thick: 5
        },
        cs = getComputedStyle(node, 0), n, undef, auto = "auto",
        mt = cs.marginTop,
        ml = cs.marginLeft,
        mr = cs.marginRight,
        mb = cs.marginBottom,
        bt = cs.borderTopWidth,
        bl = cs.borderLeftWidth,
        br = cs.borderRightWidth,
        bb = cs.borderBottomWidth,
        pt = cs.paddingTop,
        pl = cs.paddingLeft,
        pr = cs.paddingRight,
        pb = cs.paddingBottom;

    if (menu & uu.MARGIN) {
        mt = ((n = db[mt]) === undef) ? uu_calc_px(node, mt) : n;
        ml = ((n = db[ml]) === undef) ? uu_calc_px(node, ml) : n;
        mr = ((n = db[mr]) === undef) ? uu_calc_px(node, mr) : n;
        mb = ((n = db[mb]) === undef) ? uu_calc_px(node, mb) : n;
    }
    if (menu & uu.BORDER) {
        // border: auto -> invalid value -> 0
        bt = ((n = db[bt]) === undef) ? bt === auto ? 0 : uu_calc_px(node, bt) : n;
        bl = ((n = db[bl]) === undef) ? bl === auto ? 0 : uu_calc_px(node, bl) : n;
        br = ((n = db[br]) === undef) ? br === auto ? 0 : uu_calc_px(node, br) : n;
        bb = ((n = db[bb]) === undef) ? bb === auto ? 0 : uu_calc_px(node, bb) : n;
    }
    if (menu & uu.PADDING) {
        // padding: auto -> invalid value -> 0
        pt = ((n = db[pt]) === undef) ? pt === auto ? 0 : uu_calc_px(node, pt) : n;
        pl = ((n = db[pl]) === undef) ? pl === auto ? 0 : uu_calc_px(node, pl) : n;
        pr = ((n = db[pr]) === undef) ? pr === auto ? 0 : uu_calc_px(node, pr) : n;
        pb = ((n = db[pb]) === undef) ? pb === auto ? 0 : uu_calc_px(node, pb) : n;
    }
    return {
        m: { top: mt, left: ml, right: mr, bottom: mb },
        b: { top: bt, left: bl, right: br, bottom: bb },
        p: { top: pt, left: pl, right: pr, bottom: pb }
    };
}

// uu.calc.offset
function uu_calc_offset(node,   // @arg Node: node has parentNode
                        from) { // @arg Node(= null): ancestor node or null
                                //                    null is detect layout-parent node
                                // @ret Hash: { x, y, from }
                                //   x - Number: total offset
                                //   y - Number: total offset
                                //   from - Node: AncestorNode or LayoutParentNode(detected)
                                // @help: uu#uu.calc.offset.from
                                // @desc: calc offset from AncestorNode or LayoutParentNode
                                //        `` 座標計算上の親ノードからのオフセット座標を計算します

    function _offsetFromAncestor(node,   // @arg Node:
                                 from) { // @arg Node:
                                         // @ret Hash: { x, y, from }
        var x = 0, y = 0;

        while (node && node !== from) { // body.offsetParent is null
            x   += node.offsetLeft || 0;
            y   += node.offsetTop  || 0;
            node = node.offsetParent;
        }
        return { x: x, y: y, from: node ? from : document.html };
    }

    function _offsetFromLayoutParent(node) { // @arg Node:
                                             // @ret Hash: { x, y, from }
        var x = 0, y = 0, cs, from;

        while (node) { // body.offsetParent is null
            x   += node.offsetLeft || 0;
            y   += node.offsetTop  || 0;
            node = node.offsetParent;
            if (node) {
                cs = getComputedStyle(node).position;
                if (cs === "relative" || cs === "absolute") {
                    from = node;
                    break;
                }
            }
        }
        return { x: x, y: y, from: from || document.body };
    }

    if (!node || !node.parentNode) {
        return { x: 0, y: 0, from: null };
    }
    if (from) {
        return _offsetFromAncestor(node, from);
    }

    var cs = getComputedStyle(node);

    if (cs.position === "relative" || cs.position === "absolute") {
        if (cs.left !== "auto" && cs.left !== "0px" && // [!GECKO] left: "auto"
            cs.top  !== "auto" && cs.top  !== "0px") { // [GECKO]  left: "0px"
            return { x: parseInt(cs.left),
                     y: parseInt(cs.top),
                     from: node.offsetParent };
        }
    }
    return _offsetFromLayoutParent(node);
}

// uu.calc.boxSize
function uu_calc_boxSize(node) { // @arg Node:
                                 // @ret Hash: { w, h }
//{@assert
    mm.allow(node, "Node");
//}@assert

    var cs = getComputedStyle(node);

    return { w: parseFloat(cs.width), h: parseFloat(cs.height) };
}

// uu.calc.boxRect
function uu_calc_boxRect(node,   // @arg Node: node has parentNode
                         from) { // @arg Node(= null): ancestor node or null
                                 //                    null is detect layout-parent node
                                 // @ret Hash: { x, y, w, h, from }
                                 //   x - Number: total offset
                                 //   y - Number: total offset
                                 //   w - Number: node.style.width (without padding, without border)
                                 //   h - Number: node.style.height (without padding, without border)
                                 //   from - Node: LayoutParentNode(detected)
                                 // @help: uu#uu.calc.boxRect
                                 // @desc: calc offset from AncestorNode or LayoutParentNode
                                 //        `` 座標計算上の親ノードからのオフセット座標と要素の大きさを計算します
    var rv = uu_calc_offset(node, from),
        r  = uu_calc_boxSize(node);

    rv.w = r.w;
    rv.h = r.h;
    return rv;
}

// uu.calc.vboxSize
function uu_calc_vboxSize(node) { // @arg Node:
                                  // @ret Hash: { w, h }
//{@assert
    mm.allow(node, "Node");
//}@assert
    // TODO: display: none の時に最新の各ブラウザが適切な値を返すかしらべる
    //       返さないようなら、 一時的に display: block にして、測定する

    var rect = node.getBoundingClientRect(), w = 0, h = 0;

    w = node.offsetWidth  || (rect.right - rect.left);
    h = node.offsetHeight || (rect.bottom - rect.top);

    return { w: w, h: h };
}

// uu.calc.vboxRect
function uu_calc_vboxRect(node,   // @arg Node: node has parentNode
                          from) { // @arg Node(= null): ancestor node or null
                                  //                    null is detect layout-parent node
                                  // @ret Hash: { x, y, w, h, from }
                                  //   x - Number: total offset
                                  //   y - Number: total offset
                                  //   w - Number: visual width (with padding, with border)
                                  //   h - Number: visual height (with padding, with border)
                                  //   from - Node: AncestorNode or LayoutParentNode(detected)
                                  // @help: uu#uu.calc.offset.from
                                  // @desc: calc offset from AncestorNode or LayoutParentNode
                                  //        `` 座標計算上の親ノードからのオフセット座標と要素の大きさを計算します
    var rv = uu_calc_offset(node, from),
        r  = uu_calc_vboxSize(node);

    rv.w = r.w;
    rv.h = r.h;
    return rv;
}

//
function uu_css_box() {
}

// uu.css.box.attach
function uu_css_box_attach(node) { // @arg Node:
                                   // @ret Hash: {}
                                   // @help: uu#uu.css.box.attach
                                   // @desc: position:absolute/relative -> position:static
    node.style.position = "static";
    return {};
}

// uu.css.box.detach
function uu_css_box_detach(node) { // @arg Node:
                                   // @ret Hash: { x, y, offset, margin }
                                   // @help: uu#uu.css.box.attach
                                   // @desc: position:static/relative -> position:absolute

    var offset = uu_calc_offset(node), // offset from LayoutParent
        margin = uu_calc_edge(node, uu.MARGIN).m,
        ns = node.style,
        x = offset.x - margin.left,
        y = offset.y - margin.top;

    ns.left = x + "px";
    ns.top  = y + "px";
    ns.position = "absolute";
    return { x: x, y: y, offset: offset, margin: margin };
}

_defineLibraryAPIs(mm.mix);

})(this, this.document, this.getComputedStyle);

// --- CSS BOX MODEL ---

// The width                       is node.style.width
// The clientWidth                 is node.style.width + padding.width
// The offsetWidth                 is node.style.width + padding.width + border.width
// The getBoundingClientRect.width is node.style.width + padding.width + border.width
//
//   [CSS2.1 box model] http://www.w3.org/TR/CSS2/box.html
//
//       B-------border--------+ -> border edge [CSS2.1 KEYWORD]
//       |                     |
//       |  P----padding----+  | -> padding edge [CSS2.1 KEYWORD]
//       |  |               |  |
//       |  |  C-content-+  |  | -> content edge [CSS2.1 KEYWORD]
//       |  |  |         |  |  |
//       |  |  |         |  |  |
//       |  |  +---------+  |  |
//       |  |               |  |
//       |  +---------------+  |
//       |                     |
//       +---------------------+
//
//       border  = event.offsetX/Y in WebKit
//                 event.layerX/Y  in Gecko
//       padding = event.offsetX/Y in IE6 ~ IE8
//       content = event.offsetX/Y in Opera

